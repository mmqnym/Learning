# 期末考核

期末考核是一個特殊的章節，本章節將會有許多對資料庫的進階操作提供學生挑戰，這些題目的難度介於中級到超困難，你不必感到壓力也不必擔心不夠熟悉，本次考核是沒有設定通過標準的，也並非強制，你可以盡你所能輕鬆的練習或選擇跳過。

# Question 1:

Difficulty: Moderate

### Question 1.1

In your company there hasn't been a database table with all the employee information yet.

You need to set up the table called employees in the following way:

| emp_id <br/> [PK] `integer` | first_name <br/> `text` | last_name <br/> `text` | job_position <br/> `text` | salary <br/> `numeric(8, 2)` | start_date <br/> `date` | birth_date <br/> `date` | store_id <br/> `integer` | department_id <br/> `integer` | manager_id <br/> `integer` |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

There should be NOT NULL constraints for the following columns:

- `first_name`
- `last_name`
- `job_position`
- `start_date` DATE
- `birth_date` DATE

**HINT**: 參考課程提供的實際存在的表，若為不存在的表代表不是外鍵。

<details>
    <summary>參考答案</summary>

```sql
CREATE TABLE employees(
	emp_id SERIAL PRIMARY KEY,
	first_name TEXT NOT NULL,
	last_name TEXT NOT NULL,
	job_position TEXT NOT NULL,
	salary NUMERIC(8, 2),
	start_date DATE NOT NULL,
	birth_date DATE NOT NULL,
	store_id INT REFERENCES store(store_id),
	department_id INT,
	manager_id INT
);
```
</details>

<br/>

### Question 1.2

Set up an additional table called departments in the following way:

| department_id <br/> [PK] integer | department <br/> text | division <br/> text |
| --- | --- | --- |

Additionally no column should allow nulls.

<details>
    <summary>參考答案</summary>

```sql
CREATE TABLE departments(
	department_id SERIAL PRIMARY KEY,
	department TEXT NOT NULL,
	division TEXT NOT NULL
);
```
</details>

<br/>

# Question 2:

Difficulty: Moderate


Alter the employees table in the following way:

- Set the column department_id to not null.

- Add a default value of CURRENT_DATE to the column start_date.

- Add the column end_date with an appropriate data type (one that you think makes sense).

- Add a constraint called birth_check that doesn't allow birth dates that are in the future.

- Rename the column job_position to position_title.

<details>
    <summary>參考答案</summary>

```sql
ALTER TABLE employees
ALTER COLUMN department_id SET NOT NULL,
ALTER COLUMN start_date SET DEFAULT CURRENT_DATE,
ADD COLUMN end_date DATE,
ADD CONSTRAINT birth_check CHECK(birth_date < CURRENT_DATE);

-- 改名需單獨執行
ALTER TABLE employees
RENAME job_position TO position_title;
```
</details>

<br/>

# Question 3:

### Question 3.1

Insert the following values into the employees table.

There will be most likely an error when you try to insert the values.

So, try to insert the values and then fix the error.

Columns:

```sql
(emp_id,first_name,last_name,position_title,salary,start_date,birth_date,store_id,department_id,manager_id,end_date)
```

Values:

```sql
(1,'Morrie','Conaboy','CTO',21268.94,'2005-04-30','1983-07-10',1,1,NULL,NULL),
(2,'Miller','McQuarter','Head of BI',14614.00,'2019-07-23','1978-11-09',1,1,1,NULL),
(3,'Christalle','McKenny','Head of Sales',12587.00,'1999-02-05','1973-01-09',2,3,1,NULL),
(4,'Sumner','Seares','SQL Analyst',9515.00,'2006-05-31','1976-08-03',2,1,6,NULL),
(5,'Romain','Hacard','BI Consultant',7107.00,'2012-09-24','1984-07-14',1,1,6,NULL),
(6,'Ely','Luscombe','Team Lead Analytics',12564.00,'2002-06-12','1974-08-01',1,1,2,NULL),
(7,'Clywd','Filyashin','Senior SQL Analyst',10510.00,'2010-04-05','1989-07-23',2,1,2,NULL),
(8,'Christopher','Blague','SQL Analyst',9428.00,'2007-09-30','1990-12-07',2,2,6,NULL),
(9,'Roddie','Izen','Software Engineer',4937.00,'2019-03-22','2008-08-30',1,4,6,NULL),
(10,'Ammamaria','Izhak','Customer Support',2355.00,'2005-03-17','1974-07-27',2,5,3,2013-04-14),
(11,'Carlyn','Stripp','Customer Support',3060.00,'2013-09-06','1981-09-05',1,5,3,NULL),
(12,'Reuben','McRorie','Software Engineer',7119.00,'1995-12-31','1958-08-15',1,5,6,NULL),
(13,'Gates','Raison','Marketing Specialist',3910.00,'2013-07-18','1986-06-24',1,3,3,NULL),
(14,'Jordanna','Raitt','Marketing Specialist',5844.00,'2011-10-23','1993-03-16',2,3,3,NULL),
(15,'Guendolen','Motton','BI Consultant',8330.00,'2011-01-10','1980-10-22',2,3,6,NULL),
(16,'Doria','Turbat','Senior SQL Analyst',9278.00,'2010-08-15','1983-01-11',1,1,6,NULL),
(17,'Cort','Bewlie','Project Manager',5463.00,'2013-05-26','1986-10-05',1,5,3,NULL),
(18,'Margarita','Eaden','SQL Analyst',5977.00,'2014-09-24','1978-10-08',2,1,6,2020-03-16),
(19,'Hetty','Kingaby','SQL Analyst',7541.00,'2009-08-17','1999-04-25',1,2,6,'NULL'),
(20,'Lief','Robardley','SQL Analyst',8981.00,'2002-10-23','1971-01-25',2,3,6,2016-07-01),
(21,'Zaneta','Carlozzi','Working Student',1525.00,'2006-08-29','1995-04-16',1,3,6,2012-02-19),
(22,'Giana','Matz','Working Student',1036.00,'2016-03-18','1987-09-25',1,3,6,NULL),
(23,'Hamil','Evershed','Web Developper',3088.00,'2022-02-03','2012-03-30',1,4,2,NULL),
(24,'Lowe','Diamant','Web Developper',6418.00,'2018-12-31','2002-09-07',1,4,2,NULL),
(25,'Jack','Franklin','SQL Analyst',6771.00,'2013-05-18','2005-10-04',1,2,2,NULL),
(26,'Jessica','Brown','SQL Analyst',8566.00,'2003-10-23','1965-01-29',1,1,2,NULL)
```

<details>
    <summary>參考答案</summary>

```sql
-- 注意提供的插入資料，可以發現 end_date 的日期值都沒有使用引號包住，
-- 同時也存在 'NULL'，這是不對的，日期型別的欄位只能存日期值或是 NULL。

INSERT INTO employees
(emp_id,first_name,last_name,position_title,salary,start_date,birth_date,store_id,department_id,manager_id,end_date)
VALUES
(1,'Morrie','Conaboy','CTO',21268.94,'2005-04-30','1983-07-10',1,1,NULL,NULL),
(2,'Miller','McQuarter','Head of BI',14614.00,'2019-07-23','1978-11-09',1,1,1,NULL),
(3,'Christalle','McKenny','Head of Sales',12587.00,'1999-02-05','1973-01-09',2,3,1,NULL),
(4,'Sumner','Seares','SQL Analyst',9515.00,'2006-05-31','1976-08-03',2,1,6,NULL),
(5,'Romain','Hacard','BI Consultant',7107.00,'2012-09-24','1984-07-14',1,1,6,NULL),
(6,'Ely','Luscombe','Team Lead Analytics',12564.00,'2002-06-12','1974-08-01',1,1,2,NULL),
(7,'Clywd','Filyashin','Senior SQL Analyst',10510.00,'2010-04-05','1989-07-23',2,1,2,NULL),
(8,'Christopher','Blague','SQL Analyst',9428.00,'2007-09-30','1990-12-07',2,2,6,NULL),
(9,'Roddie','Izen','Software Engineer',4937.00,'2019-03-22','2008-08-30',1,4,6,NULL),
(10,'Ammamaria','Izhak','Customer Support',2355.00,'2005-03-17','1974-07-27',2,5,3,'2013-04-14'),
(11,'Carlyn','Stripp','Customer Support',3060.00,'2013-09-06','1981-09-05',1,5,3,NULL),
(12,'Reuben','McRorie','Software Engineer',7119.00,'1995-12-31','1958-08-15',1,5,6,NULL),
(13,'Gates','Raison','Marketing Specialist',3910.00,'2013-07-18','1986-06-24',1,3,3,NULL),
(14,'Jordanna','Raitt','Marketing Specialist',5844.00,'2011-10-23','1993-03-16',2,3,3,NULL),
(15,'Guendolen','Motton','BI Consultant',8330.00,'2011-01-10','1980-10-22',2,3,6,NULL),
(16,'Doria','Turbat','Senior SQL Analyst',9278.00,'2010-08-15','1983-01-11',1,1,6,NULL),
(17,'Cort','Bewlie','Project Manager',5463.00,'2013-05-26','1986-10-05',1,5,3,NULL),
(18,'Margarita','Eaden','SQL Analyst',5977.00,'2014-09-24','1978-10-08',2,1,6,'2020-03-16'),
(19,'Hetty','Kingaby','SQL Analyst',7541.00,'2009-08-17','1999-04-25',1,2,6,NULL),
(20,'Lief','Robardley','SQL Analyst',8981.00,'2002-10-23','1971-01-25',2,3,6,'2016-07-01'),
(21,'Zaneta','Carlozzi','Working Student',1525.00,'2006-08-29','1995-04-16',1,3,6,'2012-02-19'),
(22,'Giana','Matz','Working Student',1036.00,'2016-03-18','1987-09-25',1,3,6,NULL),
(23,'Hamil','Evershed','Web Developper',3088.00,'2022-02-03','2012-03-30',1,4,2,NULL),
(24,'Lowe','Diamant','Web Developper',6418.00,'2018-12-31','2002-09-07',1,4,2,NULL),
(25,'Jack','Franklin','SQL Analyst',6771.00,'2013-05-18','2005-10-04',1,2,2,NULL),
(26,'Jessica','Brown','SQL Analyst',8566.00,'2003-10-23','1965-01-29',1,1,2,NULL);
```
</details>

<br/>

### Question 3.2

Insert the following values into the departments table.

| department_id <br/> [PK] integer | department <br/> text | division <br/> text |
| --- | --- | --- |
| 1 | Analytics | IT |
| 2 | Finance | Administration |
| 3 | Sales | Sales |
| 4 | Website | IT |
| 5 | Back Office | Administration |

<details>
    <summary>參考答案</summary>

```sql
INSERT INTO departments
VALUES
(1,'Analytics','IT'),
(2,'Finance','Administration'),
(3,'Sales','Sales'),
(4,'Website','IT'),
(5,'Back Office','Administration');
```
</details>

<br/>

# Question 4:

Difficulty: Moderate

### Question 4.1

Jack Franklin gets promoted to 'Senior SQL Analyst' and the salary raises to 7200.

Update the values accordingly.

<details>
    <summary>參考答案</summary>

```sql
UPDATE 
	employees
SET salary = 7200
WHERE 
	first_name = 'Jack'
	AND
	last_name = 'Franklin';
```
</details>

<br/>

### Question 4.2

The responsible people decided to rename the position_title Customer Support to Customer Specialist.

Update the values accordingly.

<details>
    <summary>參考答案</summary>

```sql
UPDATE 
	employees
SET position_title = 'Customer Specialist'
WHERE 
	position_title = 'Customer Support';
```
</details>

<br/>

### Question 4.3

All SQL Analysts including Senior SQL Analysts get a raise of 6%.

Upate the salaries accordingly.

<details>
    <summary>參考答案</summary>

```sql
UPDATE 
	employees
SET salary = salary * 1.06
WHERE 
	position_title LIKE '%SQL Analyst';
```
</details>

<br/>

### Question 4.4:

What is the average salary of a SQL Analyst in the company (excluding Senior SQL Analyst)? Write a query to get the answer.

<details>
    <summary>參考答案</summary>

```sql
SELECT 
	AVG(salary)
FROM employees
WHERE 
	position_title = 'SQL Analyst';
```
</details>

<br/>

# Question 5

Difficulty: Advanced

### Question 5.1

Write a query that adds a column called manager that contains  first_name and last_name (in one column) in the data output.

Secondly, add a column called is_active with 'false' if the employee has left the company already, otherwise the value is 'true'.

<details>
    <summary>參考答案</summary>

```sql
SELECT 
	e1.*,
	e2.first_name || ' ' || e2.last_name AS manager,
	CASE
		WHEN e1.end_date is null THEN 'true'
		ELSE 'false'
	END AS is_active
FROM employees AS e1
INNER JOIN employees AS e2
ON e1.manager_id = e2.emp_id;
```
</details>

<br/>

### Question 5.2

Create a view called v_employees_info from that previous query.

<details>
    <summary>參考答案</summary>

```sql
CREATE VIEW v_employees_info
AS (
	SELECT 
		e1.*,
		e2.first_name || ' ' || e2.last_name AS manager,
		CASE
			WHEN e1.end_date is null THEN 'true'
			ELSE 'false'
		END AS is_active
	FROM employees AS e1
	INNER JOIN employees AS e2
	ON e1.manager_id = e2.emp_id
);
```
</details>

<br/>

# Question 6

Difficulty: Moderate

Write a query that returns the average salaries for each positions with appropriate roundings.

Question:

What is the average salary for a Software Engineer in the company.

Answer:

6028.00（答案有可能不同）

<details>
	<summary>參考答案</summary>

```sql
SELECT
	position_title,
	ROUND(AVG(salary), 2) AS avg_salary
FROM employees
GROUP BY position_title
HAVING position_title = 'Software Engineer';
```
</details>

<br/>

# Question 7

Difficulty: Moderate

Write a query that returns the average salaries per division.

Question:

What is the average salary in the Sales department?

Answer:

6107.41（答案有可能不同）

<details>
	<summary>參考答案</summary>

```sql
SELECT
	division,
	ROUND(AVG(salary), 2) AS avg_salary
FROM employees AS e
INNER JOIN departments AS d
ON e.department_id = d.department_id
GROUP BY division;
```
</details>

<br/>

# Question 8

Difficulty: Advanced

### Question 8.1

Write a query that returns the following:

- `emp_id`
- `first_name`
- `last_name`
- `position_title`
- `salary`

and a column that returns the average salary (as `avg_position_salary`) for every `position_title`.

Order the results by the `emp_id`.

<details>
	<summary>參考答案</summary>

```sql
SELECT
	emp_id,
	first_name,
	last_name,
	position_title,
	salary,
	ROUND(
		AVG(salary) OVER(PARTITION BY position_title),
		2
	) AS avg_position_salary
FROM employees
ORDER BY emp_id;
```
</details>

<br/>

### Question 8.2

Difficulty: Advanced to Pro

How many people earn less than there `avg_position_salary`?

Write a query that answers that question.

Ideally, the output just shows that number directly.


Answer:

9（答案有可能不同）

<details>
	<summary>參考答案</summary>

```sql
SELECT
	COUNT(*)
FROM (
	SELECT
		emp_id,
		first_name,
		last_name,
		position_title,
		salary,
		ROUND(
			AVG(salary) OVER(PARTITION BY position_title),
			2
		) AS avg_position_salary
	FROM employees
	ORDER BY emp_id
) AS subquery
WHERE salary < avg_position_salary;
```
</details>

<br/>

--- 後續待補充