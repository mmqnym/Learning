# Managing tables

本章節主要關注:

Database, Table, Schemas 的 Create, Alter, Drop 以及 資料類型 還有 Table 的 Insert, Update, Delete

在關聯式資料庫管理系統（RDBMS，Relational Database Management System）中，

資料的組織方式遵循明確的層級結構，以確保高效管理、權限控管以及查詢性能的優化。

這種層級化設計讓開發者能夠清楚地區分不同層次的數據，從最上層的 資料庫（Database）到中間的 Schema（綱要），再到最底層的 資料表（Table）。

## Database

Database 是整個資料存儲體系的「最高層級」，它負責管理所有的 Schema、Table、索引（Indexes）、儲存空間 以及 存取權限。

可以把 Database 想像成一個大型的「檔案夾」，裡面存放了許多 Schema，而 Schema 內又包含了各種 Table，用來儲存實際的業務數據。

在實務應用中，一個 Database 通常對應一個業務應用系統。

## Schema

Schema 是 Database 內的邏輯分區（Logical Partition），負責 組織與隔離數據，讓數據管理更加有條理。

在一些支援 Schema 的資料庫系統（如 PostgreSQL、SQL Server）中，每個 Schema 相當於一個獨立的命名空間（Namespace），它可以包含多張 Table、索引、視圖（Views）等物件。

這讓我們能夠有效地將數據進行分類管理，例如：

在多租戶架構（Multi-Tenant Architecture）下，每個租戶的數據可以存放在獨立的 Schema 內，例如 companyA、companyB。

在大型企業系統中，可以透過 Schema 區分不同業務領域的數據，例如 HR（人資）、Sales（銷售）、Finance（財務）。

**NOTE**: 對一般企業而言，大多使用預設 Schema 就足夠了，所以本篇不會有過多的介紹。

## Table

Table（資料表） 是 存放具體數據的最小單位，所有的業務數據最終都會儲存在 Table 內。

Table 由 欄位（Columns） 和 記錄（Rows） 組成，每個欄位定義了一個屬性，而每一筆記錄則是具體的數據。

在一個企業的 Schema 內，可能包含多張不同的 Table，例如：

- employees（員工表）：存放員工的基本資訊（如姓名、職稱、薪資）。
- payroll（薪資表）：記錄員工的薪資發放情況。
- attendance（考勤表）：記錄員工的打卡與出勤狀況。

# Creating & Dropping database

建立 database 非常簡單，因為複雜的屬性定義會在 Table 上進行。

- 用法:

```sql
CREATE DATABASE <database_name>;
```

- 練習:

```sql
CREATE DATABASE my_database
-- 指定編碼為 ASCII，不指定編碼則預設為 UTF-8
WITH ENCODING = 'ASCII';

-- 雖說可以使用 "" 來包裹資料庫名稱，以建立包含空格或大寫的資料庫名稱，但不建議使用，因為這不是一個典型操作
-- 不使用雙引號進行如下的操作，在 SQL 中是會報錯的
CREATE DATABASE "My Database";

-- 建議一律以小寫字母來命名資料庫，若有多個單字組合，則以 _ 連接
CREATE DATABASE my_new_database;

-- 可以使用以下指令對資料庫加上備註
COMMENT ON DATABASE my_new_database IS '這是一個新的資料庫';
```

以下是如何刪除資料庫的指令介紹

- 用法:

```sql
DROP DATABASE <database_name>;
```

- **挑戰 1**:

Create a database called "customer" and then drop that same database again.

Write both commands together in the solution.

Use ";" to declare the end of the commands.

<details>
    <summary>參考答案</summary>

```sql
CREATE DATABASE customer;
DROP DATABASE customer;
```
</details>

<br/>

# 常見資料類型

資料類型決定了資料的儲存方式和操作方式，常用的資料類型包括:

- Numeric（數值）：整數和浮點數
- Strings（字串）：用來儲存文字資料
- Date/Time（時間類型）：用來儲存日期、時間資料
- Other

## Numeric

| 資料類型 | 大小 | 表示範圍 | 備註 |
| --- | --- | --- | --- |
| INT | 4 byte | -2147483648 to 2147483647 | 典型選擇 |
| SMALLINT | 2 byte | -32768 to 32767 | 小整數 |
| BIGINT | 8 byte | -2^63 to 2^63 - 1 | 長整數 |
| DECIMAL | variable | up to 131072 digits before the decimal point; <br/> up to 16383 digits after the decimal point | 用戶定義精度 |
| SERIAL | variable | 1 to 2147483647 | 自動遞增 1 <br/> 通常用於主鍵、ID |

## Strings

| 資料類型 | 大小 | 範例 | 備註 |
| --- | --- | --- | --- |
| CHAR(n) | 固定長度，不足字元補空白 | 'Hello' | 查詢速度最快，因為資料長度固定，處理效率高 |
| VARCHAR(n) | 帶長度限制的可變長度 | 'M' or 'F' | 查詢速度次於CHAR，但比TEXT快 |
| TEXT | 不帶長度限制的可變長度 | 'Hello' | 查詢速度最慢，不適合用於頻繁查詢或需要快速存取的欄位。適用於長度極不確定或非常長的文字，如文章內容。 |

## Date/Time

| 資料類型 | 描述 | 範例 |
| --- | --- | --- |
| DATE | 沒有時間的日期 | '2020-01-01' |
| TIME (with/without time zone) | 沒有日期的時間 | '01:01:01.123' |
| TIMESTAMP (with/without time zone) | 日期以及時間 | '2020-01-01 01:01:01.123+08' |
| INTERVAL | 時間間隔 | '1 year 2 months 3 days 01:02:03.456' |

## Other

| 資料類型 | 描述 | 範例 | 範圍 |
| --- | --- | --- | --- |
| BOOLEAN | 布林值（SQL 中的布林值還包含 NULL，以表示未知或沒有值） | is_in_stock | TRUE, FALSE, NULL |
| ENUM | 一個存有序值的清單 | movie_rating | 用戶定義 |
| ARRAY | 一個存多值的清單 | text[] or int[] | 根據資料型別 |

<br/>

- **挑戰 1**:

You want to create a payment table. The payment amount range from 0 to 9999.99.

Which data type would be the best choice?

- A. numeric(4, 2)
- B. numeric(5, 2)
- C. decimal(6, 2)

<details>
    <summary>參考答案</summary>
C. decimal(6, 2)

前者表示總共佔據多少個 digits(精度)，最大值為 9999.99，因此共需要 6 個 digits。後者表示總共佔據多少個小數點後位數（比例），.99 佔據了 2 個 digit，因此設為 2。

</details>

<br/>

- **挑戰 2**:

Examples for the values in your transaction amount column are:

22.9334 or 353.3145.

The values range up to 1000 and we need only 4 decimal places.

What would be an appropiate scale of your numeric data type?

- A. 7
- B. 6
- C. 5
- D. 4

<details>
    <summary>參考答案</summary>
D. 4

此題其實就是在詢問要設定多少位數的小數點後位數，由兩個範例值可以得知小數點後位數皆為 4，可以推斷該 column 最多只存到小數點後 4 位，因此設為 4 就可以了。

</details>

<br/>

- **挑戰 3**:

What data type would you choose if you want to go with the one that has the smalles space to save a positive number that will be at most 100 and accept decimal accuracy of 0.1.

- A. numeric(1, 3)
- B. numeric(1, 4)
- C. numeric(4, 1)
- D. numeric(3, 1)

<details>
    <summary>參考答案</summary>
D. numeric(3, 1)

此題表示要存儲正數，最大值為 100，小數最多存 1 位數，可以推斷共佔據 4 個 digits，小數設為 1 位數字。

</details>

<br/>

- **挑戰 4**:

How should you store country codes like 49 for Germany, 91 for India or 1 for United States?

- A. A string data type like varchar(5)
- B. SMALLINT
- C. INT

<details>
    <summary>參考答案</summary>
A. A string data type like varchar(5)

此題考驗學生是否能正確選擇資料類型，雖然設為數值類型可能也能適用，但國家代碼本身並沒有數字上的意義，例如按照國家名稱編碼等等，因此應該設為字串類型，以減少儲存空間的浪費與提升查詢上的效率。

</details>

<br/>

- **挑戰 5**:

How many movies contain the special feature of 'Behind the Scenes'?

- A. 345
- B. 538
- C. 632
- D. 459

**HINT**: 使用 ANY()

<details>
    <summary>參考答案</summary>
B. 538

```sql
SELECT 
	COUNT(*)
FROM 
	film
WHERE 'Behind the Scenes' = ANY(special_features);
```

</details>

<br/>

# Constraints

當創建表時，我們需要定義行名、行資料類型，也可以定義 Constraints。

何謂 Constraints?

Constraints 是資料存入資料表的規則，主要用於防止無效資料被存入，其可以定義於表或行上。

## 常見的行 Constraints

| 限制 | 說明 |
| --- | --- |
| NOT NULL | 表示此欄位不可被寫入空值 |
| UNIQUE | 表示此欄位的值不可重複 |
| DEFAULT | 當沒有寫入此欄位值時，會設定此欄位的值為一預設值 |
| PRIMARY KEY | 表示此欄位為主鍵（結合了 NOT NULL 和 UNIQUE），表示此值在整個表的唯一性 |
| REFERENCES | 表示此欄位為外鍵，表示此欄位的值必須來自另一個表的主鍵，以確保兩個表之間的關聯完整性，不會出現不匹配的情況 |
| CHECK | 表示此欄位的值必須符合特定的條件才能寫入，例如值需介於 0 到 100 之間 |

## 常見的表 Constraints

| 限制 | 說明 |
| --- | --- |
| PRIMARY KEY (column1 [, ...]) | 直接設定表的某個或多個欄位為主鍵 |
| UNIQUE (column1 [, ...]) | 直接設定表的某個或多個欄位的值不可重複 |
| CHECK (search_condition) | 直接於表層級設定條件 |

<br/>

- **挑戰 1**:

What constraint should be used when setting up a default value for a column?

- A. SET 0
- B. ALLWAYS 0
- C. DEFAULT 0
- D. REFERENCES 0

<details>
    <summary>參考答案</summary>
C. DEFAULT 0

設定預設值要使用 DEFAULT 限制。

</details>

<br/>

- **挑戰 2**:

What constraint should be used to not allow duplicates in column?

- A. DISTINCT
- B. NOT NULL
- C. UNIQUE
- D. NO DUPLICATES

<details>
    <summary>參考答案</summary>
C. UNIQUE

設定唯一值要使用 UNIQUE 限制。

</details>

<br/>

# PRIMARY KEY & FOREIGN KEY

主鍵由一個或多個行組成，用於識別表的每個唯一列（row）。

外鍵用於讓表與另一個表之間建立關聯，以確保兩個表之間的關聯完整性，不會出現不匹配的情況，被引用的表稱為子表，引用子表的稱為父表。

**NOTE**: 外鍵是用於參考其他表的依據，因此不必唯一，一張表也可以包含多個外鍵。

<br/>

- **挑戰 1**:

A primary implies which two other constraints?

- A. SERIAL and NOT NULL
- B. NOT NULL and REFERENCES
- C. NOT NULL and UNIQUE
- D. REFERENCES and SERIAL

<details>
    <summary>參考答案</summary>
C. NOT NULL and UNIQUE

主鍵不得為空值且必須唯一。
</details>

<br/>

- **挑戰 2**:

What violates a foreign key (REFERENCES) constraint?

- A. Values are not unique
- B. Values are not occurring in the referenced column
- C. Values are not integers

<details>
    <summary>參考答案</summary>
B. Values are not occurring in the referenced column

外鍵值必須參考其他表中實際存在的值，以確保關聯完整性。
</details>

<br/>

# CREATE TABLE

- 用法:

```sql
CREATE TABLE <table_name> (
    <column_name> <column_type> [CONSTRAINT <constraint_name>],
    ...
);
```

- 範例:

```sql
CREATE TABLE staff(
    staff_id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    -- 也可以在表的層級上定義
    -- 代表合併後的資料（name, staff_id）必須是唯一值
    -- 例如 ('tim', 1), ('tim', 2) 是可以的
    -- 但 ('tim', 1), ('tim', 1) 不可以
    UNIQUE(name, staff_id),
);
```

- 練習:

讓我們利用我們的資料庫實際進入一個練習:

```sql
CREATE TABLE director(
    director_id SERIAL PRIMARY KEY,
    director_account_name VARCHAR(20) UNIQUE,
    first_name VARCHAR(50),
    last_name VARCHAR(50) DEFAULT 'Not specified',
    date_of_birth DATE,
    -- 關聯地址表
    address_id INT REFERENCES address(address_id)
);
```

- **挑戰 1**:

Create a table called online_sales with the following columns:

- transaction_id
- customer_id
- film_id
- amount
- promotion_code

Transaction_id shoul be the primary key.
The columns customer_id and film_id should be foreign keys to the relevant tables.
The amount column can contain values from 0.00 to 999.99 - nulls should not be allowed.
The column promotion_code contains a promotion code of at maximum 10 characters. If there is no value you should set the default value 'None'.

Create that table and choose appropriate data types and constraints!

此挑戰的問題
What data type you think is appropriate for the transaction_id column?

<details>
    <summary>參考答案</summary>

```sql
-- 本題沒有正確解答，但通常 id 會選擇 SERIAL，因為其自行保證為唯一值
-- 通常實際業務上會考量的事情更多，像是要確保值無法被預測，因此有很多選擇，例如 UUID 等

CREATE TABLE online_sales(
	transaction_id SERIAL PRIMARY KEY,
	customer_id INT REFERENCES customer(customer_id),
	film_id INT REFERENCES film(film_id),
	amount NUMERIC(5, 2) NOT NULL,
	promotion_code VARCHAR(10) DEFAULT 'None'
);
```
</details>

<br/>

# INSERT

現在我們已經透過上面的 **挑戰 1** 自行建立了一個表，是時候來學習如何填入數據了！

- 用法:

```sql
INSERT INTO <table_name> VALUES (<value>, [, ...]);
-- value 必須按表定義順序提供對應值，並且需滿足表與行的限制
```

- 練習:

```sql
INSERT INTO online_sales
VALUES(1, 269, 13, 10.99, 'BUNDLE2022');

-- 有時我們可能只想插入部分資料
-- 這時我們可以選擇要插入哪些欄位
INSERT INTO online_sales(customer_id, film_id, amount)
VALUES(269, 13, 10.99);

-- 我們也可以一次插入多筆資料
INSERT INTO online_sales(customer_id, film_id, amount)
VALUES
    (269, 13, 10.99),
    (270, 12, 22.99);
```

- **挑戰 1**:

Insert these values in the table online_sales:

| transaction_id | customer_id | film_id | amount | promotion_code |
|----------------|-------------|---------|--------|----------------|
| 1              | 124         | 65      | 14.99  | PROMO2022       |
| 2              | 225         | 231     | 12.99  | JULYPROMO       |
| 3              | 119         | 53      | 15.99  | SUMMERDEAL      |

Why doesn't it work to insert 'SUMMERDEAL2022' in the column promotion_code?

<details>
    <summary>參考答案</summary>

```sql
INSERT INTO online_sales(customer_id, film_id, amount, promotion_code)
VALUES (124, 65, 14.99, 'PROMO2022'),
        (225, 231, 12.99, 'JULYPROMO'),
        (119, 53, 15.99, 'SUMMERDEAL');
```

嘗試插入 'SUMMERDEAL2022' 這個值時會發生錯誤，因為 promotion_code 的資料型別為 VARCHAR(10)，而 'SUMMERDEAL2022' 的長度為 16，長度大於 10，因此無法插入。
</details>

<br/>

# ALTER TABLE

我們在定義完表後，仍然可以對其做以下操作:

ADD, DELETE column
ADD, DROP constraint
RENAME column
ALTER DATA TYPEs

- 用法:

```sql
ALTER TABLE <table_name>
ALTER_ACTION;

-- ex: DROP COLUMN <column_name>
-- 確保不會出現錯誤 ex: DROP COLUMN IF EXISTS <column_name>
```

- 練習:

```sql
-- 刪除一行
ALTER TABLE staff
DROP COLUMN first_name;

-- 為 staff 表新增一個名為 date_of_birth 的欄位
ALTER TABLE staff
ADD COLUMN date_of_birth DATE;

-- 確保不會出現錯誤
ALTER TABLE staff
ADD COLUMN IF NOT EXISTS date_of_birth DATE;

-- 修改 staff 表的 address_id 欄位的資料型別
ALTER TABLE staff
ALTER COLUMN address_id SMALLINT;

-- 重新命名 staff 表的 first_name 欄位為 name
ALTER TABLE staff
RENAME COLUMN first_name TO name;

-- 重新命名表
ALTER TABLE staff
RENAME TO employees;

-- 重新命名需單獨操作

-- 新增限制
ALTER TABLE staff
ALTER COLUMN store_id SET DEFAULT 1;

-- 移除限制
ALTER TABLE staff
ALTER COLUMN store_id DROP DEFAULT;
```

- **挑戰 1**:

使用先前建立的 directors 表，進行本次挑戰。

1. 將 director_account_name 欄位資料類型改為 VARCHAR(30)。
2. 移除 last_name 欄位的 DEFAULT 限制。
3. 新增限制 NOT NULL 於 last_name 欄位。
4. 新增行 email 欄位，資料類型為 VARCHAR(40)。
5. 將 director_account_name 欄位更名為 account_name。
6. 將 director 表更名為 directors。

<details>
    <summary>參考答案</summary>
    
```sql
ALTER TABLE director
ALTER COLUMN director_account_name TYPE VARCHAR(30),
ALTER COLUMN last_name DROP DEFAULT,
ALTER COLUMN last_name SET NOT NULL,
ADD COLUMN email VARCHAR(40);

ALTER TABLE director
RENAME COLUMN director_account_name TO account_name;

ALTER TABLE director
RENAME TO directors;
```
</details>

<br/>

# TRUNCATE & DROP TABLE

DROP 用於刪除資料庫物件

- 用法:

```sql
DROP TABLE <table_name>;
DROP SCHEMA <schema_name>;
```

TRUNCATE 用於保留表結構，清空表內容

- 用法:

```sql
TRUNCATE TABLE <table_name>;

-- 也可以使用
TRUNCATE <table_name>;
-- 因為 TRUNCATE 僅對表有效
```

# CHECK

CHECK 用於設定行條件，通常用於限制值的範圍。

- 練習:

```sql
CREATE TABLE director (
    name TEXT CHECK (length(name) > 1)
);

-- 也可以替這個限制取名
-- 若不取名則會自動命名為 <table_name>_<column_name>_check
CREATE TABLE director (
    name TEXT CONSTRAINT name_length CHECK (length(name) > 1)
);
```

- **挑戰 1**:

Create a table called songs with the following columns:

| song_id | song_name | genre | price | release_date |
| --- | --- | --- | --- | --- |
| INT | VARCHAR(30) | VARCHAR(30) | NUMERIC(4, 2) | DATE |

1. During creation add the DEFAULT 'Not defined' to the genre.
2. Add the not null constraint to the song_name column.
3. Add the constraint with default name to ensure the price is at least 1.99.
4. Add the constraint date_check to ensure the release date is between today and 01-01-1950.
5. Try to insert a row like this:

    | song_id | song_name | genre | price | release_date |
    | --- | --- | --- | --- | --- |
    | 4 | SQL song | Not defined | 0.99 | 2022-01-07 |
6. Modify the constraint to be able to have 0.99 allowed as the lowest possible price.
7. Try again to insert the row above.

<details>
    <summary>參考答案</summary>
    
```sql
-- 滿足 1~4 的要求
CREATE TABLE songs(
	song_id SERIAL PRIMARY KEY,
	song_name VARCHAR(30) NOT NULL,
	gerne VARCHAR(30) DEFAULT 'Not defined',
	price NUMERIC(4, 2) CHECK (price >= 1.99),
	release_date DATE CONSTRAINT date_check CHECK 
        (release_date BETWEEN '01-01-1950' AND CURRENT_DATE)
);

-- 嘗試插入：
INSERT INTO songs
VALUES (4, 'SQL song', 'Not defined', 0.99, '2022-01-07')

-- 會得到：
-- ERROR:  new row for relation "songs" violates check constraint "songs_price_check"

-- 修改表對 price 的限制
ALTER TABLE songs
DROP Constraint songs_price_check;

ALTER TABLE songs
ADD CHECK (price >= 0.99);

-- 再試一次插入
INSERT INTO songs
VALUES (4, 'SQL song', 'Not defined', 0.99, '2022-01-07');

-- 成功插入
```
</details>

# 額外參考來源

[資料庫層級結構](https://realnewbie.com/basic-concent/database/database-hierarchy-relationship-and-application-of-database-schema-table/) By 徐培鈞