# 用戶自訂函數

SQL 支援用戶以程式語言或 SQL 語言來定義自訂函數，方便使用者在 SQL 中使用自訂函數來進行複雜的計算和處理。

**NOTE**: 通常使用查詢語言來在 SQL 中定義用戶自訂函數，因為操作資料庫使用程式語言可能會有邏輯錯誤，並不安全。

- 用法:

```sql
CREATE FUNCTION <function_name> ([<parameters> <data_type>, ...])
RETURNS <return_type>
LANGUAGE <language> -- plpgsql [sql|c|python|...]
AS
$$
DECLARE
<variables>;
BEGIN
<statements>;
END;
$$
```

- 練習:

```sql
-- 此函數功能為將兩個整數相加後再加上 3
-- 寫法類似組合語言
-- 將查詢語句的結果儲存在變數中後返回
-- 這邊僅提供簡單的範例
-- 更多關於用戶自訂函數的教學建議自行於網上搜尋
CREATE FUNCTION first_funct (c1 INT, c2 INT)
RETURNS INT
LANGUAGE plpgsql
AS
$$
DECLARE
    c3 INT;
BEGIN
    SELECT c1 + c2 + 3
    INTO c3;
    RETURN c3;
END;
$$

-- 建立一個查詢電影 rantal_rate 介於兩個數字之間有多少電影數量的函數
CREATE FUNCTION count_rr (min_rental_rate INT, max_rental_rate INT)
RETURNS INT
LANGUAGE plpgsql
AS
$$
DECLARE
    total INT;
BEGIN
    SELECT
        COUNT(*)
    INTO total
    FROM
        rental
    WHERE
        rental_rate BETWEEN min_rental_rate AND max_rental_rate
    RETURN total;
END;
$$

-- 使用:
SELECT count_rr(2, 4);
```

- **挑戰 1**:

Create a function that expects the customer's first and last name and returns the total amount of payments this customer has made.

Example:

```sql
SELECT name_search('AMY', 'LOPEZ');
```

Output:

| name_search <br/> numeric |
|-------------|
| 127.71 |

<details>
    <summary>參考答案</summary>

我們可以先建立一個普通的查詢來確定函數該怎麼寫

```sql
SELECT
	SUM(amount)
FROM payment AS p
INNER JOIN customer AS c
ON p.customer_id = c.customer_id
WHERE
	first_name = 'AMY'
	AND
	last_name = 'LOPEZ'
GROUP BY first_name, last_name;
```

這樣就能很容易改寫成建立函數的查詢語句

```sql
CREATE FUNCTION name_search(arg_first_name TEXT, arg_last_name TEXT)
RETURNS NUMERIC
LANGUAGE plpgsql
AS
$$
DECLARE
	total NUMERIC;
BEGIN
	SELECT
		SUM(amount)
	INTO total
	FROM payment AS p
	INNER JOIN customer AS c
	ON p.customer_id = c.customer_id
	WHERE
		first_name = arg_first_name
		AND
		last_name = arg_last_name
	GROUP BY first_name, last_name;
	RETURN total;
END;
$$
```

</details>

<br/>

# Transactions（事務）

Transactions 是工作的最小單位，可以包含一個至多個操作，用來確保操作的完整性和一致性，當有一個操作發生錯誤時，會進入 **aborted state**，此時需執行 **ROLLBACK** 來回復到操作前（BEGIN 之前）的狀態，直接提交會得到錯誤，無法提交也無法再執行新查詢，直到用戶明確地執行 **ROLLBACK**。

Transactions 通常用於要對多個表進行修改，並且需要確保所有操作都成功完成，以避免資料不一致的情況。例如：轉帳

- 用法:

```sql
-- or BEGIN TRANSACTION;, BEGIN WORK;
-- 大多使用 BEGIN;
BEGIN;
<statements>;
COMMIT; -- 在尚未 COMMIT 之前，操作結果僅發生於當前會話，不會於資料庫真實生效
```

- 練習:

```sql
-- 建立測試用表
CREATE TABLE acc_balance(
    id SERIAL PRIMARY KEY,
    first_name TEXT NOT NULL,
    last_name TEXT NOT NULL,
    amount DEC(9, 2) NOT NULL
);

INSERT INTO acc_balance
VALUES
(1, 'Tim', 'Brown', 2500),
(2, 'Sandra', 'Miller', 1600),

-- 模擬交易
BEGIN;
UPDATE acc_balance
SET amount = amount + 100
WHERE id = 1;

UPDATE acc_balance
SET amount = amount - 100
WHERE id = 2;

COMMIT;
```

- **挑戰 1**:

The two employees `Miller McQuarter` and `Christalle McKenny` have agreed to swap their position and their salary.

**NOTE**: 此題沒有要考如何交換兩個人的資料，你可以直接查詢要修改的值。

使用先前期末考核的挑戰中建立的表 `employees` 來完成此挑戰，若你沒有完成此挑戰，可以使用以下的表資源建立：

<details>
    <summary>表資源</summary>

```sql
CREATE TABLE employees (
emp_id SERIAL PRIMARY KEY,
first_name TEXT NOT NULL,
last_name TEXT NOT NULL,
job_position TEXT NOT NULL,
salary decimal(8,2),
start_date DATE NOT NULL,
birth_date DATE NOT NULL,
store_id INT REFERENCES store(store_id),
department_id INT,
manager_id INT
);

ALTER TABLE employees 
ALTER COLUMN department_id SET NOT NULL,
ALTER COLUMN start_date SET DEFAULT CURRENT_DATE,
ADD COLUMN end_date DATE,
ADD CONSTRAINT birth_check CHECK(birth_date < CURRENT_DATE);

ALTER TABLE employees
RENAME job_position TO position_title;

INSERT INTO employees 
VALUES
(1,'Morrie','Conaboy','CTO',21268.94,'2005-04-30','1983-07-10',1,1,NULL,NULL),
(2,'Miller','McQuarter','Head of BI',14614.00,'2019-07-23','1978-11-09',1,1,1,NULL),
(3,'Christalle','McKenny','Head of Sales',12587.00,'1999-02-05','1973-01-09',2,3,1,NULL),
(4,'Sumner','Seares','SQL Analyst',9515.00,'2006-05-31','1976-08-03',2,1,6,NULL),
(5,'Romain','Hacard','BI Consultant',7107.00,'2012-09-24','1984-07-14',1,1,6,NULL),
(6,'Ely','Luscombe','Team Lead Analytics',12564.00,'2002-06-12','1974-08-01',1,1,2,NULL),
(7,'Clywd','Filyashin','Senior SQL Analyst',10510.00,'2010-04-05','1989-07-23',2,1,2,NULL),
(8,'Christopher','Blague','SQL Analyst',9428.00,'2007-09-30','1990-12-07',2,2,6,NULL),
(9,'Roddie','Izen','Software Engineer',4937.00,'2019-03-22','2008-08-30',1,4,6,NULL),
(10,'Ammamaria','Izhak','Customer Support',2355.00,'2005-03-17','1974-07-27',2,5,3,'2013-04-14'),
(11,'Carlyn','Stripp','Customer Support',3060.00,'2013-09-06','1981-09-05',1,5,3,NULL),
(12,'Reuben','McRorie','Software Engineer',7119.00,'1995-12-31','1958-08-15',1,5,6,NULL),
(13,'Gates','Raison','Marketing Specialist',3910.00,'2013-07-18','1986-06-24',1,3,3,NULL),
(14,'Jordanna','Raitt','Marketing Specialist',5844.00,'2011-10-23','1993-03-16',2,3,3,NULL),
(15,'Guendolen','Motton','BI Consultant',8330.00,'2011-01-10','1980-10-22',2,3,6,NULL),
(16,'Doria','Turbat','Senior SQL Analyst',9278.00,'2010-08-15','1983-01-11',1,1,6,NULL),
(17,'Cort','Bewlie','Project Manager',5463.00,'2013-05-26','1986-10-05',1,5,3,NULL),
(18,'Margarita','Eaden','SQL Analyst',5977.00,'2014-09-24','1978-10-08',2,1,6,'2020-03-16'),
(19,'Hetty','Kingaby','SQL Analyst',7541.00,'2009-08-17','1999-04-25',1,2,6,NULL),
(20,'Lief','Robardley','SQL Analyst',8981.00,'2002-10-23','1971-01-25',2,3,6,'2016-07-01'),
(21,'Zaneta','Carlozzi','Working Student',1525.00,'2006-08-29','1995-04-16',1,3,6,'2012-02-19'),
(22,'Giana','Matz','Working Student',1036.00,'2016-03-18','1987-09-25',1,3,6,NULL),
(23,'Hamil','Evershed','Web Developper',3088.00,'2022-02-03','2012-03-30',1,4,2,NULL),
(24,'Lowe','Diamant','Web Developper',6418.00,'2018-12-31','2002-09-07',1,4,2,NULL),
(25,'Jack','Franklin','SQL Analyst',6771.00,'2013-05-18','2005-10-04',1,2,2,NULL),
(26,'Jessica','Brown','SQL Analyst',8566.00,'2003-10-23','1965-01-29',1,1,2,NULL);
```
</details>

<br/>

<details>
    <summary>參考答案</summary>

```sql
BEGIN;

UPDATE employees
SET position_title = 'Head of Sales'
WHERE emp_id = 2;

UPDATE employees
SET salary = 12587.00
WHERE emp_id = 2;

UPDATE employees
SET position_title = 'Head of BI'
WHERE emp_id = 3;

UPDATE employees
SET salary = 14614.00
WHERE emp_id = 3;

COMMIT;
```
</details>

