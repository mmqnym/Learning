# Mathematical functions & operators（數學函數和運算符）

- 常用運算子

若有程式語言基礎，可以看得出來 SQL 中的算數運算子跟大多程式語言相同。

| 運算子 | 說明 | 範例 | 結果 |
| --- | --- | --- | --- |
| `+` | 加法 | `1 + 1` | `2` |
| `-` | 減法 | `1 - 1` | `0` |
| `*` | 乘法 | `3 * 4` | `12` |
| `/` | 除法 | `12 / 5` | `2` |
| `%` | 取餘數 | `12 % 5` | `2` |
| `^` | 次方 | `2 ^ 3` | `8` |

- 常用數學函數

若有程式語言基礎，可以看得出來 SQL 中的數學函數跟大多程式語言相同，特別是 python。

| 函數 | 說明 | 範例 | 結果 |
| --- | --- | --- | --- |
| `abs()` | 取絕對值 | `abs(-1)` | `1` |
| `ceil()` | 向上取整 | `ceil(1.1)` | `2` |
| `floor()` | 向下取整 | `floor(1.1)` | `1` |
| `round()` | 四捨五入 | `round(1.1)` | `1` |
| `power()` | 次方 | `power(2, 3)` | `8` |


**NOTE**: 詳細清單請參考[數學函數](https://postgresql.org/docs/current/functions-math.html)

- 練習

```sql
-- 調整租借費用的例子
SELECT
    film_id,
    rental_rate AS old_rental_rate,
    CEIL(rental_rate * 1.4) - 0.01 AS new_rental_rate
FROM rental;
```

- **挑戰 1 - UDEMY**:

Return the product with the highest total revenue. Return the product name and its total revenue (alias: total_revenue). You need to use mathematical operators to calculate the total revenue for each product (`quantity_sold * price_per_unit`) and aggregate functions to find the sum of revenues for each product.

Table Name: `sales`

Column Names: `product_name`, `quantity_sold`, `price_per_unit`

<details>
    <summary>參考答案</summary>

```sql
SELECT
    product_name,
    SUM(quantity_sold * price_per_unit) AS total_revenue
FROM sales
GROUP BY product_name
ORDER BY total_revenue DESC
LIMIT 1;
```
</details>

<br/>

- **挑戰 2**:

你的經理想要提高電影（`film`）重置成本（`replacement cost`）較高的電影租金價格，為此你需要建立一個電影清單，包含租借率（`rental rate`）／重置成本的比率，其中租借率／重置成本 < `4%`。

另外你需要將結果包含 `film_id`，並將租借率／重置成本的比率四捨五入到小數第 `2` 位。

<details>
    <summary>參考答案</summary>

```sql
SELECT
    film_id,
    ROUND(rental_rate / replacement_cost * 100, 2) AS percentage
FROM film
WHERE (rental_rate / replacement_cost * 100) < 4;
```
</details>

<br/>

# CASE WHEN

是 SQL 中的一個條件表達式，用來評估一個值是否符合一個條件，並返回相應的結果。

語法跟邏輯上更接近程式語言的 `switch case... default`，符合條件時便會回傳，不會繼續往下判斷。

- 用法

```sql
CASE
    WHEN condition1 THEN result1
    WHEN condition2 THEN result2
    WHEN conditionN THEN resultN
    ELSE result3
END
```

- 練習

**NOTE**: 注意這邊開始會用到新的資料庫 `demo`，對新的資料庫進行查詢，你需要對新資料庫開啟 `query tool`，若對此有疑問請參考 `03. 基礎 - 分組.md` 的章節挑戰。

```sql
-- 經典數字判斷
SELECT amount,
CASE
    WHEN amount < 2 THEN 'low amount'
    WHEN amount < 5 THEN 'medium amount'
    ELSE 'high amount'
END
FROM payment;

-- 進階字串判斷
SELECT
    TO_CHAR(book_date, 'Dy'),
    TO_CHAR(book_date, 'Mon')
CASE
    WHEN TO_CHAR(book_date, 'Dy') = 'Mon' THEN 'Monday special'
    WHEN TO_CHAR(book_date, 'Mon') = 'Jul' THEN 'July special'
    ELSE 'No special'
END
FROM bookings;

-- 實際案例：航班延誤統計
SELECT
    COUNT(*) AS flights,
    CASE
        WHEN actual_departure is null THEN 'No departure time'
        WHEN actual_departure - scheduled_departure > '00:00' THEN 'Delayed'
        WHEN actual_departure - scheduled_departure < '00:00' THEN 'Early'
        ELSE 'On time'
    END AS flights_status
FROM flights
GROUP BY flights_status;
```

- **挑戰 1 - UDEMY**:

Using the `sales_orders` table, write a SQL query to select the `order_id`, `product_id`, `quantity`, `unit_price`, and a new column named `total_price`. The `total_price` should be calculated as follows:

If a customer orders more than 1 unit of any product, they get a 10% discount on the total price for those products before adding the shipping fee.

The `total_price` should include the shipping fee.

You must use `CASE WHEN` to calculate the discounted price where applicable.

Table Name: `sales_orders`

Columns to use:

- `order_id`
- `product_id`
- `quantity`
- `unit_price`
- `shipping_fee`

<details>
    <summary>參考答案</summary>

```sql
SELECT
    order_id,
    product_id,
    quantity,
    unit_price,
    CASE
        WHEN quantity > 1 THEN (quantity * unit_price * 0.9) + shipping_fee
        ELSE (quantity * unit_price) + shipping_fee
    END AS total_price
FROM sales_orders;
```
</details>

<br/>

- **挑戰 2**:

你需要找出各價格區間的票賣出多少，並確認高價格的票（high price ticket）賣出幾張。

- Low amount ticket: `total_amount` < 20000
- Mid amount ticket: 20000 <= `total_amount` < 150000
- High amount ticket: `total_amount` > 150000

<details>
    <summary>參考答案</summary>

```sql
SELECT
    COUNT(*),
    CASE
        WHEN total_amount < 20000 THEN 'low amount ticket'
        WHEN total_amount < 150000 THEN 'mid amount ticket'
        ELSE 'high amount ticket'
    END AS ticket
FROM bookings
GROUP BY ticket
ORDER BY COUNT(*) DESC;

-- Ans:
-- 205036	"mid amount ticket"
-- 30012	"high amount ticket"
-- 27740	"low amount ticket"
```
</details>

<br/>

- **挑戰 3**:

你需要找出有多少班機（`flights`）被排定（`scheduled`）於以下季節出發（`departure`）：

- `Winter`: December, January, February
- `Spring`: March, April, May
- `Summer`: June, July, August
- `Fall`: September, October, November

<details>
    <summary>參考答案</summary>

```sql
-- 這邊使用的是 Mon 的 pattern
-- 你也可以使用其他的 pattern 或使用 EXTRACT(month from scheduled_departure)
-- 但要注意一些 pattern 的限制
-- 例如 Month 的長度是 9 個字元，也就是有的月份字串會包含空格
-- 這種情況下你可以選擇清除空格或是將判斷的字串補上空格

SELECT
    COUNT(*),
    CASE
        WHEN TO_CHAR(scheduled_departure, 'Mon') IN ('Dec', 'Jan', 'Feb') THEN 'Winter'
		WHEN TO_CHAR(scheduled_departure, 'Mon') IN ('Mar', 'Apr', 'May') THEN 'Spring'
		WHEN TO_CHAR(scheduled_departure, 'Mon') IN ('Jun', 'Jul', 'Aug') THEN 'Summer'
		WHEN TO_CHAR(scheduled_departure, 'Mon') IN ('Sep', 'Oct', 'Nov') THEN 'Fall'
    END AS season
FROM flights
GROUP BY season;

-- Ans:
-- "count"  "season"
-- 7595	"Fall"
-- 25526	"Summer"
```
</details>

<br/>

- **挑戰 4**:

你想根據以下優先序規則建立一個電影評價清單：

1. `rating` 是 `PG` 或 `PG-13` 或 `length` 大於 `210` 分鐘：評價為 `Great rating or long (tier 1)`
2. `description` 包含 `Drama` 並且 `length` 大於 `90` 分鐘：評價為 `Long drama (tier 2)`
3. `description` 包含 `Drama` 並且 `length` 沒有大於 `90` 分鐘：評價為 `Short drama (tier 3)`
4. `rental_rate` 小於 $`1`：評價為 `Very cheap (tier 4)`

另外，你還需要將結果過濾掉不屬於這些評級的電影。

結果應該包含電影名稱（`title`）。

**NOTE**: 此題使用 `learningdb` 資料庫。

<details>
    <summary>參考答案</summary>

```sql
SELECT
	title,
    CASE
	    WHEN
		    rating IN ('PG', 'PG-13')
			OR
			length > 210
		THEN 'Great rating or long (tier 1)'
		WHEN
		    description LIKE '%Drama%'
			AND
			length > 90
		THEN 'Long drama (tier 2)'
		WHEN
		    description LIKE '%Drama%'
			AND
			length <= 90
		THEN 'Short drama (tier 3)'
		WHEN
		    rental_rate < 1
		THEN 'Very cheap (tier 4)'
	END AS tier
FROM film
WHERE
	CASE
		WHEN
			rating IN ('PG', 'PG-13')
			OR
			length > 210
		THEN 'Great rating or long (tier 1)'
		WHEN
			description LIKE '%Drama%'
			AND
			length > 90
		THEN 'Long drama (tier 2)'
		WHEN
			description LIKE '%Drama%'
			AND
			length <= 90
		THEN 'Short drama (tier 3)'
		WHEN
			rental_rate < 1
		THEN 'Very cheap (tier 4)'
	END is not null;
-- 很明顯這是一個很冗長的查詢
-- 後續會學到多種如何精簡查詢的方式
-- 下面是一個最基本的子查詢範例
-- 可以先大概了解就好

SELECT * FROM (
    SELECT
        title,
        CASE
            WHEN rating IN ('PG', 'PG-13') OR length > 210
            THEN 'Great rating or long (tier 1)'
            WHEN description LIKE '%Drama%' AND length > 90
            THEN 'Long drama (tier 2)'
            WHEN description LIKE '%Drama%' AND length <= 90
            THEN 'Short drama (tier 3)'
            WHEN rental_rate < 1
            THEN 'Very cheap (tier 4)'
        END AS tier
    FROM film
) AS subquery
WHERE tier IS NOT NULL;
```
</details>

<br/>

# CASE WHEN & SUM

CASE 與 SUM 在實務上也經常組合使用。

- 用法:

```sql
SELECT
    rating,
    SUM(CASE WHEN condition THEN value END)
FROM table_name;
```

- 練習:

```sql
SELECT
    SUM(CASE WHEN rating = 'G' THEN 1 END) AS "G",
    SUM(CASE WHEN rating = 'R' THEN 1 END) AS "R",
FROM film;
```

- **挑戰 1**:

Write a single SQL query to calculate the total income and total expenses from the `transactions` table.

Additionally, calculate the net income (total income - total expenses) as a separate column in the result.

Key information for the challenge:

- Table name: `transactions`
- Column names needed: `amount`, `category`
- Use aliases for the total income, total expenses, and net income as `TotalIncome`, `TotalExpenses`, and `NetIncome`, respectively.

**NOTE**: Please use `SUM` and `CASE WHEN` to calculate the total income, total expenses, and net income.

<details>
    <summary>參考答案</summary>

```sql
SELECT
  SUM(CASE WHEN category = 'Income' THEN amount END) AS TotalIncome,
  SUM(CASE WHEN category = 'Expense' THEN amount END) AS TotalExpenses,
  SUM(
      CASE
          WHEN category = 'Income' THEN amount
          WHEN category = 'Expense' THEN -amount
      END
  ) AS NetIncome
FROM transactions;
```
</details>

# COALESCE

用於回傳多個值中的第一個非 NULL 值，如果所有值都為 NULL，則返回 NULL。

通常用於確保清單中沒有 NULL 值。

- 用法:

```sql
SELECT COALESCE(value1, value2, value3, ...);

-- 假如 value1 為 null 且 value2 不為 null，則返回 value2
-- 假如 value1 和 value2 都為 null 且 value3 不為 null，則返回 value3
-- 以此類推
```

- **挑戰 1 - UDEMY**:

Consider the following table called `transactions`:

| transaction_id | account_id | transaction_type | amount | description |
| --- | --- | --- | --- | --- |
| 1 | 1001 | Deposit | 500 | Salary |
| 2 | 1002 | Withdrawal | 200 | ATM Withdrawal |
| 3 | 1003 | Deposit | 1500 | null |
| 4 | 1001 | Deposit | 450 | Freelance Payment |
| 5 | 1002 | Withdrawal | 100 | null |


Write a SQL query to retrieve all transactions, displaying the transaction ID, account ID, transaction type, amount, and description.

For any transactions that do not have a description, display 'Not Provided' in place of the NULL value. Ensure your query is ordered by the transaction ID. Make sure to not forget to use the alias `description`.

Important columns: `transaction_id`, `account_id`, `transaction_type`, `amount`, `description`

<details>
    <summary>參考答案</summary>

```sql
SELECT
    transaction_id,
    account_id,
    transaction_type,
    amount,
    COALESCE(description, 'Not Provided') as description
FROM transactions
ORDER BY transaction_id;
```
</details>

<br/>

# CAST

用於將值轉換為指定的資料類型。

**NOTE**: 並不是任何類型的值都可以轉換為其他類型，例如直接將 'ABC' 轉換為數字是不可能的。

- 用法:

```sql
CAST(<value>/<column> AS <data type>);
```

- 練習:

```sql
CAST(scheduled_arrival AS DATE);

-- 若在我們還沒學習過 CAST 的情況下，單獨以以下方式使用 COALESCE 時會發生錯誤
-- 因為 actual_arrival - scheduled_arrival 是 interval 類型，無法直接轉換為 'Not arrived' 字串
-- 需要先變更資料類型才行
SELECT
    COALESCE(CAST(actual_arrival - scheduled_arrival AS VARCHAR), 'Not arrived')
FROM flights;
```

- **挑戰 1**:

本次挑戰的目標為將以下的 SQL 查詢返回結果中，`return_date` 為 `null` 的值變更為 `not returned` 字串。

```sql
SELECT
    rental_date,
	return_date
FROM rental
ORDER BY rental_date DESC;
```

<details>
    <summary>參考答案</summary>

```sql
SELECT
    rental_date,
	COALESCE(CAST(return_date AS VARCHAR), 'not returned') as return_status
FROM rental
ORDER BY rental_date DESC;
```
</details>

# REPLACE

用於替換字串中的特定字串。

- 用法:

```sql
REPLACE(<column>, <old_text>, <new_text>);
```

- 練習:

```sql
-- 把所有的 'PG' 替換為 'KL'
REPLACE(flight_no, 'PG', 'KL');

-- 把所有的 'PG' 替換為空字串，實際上就是刪除 'PG'
REPLACE(flight_no, 'PG', '');

-- 實際用例
SELECT
    CAST(REPLACE(flight_no, 'PG', '') AS INT)
FROM flights;
```