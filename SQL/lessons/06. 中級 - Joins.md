# Joins

用途為將多個表的資料結合在一起，以便進行複雜的查詢和分析。

- 類型:
    - INNER JOIN: 交集，只有兩個表都有的資料才會合併顯示
    - FULL OUTER JOIN: 聯集，兩個表的所有資料都會合併顯示
    - LEFT OUTER JOIN（LEFT JOIN）: 左表的資料為主，即使是右表沒有的資料也會合併顯示
    - RIGHT OUTER JOIN（RIGHT JOIN）: 右表的資料為主，即使是左表沒有的資料也會合併顯示

# INNER JOIN

- 用法:

```sql
SELECT * FROM table_a
INNER JOIN table_b
ON table_a.column = table_b.column;

-- 也可以使用別名簡化查詢
SELECT * FROM table_a AS a
INNER JOIN table_b AS b
ON a.column = b.column;

-- 當指定 column 時，若該 column 在兩個表都有，則須指定要用哪個表的 column，否則資料庫會報錯
-- 因為實際上 join 後，兩個表是合併顯示的狀態，並不是兩個表 ON 條件的 column 直接合併成一個 column
-- 若選擇呈現 a.*, b.*，可以發現兩個表的"所有" column 都會顯示出來
-- 另外，即使是僅在一表存在的 column，在選擇時，建議也加上表名，以提高可讀性以及避免未來潛在的衝突可能
SELECT a.employee_id, sale FROM table_a AS a
INNER JOIN table_b AS b
ON a.employee_id = b.employee_id;

-- 通常 AS 也可以省略，但建議為了可讀性使用
SELECT a.employee_id, sale FROM table_a a
INNER JOIN table_b b
ON a.employee_id = b.employee_id;
```

- 練習:

```sql
-- 取得 payment 資料表的所有資料以及 customer 資料表紀錄的姓名
SELECT
    payment.*,
	first_name,
	last_name
FROM payment AS p
INNER JOIN customer AS c
ON payment.customer_id = customer.customer_id;
```

# FULL OUTER JOIN

- 用法:

```sql
SELECT * FROM table_a
FULL OUTER JOIN table_b
ON table_a.column = table_b.column;
```

- 練習:

```sql
-- 這代表取得買票但還沒有登機證的資料
SELECT *
FROM boarding_passes AS b
FULL OUTER JOIN tickets AS t
ON b.ticket_no = t.ticket_no
WHERE b.boarding_no is null;

-- 這代表取得沒買票卻有登機證的資料
-- 理論上應該要是空的
SELECT *
FROM boarding_passes AS b
FULL OUTER JOIN tickets AS t
ON b.ticket_no = t.ticket_no
WHERE t.boarding_no is null;
```

# LEFT OUTER JOIN & RIGHT OUTER JOIN

本質上用法與 FULL OUTER JOIN 一樣

差異只在於會以一個表的資料為主，另一個表沒有的資料會顯示為 null

可以想像整個集合是 A ∪ B，這邊的情況就像是 A - B + (A ∩ B)

- 練習:

```sql
-- 關聯飛機資料表與航班資料表
SELECT * FROM aircrafts_data as a
LEFT JOIN flights as f
ON a.aircraft_code = f.aircraft_code;

-- 這邊做了一個判斷檢查沒有航班的飛機
SELECT * FROM aircrafts_data as a
LEFT JOIN flights as f
ON a.aircraft_code = f.aircraft_code
WHERE f.flight_id is null;
```

- **挑戰 1**:

航空公司想要找出哪些座位是最受歡迎的，請替他們找出來哪些位子最常被選擇，確保所有座位都在統計結果中，即使位子從來沒有被預定過。並請回答是否有座位從來沒有被預定過。

**NOTE**: 你需要自行確認要搜尋哪些表來完成此任務。

<details>
    <summary>參考答案</summary>

```sql
SELECT
    s.seat_no,
	COUNT(*) AS booking_count
FROM seats AS s
LEFT JOIN boarding_passes AS b
ON s.seat_no = b.seat_no
GROUP BY s.seat_no
ORDER BY booking_count DESC;

-- Ans:（無，因沒有位子的歷史訂位數為 0）
-- "1A"	53559
-- "4A"	53181
-- "2A"	53145
-- "3A"	52524
-- ...
```
</details>

<br/>

- **挑戰 2**:

與挑戰 1 類似，但這次想知道的是，哪一個行最受歡迎，例如 A, B, C... 等等。

<details>
    <summary>參考答案</summary>

```sql
SELECT
    RIGHT(s.seat_no, 1) as line,
	COUNT(*)
FROM seats AS s
LEFT JOIN boarding_passes AS b
ON s.seat_no = b.seat_no
GROUP BY line
ORDER BY COUNT(*) DESC;

-- Ans:（A 行最受歡迎）
-- "A"	751618
-- "D"	652188
-- "C"	596921
-- "F"	467493
-- "E"	377687
-- ...
```

</details>

<br/>

- **挑戰 3**:

公司想要對 Texas 州（`district`）的客戶（`customer`）發起通話活動。

1. 請找出哪些客戶（`first_name`, `last_name`, `phone number` and their `district`）來自 `Texas` 州。

2. 確認是否存在地址（`addresses`）沒有與任何客戶（`customer`）有關聯性？（可能代表客戶地址有變更）

<details>
    <summary>3-1. 參考答案</summary>

```sql
SELECT
	first_name,
	last_name,
    phone,
	district
FROM customer AS c
INNER JOIN address AS a
ON c.address_id = a.address_id
WHERE district = 'Texas';

-- Ans:
-- "JENNIFER"	"DAVIS"	"860452626434"	"Texas"
-- "KIM"	"CRUZ"	"909029256431"	"Texas"
-- "RICHARD"	"MCCRARY"	"262088367001"	"Texas"
-- "BRYAN"	"HARDISON"	"775235029633"	"Texas"
-- "IAN"	"STILL"	"239357986667"	"Texas"
```
</details>

<br/>

<details>
    <summary>3-2. 參考答案</summary>

```sql
SELECT
	a.address_id,
	address,
	customer_id
FROM address AS a
FULL OUTER JOIN customer AS c
ON c.address_id = a.address_id
WHERE customer_id is null
ORDER BY a.address_id;

-- Ans:
-- 1	"47 MySakila Drive"	
-- 2	"28 MySQL Boulevard"	
-- 3	"23 Workhaven Lane"	
-- 4	"1411 Lillydale Drive"	
```
</details>

<br/>

# JOIN 多個條件

有時我們需要判斷多個條件才有辦法將兩個表關聯起來，舉例來說 last name 與 first name，只有任一一個條件的話沒有辦法確保將兩個人關聯起來後是同一個人的資料，這時就會需要多條件的 JOIN。

- 用法:

```sql
SELECT * FROM table_a
INNER JOIN table_b
ON table_a.first_name = table_b.first_name
AND table_a.last_name = table_b.last_name
AND ...
```

- 練習:

```sql
-- 這邊使用了一個特殊的過濾技巧
-- 對 last name 為 Jones 的人進行過濾
-- 當然這樣搜尋的結果與使用 WHERE last_name = 'Jones' 的結果是一樣的
-- 但在效能上，這種搜尋方式更快
SELECT * FROM table_a
INNER JOIN table_b
ON table_a.first_name = table_b.first_name
AND table_a.last_name = 'Jones';
```