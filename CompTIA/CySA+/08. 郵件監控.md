# 電子郵件監控

## 概述

- **Email Monitoring**（電子郵件監控）：確保組織電子郵件安全的一系列工具和技術

## 相關術語

- **Indicators of Compromise**（入侵指標，IOC）：用於判斷是否發生釣魚或冒充活動的跡象
  - 分析電子郵件監控工具的輸出結果來識別

- **Email Header Analysis**（電子郵件標頭分析）：檢查電子郵件標頭識別惡意內容

- **Email Content Analysis**（電子郵件內容分析）：檢查電子郵件內容中的惡意數據

- **Email Server Configuration**（電子郵件伺服器配置）：提高安全性的正確設定方法

- **SMTP Log Analysis**（SMTP 日誌分析）：分析郵件傳輸協議的日誌記錄

- **S/MIME and Digital Signatures**（S/MIME 和數位簽章）：使用加密和簽章技術確保電子郵件安全

## 安全重要性

- **Email as Attack Vector**（電子郵件作為攻擊媒介）：電子郵件是威脅行為者常用的攻擊入口
  - 常見於社交工程活動中

- **Social Engineering Campaigns**（社交工程活動）：透過電子郵件進行的常見攻擊類型
  - 包含釣魚（Phishing）
  - 魚叉式釣魚（Spear Phishing）
  - 鯨魚式釣魚（Whaling）：針對高階主管的特定釣魚攻擊

# 電子郵件入侵指標

- **Spam**（垃圾郵件）：未經請求且不受歡迎的垃圾電子郵件，批量發送給不特定的收件人清單。
    - 垃圾郵件攻擊原理是廣撒網，總會有人上鉤

- **Phishing**（網路釣魚）：一種欺詐行為，發送看似來自知名公司的電子郵件，目的是誘使個人泄露個人信息，如密碼或信用卡號碼。
    - 通常作為垃圾郵件的一部分出現，但具有更惡意的意圖

- **Pretext**（情境塑造）：一種社交工程形式，個人撒謊並提供虛假動機以獲取特權數據。
    - 例如：「我是PayPal的工作人員，您的帳戶已被入侵」，要求點擊連結進行修復
    - 或「有一筆大額交易發生，請點擊此處驗證」等常見騙術

- **Spear Phishing**（魚叉式網路釣魚）：針對特定組織或個人的電子郵件欺騙攻擊，尋求未經授權訪問敏感信息。
    - 比一般網路釣魚更有針對性，專門攻擊已知的目標群體
    - 例如：針對某銀行客戶發送該銀行的釣魚郵件，提高受害者點擊的可能性

- **Impersonation**（身份冒充）：攻擊者成功假冒系統或通信協議中的合法參與方之一的身份。
    - 例如：冒充公司員工發送電子郵件，使他人執行攻擊者要求的操作

- **Business Email Compromise (BEC)**（商業電子郵件入侵）：一種身份冒充攻擊，攻擊者獲取員工帳戶的控制權，然後利用它誘使其他員工執行欺詐行為。
    - 攻擊者可能通過釣魚郵件獲取員工帳戶，然後冒充該員工發送要求
    - 例如：冒充員工要求財務部門向特定賬戶轉帳付款

- **Email Spoofing**（電子郵件欺騙）：讓郵件看起來像是來自特定人員的技術。
    - 攻擊者可能會收集目標的信息，如財務主管的電子郵件地址、姓名和寫作風格
    - 然後冒充該人員發送要求轉移資金的指令

- **Forwarding**（轉發）：將釣魚郵件格式化，使其看起來像回覆或郵件鏈的一部分。
    - 攻擊者可能冒充較低級別員工轉發看似來自高級管理人員的郵件
    - 例如：冒充助理轉發看似來自財務主管的轉帳請求

- **Email Message Internet Header**（電子郵件網路標頭）：附加於郵件的互聯網標頭，可用於檢測欺騙嘗試。
    - 包含比收件人、抄送、發件人和主題行更多的信息
    - 可通過分析這些標頭來識別偽造的電子郵件

# 電子郵件標頭分析

- **Email Internet Header**（電子郵件網際網路標頭）：記錄了從寄件者到收件者之間所有參與傳輸電子郵件的伺服器紀錄。
  - 包含很多重要但通常隱藏的資訊，對於安全分析非常有價值。

## 電子郵件傳輸流程

- **MUA (Mail User Agent)**（郵件使用者代理）：
  - 使用者用來建立和閱讀電子郵件的程式（如Gmail、Outlook等）
  - 建立初始標頭

- **MDA (Mail Delivery Agent)**（郵件傳遞代理）：
  - 從MUA通過SMTP接收郵件
  - 負責檢查寄件者是否有權從該網域發送郵件
  - 檢查郵件是否可以在本地伺服器處理

- **MTA (Message Transfer Agent)**（郵件傳輸代理）：
  - 負責將郵件路由到收件人
  - 使用DNS定位收件人的MTA
  - 每個MTA都會在郵件標頭中添加資訊
  - 郵件可能經過多個MTA才能到達目的地

## 電子郵件的脆弱點

- **三種寄件者地址欄位**：攻擊者可利用這三個欄位進行欺騙

1. **Display From**（顯示寄件者）：
   - 例如：`Support <support@diontraining.com>`
   - 這是使用者實際看到的寄件者資訊
   - 可以任意設定，常被攻擊者用來偽裝身份

2. **Envelope From**（信封寄件者）：
   - 實際的退信地址
   - 對郵件客戶端通常是隱藏的
   - 如果郵件被拒絕，會退回到此地址

3. **Received From/By**（接收自/由）：
   - 處理此郵件的所有MTA列表
   - 記錄郵件通過的每個伺服器
   - 可用於追蹤郵件的實際來源

## 標頭分析實例

- **身份驗證結果**（Authentication Results）：
  - 顯示郵件的發送者和郵件來源
  - 包含SMTP郵件來源和標頭來源資訊
  - 有助於識別可能的垃圾郵件或釣魚郵件

- **開放轉發**（Open Relay）：
  - 被攻擊者接管並用於發送垃圾郵件的伺服器
  - 在標頭分析中可以識別這類伺服器

- **X標頭**（X Headers）：
  - 由SMTP伺服器管理員控制的自定義標頭
  - 例如：X-MS-Exchange、X-MS-Office、X-Sender等
  - 可用於郵件反垃圾和安全分析

## 標頭分析工具

- **Microsoft Message Header Analyzer**：
  - 網址：testconnectivity.microsoft.com
  - 可將郵件標頭貼上並分析
  - 以更清晰的格式顯示標頭資訊
  - 顯示郵件轉發時間軸和延遲時間

## 標頭分析技巧

- 從下往上讀取標頭（按時間順序）
- 檢查寄件者資訊與返回路徑是否一致
- 注意可疑的主旨行和內容類型
- 分析郵件經過的所有伺服器
- 留意不尋常的延遲時間（可能表示攻擊者修改）

# 電子郵件內容分析

- **MIME（Multipurpose Internet Mail Extensions，多用途網際網路郵件擴展）**：允許電子郵件內文支援不同格式的標準。
    - 支援的格式包括：HTML、RTF（富文本格式）、Base64 ASCII 編碼的二進制數據及附件
    - 本身並非惡意，但可被用來傳遞惡意內容

- **Malicious Payload（惡意負載）**：攻擊者在電子郵件中植入的惡意代碼，主要有兩種形式：
    - **Exploit（漏洞利用）**：包含腳本或物件的郵件數據，專門針對郵件客戶端的漏洞
        - 當郵件程式預覽時可能自動執行代碼
        - 可利用 MIME 支援的 HTML、JavaScript 等語言編寫
    - **Attachment（附件）**：包含惡意檔案的郵件，期望使用者開啟或執行
        - 可能包含病毒、蠕蟲等各種惡意軟體

- **Embedded Links（嵌入式連結）**：郵件中的連結，可能隱藏真實目標
    - 可由友好字串加 URL 組成
    - 或使用縮短的 URL 隱藏真實目標網址
    - 安全做法：不直接點擊連結，應複製連結文字到瀏覽器，檢查完整 URL 後再決定是否訪問

- **Email Signature Block（電子郵件簽名區塊）**：可作為判斷郵件真偽的線索
    - 缺失或格式不良的簽名區塊可能是釣魚郵件的指標
    - 若公司使用統一格式的簽名區塊，不符合標準格式的郵件應提高警覺

# 電子郵件伺服器安全

## 電子郵件安全技術

- **Spoofing Attacks**（欺騙攻擊）：可透過電子郵件伺服器身份驗證來緩解
  - 主要緩解技術包括：SPF、DKIM、DMARC 及防範 Cousin Domains

- **DKIM (Domain Keys Identified Mail)**（網域金鑰識別郵件）：允許接收者檢查電子郵件是否真的由宣稱的網域發送，並確認內容在傳輸過程中是否被竄改
  - 原理：在電子郵件標頭加入數位簽章，該簽章可以透過存放在寄件網域 DNS 記錄中的公開加密金鑰驗證
  - 流程：寄件方的郵件伺服器使用私鑰對郵件進行數位簽章，接收方伺服器使用寄件方網域中的公鑰解密並驗證簽章
  - 優點：電子郵件認證、防止電子郵件詐騙、提高郵件送達率、提升寄件者聲譽
  - 可以在轉發過程中保持有效，是確保電子郵件安全的基礎

- **SPF (Sender Policy Framework)**（寄件者政策框架）：防止在電子郵件傳遞過程中偽造寄件者地址的電子郵件認證方法
  - 原理：啟用 SPF 的伺服器收到電子郵件時，會驗證寄件者的 IP 地址是否在寄件者網域 DNS 記錄中發布的已授權 IP 列表中
  - 例如：收到來自 diontraining.com 的郵件時，接收郵件伺服器會確認寄件者 IP 是否列在 diontraining.com 的 SPF 記錄中
  - 優點：防止電子郵件詐騙、提高郵件送達率、提升網域聲譽
  - 允許網域擁有者指定哪些伺服器被授權使用其網域發送電子郵件

- **DMARC (Domain-based Message Authentication, Reporting, and Conformance)**（基於網域的訊息認證、報告和一致性）：一種電子郵件驗證系統，用於檢測和防止電子郵件詐騙
  - 功能：允許網域管理者發布政策，規定發送郵件時應採用何種機制，以及接收者應如何處理認證失敗的情況
  - 配合方式：可以與 DKIM、SPF 或兩者同時使用，取決於配置方式
  - 範例：公司設定 DMARC 政策指示接收郵件服務拒絕已失敗 DKIM 或 SPF 檢查的郵件
  - 主要目的：保護網域不被用於商業電子郵件入侵攻擊、釣魚郵件、郵件詐騙和其他網路安全威脅
  - 是 SPF 和 DKIM 的政策層，幫助電子郵件接收系統識別未來自公司核准網域的郵件

## 電子郵件驗證流程

- **合法郵件流程**：
  1. 寄件者發送郵件到 MTA（郵件傳輸代理）
  2. MTA 查詢寄件者的 DMARC 政策以及 SPF/DKIM 記錄
  3. 驗證通過後，郵件被放入收件者的 IMAP 伺服器中
  4. 收件者使用郵件用戶代理（MUA）讀取郵件

- **非法郵件流程**：
  1. 攻擊者發送郵件到 MTA
  2. MTA 檢查 DMARC 政策與 SPF/DKIM 記錄
  3. 若不匹配，郵件被拒絕、刪除或隔離

## 其他威脅

- **Cousin Domains**（近似網域）：看起來與合法網域相似的網域名稱
  - 範例：將 diontraining.com 改為 diontrainimg.com（n 改為 m）
  - 或 diontraning.com（少一個 i）
  - 這類網域若正確設置 SPF、DKIM 和 DMARC，仍可通過郵件伺服器驗證
  - SPF、DKIM 和 DMARC 無法解決近似網域問題，需要使用者仔細檢查

# SMTP日誌分析

- **SMTP Log Analysis**（SMTP日誌分析）：對郵件伺服器日誌進行分析的過程
  - SMTP日誌通常以請求/回應方式格式化，包含時間、收件人地址、訊息大小和狀態碼等資訊

## 重要的SMTP狀態碼

- **Code 220**（就緒碼）：表示伺服器已準備好處理請求
  - 表示伺服器已收到連接並準備接收資料

- **Code 250**（接受碼）：表示訊息已被接受
  - 伺服器已成功接收訊息，不需要重新發送

- **Code 421**（服務不可用碼）：表示服務不可用
  - 可能是伺服器已關閉、出現問題或無法處理請求

- **Code 450**（無法訪問郵箱碼）：表示伺服器無法訪問郵箱來傳遞訊息
  - 可能是權限問題或郵箱不存在

- **Code 451**（處理錯誤碼）：表示本地伺服器因處理錯誤而中止操作
  - 伺服器內部發生錯誤導致無法完成請求

- **Code 452**（儲存空間不足碼）：表示本地伺服器可用儲存空間不足
  - 伺服器硬碟空間已滿，無法儲存新訊息

## SMTP日誌分析範例

- **日誌格式**：
  - 通常包含SMTPD（Linux SMTP守護程序）、日誌條目、日期、時間、IP地址和訊息內容
  - 主要關注日誌右側的訊息部分

- **日誌解讀流程**：
  - `SENT: 220`：我們的伺服器準備接收訊息
  - `RECEIVED`：收到來自外部SMTP伺服器的訊息
  - `SENT: 250`：我們的伺服器接受了訊息
  - 收件人確認、資料傳輸、訊息排隊等過程
  - `SENT: 221`：結束連接的告別訊息

- **異常識別**：
  - 注意可疑的發件人地址（如範例中的getrich@bitminer.foo）
  - 檢查收件人郵箱是否收到潛在釣魚或惡意郵件

## 考試準備重點

- 對於CYSA+考試，重點掌握狀態碼220和250的含義
  - 220：伺服器就緒
  - 250：訊息已接受

# 電子郵件安全

- **S/MIME**（安全多用途網際網路郵件擴充）：一種電子郵件加密標準，將數位簽章和公開金鑰密碼學加入到傳統的 MIME 通訊中
  - 每位使用者需要擁有包含其公開金鑰的數位憑證才能使用 S/MIME
  - 使用者同時擁有私密金鑰，必須嚴格保密

## S/MIME 的運作方式

1. **憑證交換流程**：
   - 發送者將自己的數位憑證（包含公開金鑰）發送給接收者
   - 憑證包含發送者的數位 ID、識別名稱和電子郵件地址
   - 發送者用私密金鑰簽署訊息
   - 接收者使用發送者的公開金鑰和 CA（憑證授權機構）的簽章來驗證發送者的憑證
   - 接收者回覆自己的數位憑證
   - 雙方將對方的憑證儲存在可信任的憑證庫中

2. **安全通訊階段**：
   - 雙方擁有對方的公開金鑰後，可開始安全通訊
   - 一方使用私密金鑰加密，另一方使用對應的公開金鑰解密

## S/MIME 安全功能

- **完整性和不可否認性**：
  - 發送者對訊息進行雜湊（hash）處理
  - 使用私密金鑰加密該雜湊值
  - 同時發送原文和加密的雜湊值
  - 接收者使用發送者的公開金鑰解密雜湊值
  - 接收者對收到的訊息計算雜湊值並與解密後的雜湊值比較
  - 雜湊值相符表示訊息未被竄改（完整性）
  - 由於只有發送者擁有該私密金鑰，因此提供了不可否認性

- **機密性**：
  - 發送者使用接收者的公開金鑰加密整個訊息
  - 僅有接收者可使用其私密金鑰解密訊息
  - 即使訊息在傳輸過程中被截獲，也無法被讀取

## 綜合應用

- 完整的 S/MIME 解決方案結合了上述兩項功能：
  - 使用數位簽章（私密金鑰加密的雜湊值）確保完整性和不可否認性
  - 使用接收者公開金鑰加密訊息確保機密性

## 郵件客戶端的驗證顯示

- 有效的數位簽章：郵件客戶端會顯示「已簽署」標記，通常以絲帶圖示表示
- 無效的數位簽章：郵件客戶端會顯示紅色 X 標記，表示訊息未經數位簽署或簽署無效