# 漏洞管理與列舉工具

## 列舉工具概述

- **Enumeration Tools**（列舉工具）：用於收集網路和系統資訊的工具，是資安分析師的重要工具

## 主要工具

- **Nmap**（網路對應器）：世界上最流行的網路掃描工具
  - Discovery scans（探索掃描）
  - Port scans（連接埠掃描）
  - Port states（連接埠狀態）
  - Fingerprinting scans（指紋掃描）

- **其他網路工具**：
  - Hping（進階封包製作工具）
  - Angry IP Scanner（IP掃描工具）
  - Maltego（資訊收集和關聯分析工具）
  - Responder（LLMNR/NBT-NS/mDNS中毒工具）

- **無線評估工具**：
  - Aircrack-ng（無線網路安全評估套件）
  - Reaver（WPS漏洞利用工具）

- **Recon-ng**（開源情報和列舉工具）：
  - 滲透測試人員和資安分析師常用的工具

- **Hashcat**（密碼破解工具）：
  - 用於測試憑證安全性
  - 將演示如何測試網路憑證的安全性

# 列舉工具

- **Enumeration（列舉）**：識別和掃描目標網路範圍和主機，然後映射出攻擊面的過程。
  - 同時被攻擊者和防禦者使用
  - 攻擊者用來了解網路以進行攻擊
  - 防禦者用來了解自身攻擊面

- **Active Enumeration（主動列舉）**：當攻擊者與目標之間建立連接並傳輸數據時發生。
  - 容易被檢測到
  - 可被追蹤源頭
  - 通常會觸發入侵檢測系統（IDS）警報

- **Semi-passive Enumeration（半被動列舉）**：使用分散且稀疏的連接嘗試進行偵察。
  - 透過延長探測間隔時間避免被入侵檢測系統發現
  - 降低被檢測風險的技術

- **Passive Enumeration（被動列舉）**：不與目標建立直接連接的列舉方式。
  - 僅收集並分析網路上的數據
  - 不實際觸碰目標設備
  - 使用網路嗅探器收集流量

- **被動列舉工具**：
  - **Wireshark**：進行封包捕獲和分析
  - **Zeek/Bro**：用於網路流量分析，能識別網路上運行的軟體、版本號和服務類型
  - **p0f**：利用被動流量指紋技術識別TCP/IP通信背後的設備
    - 僅需一個SYN封包即可檢測操作系統類型或瀏覽器類型

- **被動掃描的實現方法**：
  - **網路分流器（Network Tap）**：將一個網路連接點的所有流量複製出來進行分析
  - **埠鏡像（Port Mirror）**：將網路流量複製到專門用於捕獲信息的網路客戶端

- **列舉支援技術**：
  - **開源情報（Open Source Intelligence）**：搜尋公開可用信息的工具
    - 收集DNS記錄、IP地址和公開網站上的信息
  
  - **足跡識別（Footprinting）**：映射網路佈局的工具
    - 專注於IP地址使用、路由拓撲和DNS命名空間
    - 提供網路的大致輪廓，如主要路由
    - 關注整體網路佈局

  - **指紋識別（Fingerprinting）**：執行主機系統檢測的工具
    - 映射系統開放端口、操作系統類型和版本
    - 識別文件共享、運行服務和應用程序
    - 收集系統正常運行時間和其他有用元數據
    - 專注於單個主機或伺服器的詳細信息

- **術語區分**（考試重點）：
  - 足跡識別（Footprinting）關注整體網路佈局
  - 指紋識別（Fingerprinting）關注單個主機或伺服器的詳細信息
  - 在現實工作環境中這兩個術語常被互換使用

# Nmap 探索掃描

- **Nmap Security Scanner**（Nmap 安全掃描器）：一個多功能的連接埠掃描工具，用於拓撲、主機、服務和作業系統的探索與列舉。
  - 來自開源的 Nmap Project
  - 世界上最流行的列舉工具

- **Discovery Scan**（探索掃描）：用於對網路進行足跡探查，找出網路中存在的主機和拓撲。
  - 目標是確定網路上有哪些主機
  - 了解網路拓撲結構，包括 IP 地址等信息

- **基本用法**：
  - 語法：`nmap [IP地址]` 或 `nmap [IP範圍]`
  - 範例：`nmap 192.168.1.0/24`（掃描該範圍內所有 256 個 IP）

- **預設行為**：
  - 發送 ping 和 TCP ACK 封包到連接埠 80 和 443
  - 如果主機存在，會對該主機執行連接埠掃描
  - 檢查 1000 個最常用的連接埠
  - 缺點：耗時且不隱蔽，容易被 IDS/IPS 或防火牆阻擋

- **Host Discovery Scan**（主機探索掃描）：
  - 語法：`nmap -sn [IP範圍]`
  - 只執行主機探索部分，抑制默認的連接埠掃描
  - 更高效，特別是掃描大型網路時

- **其他掃描選項**：
  - **List Scan**（列表掃描）：`-sL`
    - 列出目標範圍內的 IP 地址
    - 執行反向 DNS 查詢以發現與 IP 相關的主機名
    - 被視為被動方法，因為不直接向主機發送探測

  - **TCP SYN Ping**（TCP SYN 探測）：`-PS`
    - 使用 TCP SYN 封包探測指定連接埠
    - 對於阻止 ICMP 封包的網路很有幫助
    - 發送 SYN 封包，接收 SYN/ACK 回應，但不完成三次握手

  - **Sparse Scanning**（稀疏掃描）：`--scan-delay [時間]`
    - 在探測間增加延遲，提高隱蔽性
    - 避免被 IDS/IPS 檢測

  - **Scan Timing**（掃描時機）：`-Tn`
    - n 的範圍從 0（最慢）到 5（最快）
    - 調整探測的速度模式
    - 例：`-T4` 表示相當快的掃描速度

  - **TCP Idle Scan**（TCP 閒置掃描）：`-sI`
    - 使掃描看起來像是來自另一台機器（殭屍機）
    - 隱藏真正的掃描者身份

  - **Fragmentation**（分片）：`-f` 或 `--mtu`
    - 將 TCP 標頭分割成多個 IP 數據報
    - 使 IDS/IPS 更難檢測

- **輸出選項**：
  - **Interactive**（互動式）：默認模式，結果顯示在螢幕上
  - **Normal**（一般）：`-oN [檔案名]`，將結果保存為文本檔
  - **XML**：`-oX [檔案名]`，將結果保存為 XML 格式
  - **Grepable**（可 grep 格式）：`-oG [檔案名]`，保存為可用 grep 命令處理的格式
  - XML 和 grepable 輸出更適合與 SIEM 產品整合

# Nmap 連接埠掃描

- **Fingerprinting（指紋識別）**：在完成 footprinting 後的下一階段，用於獲取有關單個主機的詳細信息
  - 通過服務發現來實現

- **Service Discovery（服務發現）**：幫助確定目標使用的網路服務和操作系統
  - 掃描時間可能從幾分鐘到幾小時不等，取決於掃描的 IP 數量和連接埠數量
  - 注意：即使「隱蔽」的掃描方式也可能被配置良好的 IDS/IPS 系統檢測到

## Nmap 連接埠掃描類型

- **TCP SYN Scan（TCP SYN 掃描）**：使用 `-sS` 參數
  - 進行半開放掃描，僅發送 SYN 數據包識別連接埠狀態，不發送確認包
  - 類似 SYN flood 機制，但在得到回應（SYN/ACK）後，會發送 RST 封包，因此不會造成拒絕服務攻擊
  - 需要管理員/root 權限執行

- **TCP Connect Scan（TCP 連接掃描）**：使用 `-sT` 參數
  - 進行完整的三次握手掃描
  - 當網路卡不支援半開放掃描或沒有管理員權限時使用

- **Null Scan（空掃描）**：使用 `-sN` 參數
  - 發送頭部位全部設置為零的數據包
  - 異常流量模式，容易被 IDS/IPS 檢測

- **FIN Scan（FIN 掃描）**：使用 `-sF` 參數
  - 發送非預期的 FIN 數據包（通常用於結束通信會話）
  - 同樣容易被入侵檢測系統識別

- **Christmas Scan（聖誕樹掃描）**：使用 `-sX` 參數
  - 發送同時設置 FIN、PUSH 和 URG 標誌的數據包
  - 因在日誌中看起來像「聖誕樹」而得名
  - 最容易被檢測的掃描方法，滲透測試人員可用來測試安全團隊的警覺性

- **UDP Scan（UDP 掃描）**：使用 `-sU` 參數
  - 發送 UDP 數據包並等待回應或超時
  - 由於 UDP 沒有握手機制，通過回應情況判斷連接埠狀態

- **Port Range（連接埠範圍）**：使用 `-p` 參數
  - 指定要掃描的連接埠
  - 預設掃描 1000 個最常用連接埠
  - 指定特定連接埠可提高隱蔽性並縮短掃描時間
  - 常見目標連接埠：80（Web）、443（HTTPS）、22（SSH）

## 技術組合

- 可以結合不同參數增強隱蔽性
  - 例如：使用 `-T0`（慢速掃描）+ `-sS`（半開放掃描）+ `-p 80`（僅掃描特定連接埠）
  - 組合使用可降低被檢測風險

# Nmap 連接埠狀態

- **Port States**（連接埠狀態）：Nmap 掃描時對主機連接埠狀態的分類
  - 了解這些狀態對網路防禦人員非常重要，可協助識別潛在漏洞

## 基本連接埠狀態

- **Open**（開放）：主機上的應用程式準備接受連線
  - 例如：運行網頁伺服器時，連接埠 80 應為開放狀態以接受客戶端連線

- **Closed**（關閉）：連接埠對探測回應重置封包(Reset Packet)
  - 表示該連接埠沒有應用程式可接受連線
  - 例如：伺服器未運行 Telnet 時，連接埠 23 將顯示為關閉

- **Filtered**（已過濾）：Nmap 無法探測連接埠，但不確定它是否關閉
  - 通常是因為防火牆阻擋了網路或主機掃描
  - 當看到此狀態時，應首先考慮有防火牆在運作

## 進階連接埠狀態

- **Unfiltered**（未過濾）：Nmap 可以探測連接埠但無法確定其開放或關閉狀態
  - 非常罕見，在 Nmap 掃描中不常見到此標記

- **Open/Filtered**（開放/已過濾）：Nmap 無法確定連接埠是開放還是被過濾
  - 在 UDP 或 IP 協議掃描中較為常見
  - 使用 SYN 掃描通常可以更精確地判斷是開放還是被過濾

- **Closed/Filtered**（關閉/已過濾）：在進行 TCP Idle 掃描時無法確定連接埠是關閉還是被過濾
  - 使用 `-TI` 選項進行 TCP Idle 掃描時可能出現

## 對網路防禦的重要性

- 開放連接埠表示主機準備接受連線，可能存在漏洞
  - 某些連接埠開放是預期的（如網頁伺服器的 80 連接埠）
  - 非預期的開放連接埠（如工作站上的 80 連接埠）應視為潛在漏洞

- 連接埠狀態掃描可幫助網路防禦人員：
  - 識別需要進一步調查的潛在問題
  - 強化網路安全性
  - 最小化攻擊面

# Nmap 指紋辨識掃描

- **Fingerprinting**（指紋辨識）：一種技術，用於取得網路上所有資源、主機或系統的清單，以識別可能的攻擊目標
  - 攻擊者使用此技術來了解系統並尋找漏洞進行利用
  - 防禦者需了解同樣的資訊以建立防禦機制

- **Nmap 指紋辨識指令**：
  - **nmap -sV**：執行基本版本偵測掃描
  - **nmap -A**：執行更密集的掃描，發現更多詳細資料

- **指紋掃描可獲取的資訊**：
  - 使用的協議
  - 應用程式名稱和版本
  - 作業系統類型和版本
  - 主機名稱
  - 裝置類型

- **Port States**（連接埠狀態）：
  - open（開啟）
  - closed（關閉）
  - filtered（被過濾）

- **CPE**（Common Platform Enumeration，通用平台列舉）：
  - MITRE 公司開發的識別硬體設備、作業系統和應用程式的機制
  - 是一個不同指紋簽章的資料庫
  - Nmap 比對傳送 SYN 封包後收到的 SYN-ACK 回應，來判斷作業系統和版本
  
- **NSE**（Nmap Scripting Engine，Nmap 腳本引擎）：
  - 允許使用 Lua 腳本語言編寫的腳本進行詳細探測
  - 功能包括：
    - 作業系統偵測和平台列舉
    - Windows 使用者帳號探索
    - 識別登入 Windows 系統的使用者
    - 執行基本弱點偵測
    - 探測網頁伺服器收集 HTTP 資料
    - 識別使用中的網頁應用程式
    - 為 traceroute 探測增加地理位置資訊
  - 腳本可從 nmap.org 獲取，無需自行編寫

# hping

- **Hping**（hping）：一種開源的封包偽造工具，允許測試者創建客製化網路封包，用於突破防火牆和入侵檢測/防禦系統
  - 能夠進行多種功能的網路測試與分析

- **封包構建與操作**（Packet Crafting and Manipulation）：hping 的主要功能，可以自定義封包內容和屬性
  - 常被攻擊者用於繞過網路安全機制

- **主機與端口檢測**（Host and Port Detection）：
  - 使用命令：`hping3 -S -p 80 -c 1 192.168.1.1`
  - 發送一個 SYN 封包到目標 IP 的 80 端口
  - 非常隱蔽的探測方式，只發送單一封包

- **防火牆測試**（Firewall Testing）：
  - 使用命令：`hping3 -A -p 80 -c 1 192.168.1.1`
  - 發送 ACK 封包來測試防火牆規則
  - 可以通過變換封包類型來規避防火牆檢測

- **時間戳記**（Timestamping）：
  - 使用命令：`hping3 -c2 -S -p 80 --tcp-timestamp 192.168.1.1`
  - 確定目標系統的運行時間
  - 長時間運行的伺服器可能未安裝最新補丁（因為重要更新通常需要重啟）

- **路由追蹤**（Traceroute）：
  - 使用任意封包格式（TCP或UDP）執行路由追蹤
  - 當 ICMP 被封鎖時特別有用
  - 可以繞過傳統 traceroute 的限制

- **分段**（Fragmentation）：
  - 通過發送分段封包嘗試繞過 IDS/IPS 和防火牆
  - 利用 TCP 的特性，封包可以任意順序發送，然後在目的地重組
  - 在現代系統中效果有限，因大多數安全設備會先重組封包再檢測

- **阻斷服務攻擊**（Denial of Service）：
  - 能夠從隨機源 IP 執行基於洪水的阻斷服務攻擊
  - 可以製造特定大小的封包（如傳統的「死亡之 Ping」）
  - 在現代系統中大多已經無效，但對舊系統或嵌入式系統可能仍有效

# Angry IP Scanner

- **Angry IP Scanner**：一款開源網路掃描和偵察工具
  - 用於快速掃描 IP 範圍以確定哪些主機處於活動狀態
  - 收集發現主機的相關資訊，如主機名稱、作業系統、開放端口和執行中的服務
  - 這些資訊對識別潛在漏洞和規劃網路保護措施至關重要

- **Reconnaissance and Enumeration**（偵察和列舉）：使用 Angry IP Scanner 的主要用途之一
  - 指在嘗試利用任何漏洞之前，收集有關目標網路的資訊（IP 地址、主機名稱、開放端口等）的過程
  - 網路安全分析師可以快速識別活動主機和開放端口，進一步調查潛在漏洞

- **Rogue Device Detection**（非法裝置檢測）：識別網路上未經授權的裝置
  - 通過定期掃描網路，安全分析師可以識別不應該連接的裝置
  - 例如未經授權的無線存取點或伺服器
  - 有助於在這些裝置被用於未經授權訪問網路之前識別並移除它們

- **OS and Service Information Gathering**（作業系統和服務信息收集）：
  - 收集有關網路上作業系統和執行中服務的資訊
  - 用於識別特定作業系統或服務（如 Windows、Linux、Apache、IIS）的潛在漏洞
  - 例如：發現網路中有主機運行過時版本的 Windows，可以進行更新和修補

- **Ping Sweep**（Ping 掃描）：Angry IP Scanner 的實用功能
  - 一種用於檢測網路上活動主機的技術
  - 通過向每個 IP 地址範圍發送 ICMP 回顯請求包（ping）
  - 如果收到回應，則認為該主機處於活動狀態
  - 是識別網路上活動主機的快速方法

- **Incident Response**（事件響應）：在安全事件處理中的應用
  - 在遏制階段：快速識別受影響的系統和網路段，並將它們與網路其他部分隔離
  - 防止惡意軟體或惡意代碼擴散到其他活動系統

- **Recovery Phase Support**（恢復階段支援）：
  - 在事件響應的恢復階段，幫助恢復正常運作並修復發現的漏洞
  - 通過 Angry IP Scanner 獲得的資訊，確定需要恢復的系統和服務及其順序
  - 最小化對業務運作的干擾

- **Benefits Summary**（效益總結）：
  - 快速識別網路上的活動主機和開放端口
  - 識別非法或未經授權的裝置
  - 收集作業系統和執行中服務的資訊
  - 執行 ping 掃描
  - 協助事件遏制和恢復階段
  - 有效識別和應對安全事件
  - 最小化對業務運作的影響
  - 將運作恢復正常

# Maltego

- **Maltego**：一種開源工具，廣泛用於資料挖掘、情報收集和列舉
  - 用於從各種來源收集、分析和視覺化數據，包括社交媒體、DNS 和 whois 查詢
  - 主要目標是提供特定領域資料的概覽，以識別模式或潛在威脅

- **主要應用場景**：
  - 滲透測試中的偵察和列舉階段
  - 識別網路中不同實體之間的關係
  - 追蹤域名所有權和註冊信息
  - 分析社交媒體資料
  - 整合自訂資料源和企業內部系統

- **資料收集功能**：
  - 可收集 IP 位址、主機名、開放端口等網路信息
  - 能識別 IP 位址、電子郵件、域名之間的關聯性
  - 能從 whois 記錄和域名註冊資料中提取信息
  - 可收集和分析來自 Twitter、Facebook、LinkedIn 等社交媒體的資料

- **視覺化呈現**：
  - 以圖形或視覺方式表示收集到的資料
  - 幫助分析人員更好地識別模式、連結和潛在威脅
  - 以圖形化方式顯示組織內部的領導關係

- **Transforms**（轉換器）：
  - Maltego 允許整合自訂轉換器和專有資料源
  - 組織可開發轉換器來獲取內部系統的資訊（如工單系統或資產管理工具）
  - 使工具更加靈活，能夠滿足組織特定需求

- **作為網路安全分析工具的優勢**：
  - 能從多種來源收集和分析資料
  - 以圖形連接格式呈現資訊，便於視覺化分析
  - 協助識別模式、連結和潛在威脅
  - 靈活性強，可根據組織需求整合不同資料源

# Responder

- **Responder**：Kali Linux 開源滲透測試系統中的命令行工具
  - 用於毒化 NetBIOS、LLMNR 和 MDNS 名稱解析請求的回應
  - 目的是執行中間人攻擊（man-in-the-middle attack）
  - 設計用於攔截這些訊息和請求，並將攻擊者主機的 IP 回傳作為記錄名稱

- **攻擊運作原理**：
  - 受害系統必須被誘導查詢不存在的名稱，或被阻止使用合法的 DNS 服務
  - Windows 系統在無法連接 DNS 服務時，會向網路中其他主機查詢該 DNS 名稱
  - Responder 會回應這些查詢，提供攻擊者的 IP 地址
  - 使受害者連接到攻擊者的主機，形成中間人攻擊

- **滲透測試應用**：
  - 可用於實現中間人攻擊
  - 特別適用於 Windows 檔案共享或 SMB（Server Message Block）訊息
  - 允許攻擊者擷取密碼雜湊值，以便後續破解

- **防禦者應用**：
  - 可設置為分析模式（analysis mode）
  - 在不回應網路請求的情況下監控名稱解析流量
  - 可檢測網路內是否有其他人嘗試毒化名稱解析服務

# 無線網路評估工具

- **Wireless Assessment Tools（無線網路評估工具）**：用於檢測無線網路存在、識別其安全類型與設定，以及嘗試利用安全弱點獲取未授權網路存取的工具。
  - 這些工具對網路防禦人員非常重要，因為無線網路是企業網路中最脆弱的部分之一
  - 攻擊者只需靠近建築物，將網卡切換到監聽模式（Monitor Mode）或混雜模式（Promiscuous Mode），即可嗅探非單播流量並收集資料，用於破解網路密碼

## 主要工具套件

- **Aircrack-ng**：專為無線網路安全測試設計的工具套件，包含四個主要工具：
  - **Airmon-ng**：啟用或停用網卡的監聽模式
  - **Airodump-ng**：捕獲無線訊框，識別基於 MAC 位址的無線存取點和用戶端資訊
  - **Aireplay-ng**：注入訊框執行攻擊，獲取存取點的認證憑證（如取消用戶認證，並在重新認證時捕獲資訊）
  - **Aircrack-ng**：提取認證金鑰並嘗試獲取網路密碼的明文版本
  - 此工具對使用 WEP 安全協定的網路最有效，但對於使用長而強密碼的 WPA/WPA2 網路，暴力破解將耗時很久
  - 緩解方式：在家庭環境中使用長而強的密碼；在企業環境中使用 RADIUS 認證（透過數位憑證認證）

- **Reaver**：命令列工具，用於對啟用 WPS 的存取點執行暴力破解攻擊
  - **WPS（Wi-Fi Protected Setup）**：讓使用者能夠輕鬆將設備連接到無線網路的機制（按下路由器和設備上的 WPS 按鈕，它們會自動通訊並配置）
  - WPS 使用 8 位數的 PIN 碼，實際上是分為兩組 4 位數
  - 由於只需嘗試 10,000 + 10,000 = 20,000 種組合，暴力破解只需幾小時
  - 緩解方式：啟用 PIN 認證的速率限制（在嘗試之間增加延遲），但最佳做法是完全禁用 WPS

## 安全建議

- 使用長而強的密碼，特別是在家庭環境中
- 在企業環境中使用 RADIUS 認證代替密碼認證
- 在所有網路上禁用 WPS，因為它是重大的安全漏洞

# Hashcat

- **Hashcat**（哈希破解工具）：一種命令列工具，用於對密碼哈希執行暴力破解和字典攻擊
  - 專門用於破解如網路收集的哈希值或無線網路密碼
  - 現代版本可利用 GPU 而非 CPU 進行哈希破解，大幅提升效能

- **GPU 加速**（圖形處理單元加速）：Hashcat 使用 GPU 進行密碼破解的技術
  - GPU 專為複雜數學運算設計，處理哈希破解的效率遠高於 CPU
  - 實例：2012 年一個包含 25 個 GPU 的系統能每秒處理 3480 億個哈希值
  - 主要用於破解 LANMAN 和 NTLM 等較舊的哈希算法

- **現代哈希算法**（Modern Hash Algorithms）：如 SHA256 等現代哈希算法對暴力破解更具抵抗力
  - 但仍可能被具有足夠 GPU 運算能力的系統破解
  - 這是資安產業持續關注的威脅

- **Hashcat 使用方法**：基本命令格式
  - 語法：`hashcat -m [哈希類型] -a [攻擊模式] -o [輸出檔案] [哈希輸入檔案]`
  - 哈希類型例如：MD5
  - 攻擊模式：暴力破解或字典攻擊
  - 破解速度：普通筆電上也能達到每秒 364,000 個哈希嘗試
