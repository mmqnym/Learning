# 主機相關入侵指標分析

- **Host-related IOC**（主機相關入侵指標）：用於檢測工作站和伺服器內惡意活動的跡象

## 主要入侵指標類型

- **Malicious processes**（惡意程序）：在系統上運行的可疑或未經授權的處理程序

- **Memory forensics**（記憶體鑑識）：分析系統記憶體中的資料以發現惡意程式的痕跡

- **Processor consumption**（處理器使用率）：分析 CPU 使用情況，識別異常的資源消耗

- **Disk/file system consumption**（磁碟/檔案系統使用情況）：分析儲存空間使用的異常狀況

- **Unauthorized privileges**（未經授權的權限）：識別系統中權限使用的異常狀況

- **Unauthorized software**（未經授權的軟體）：檢測並識別系統上未經批准安裝的應用程式

- **Unauthorized changes/hardware**（未經授權的變更/硬體）：偵測系統或硬體配置的未授權修改

- **Persistence**（持續性）：識別攻擊者用來維持對系統長期控制的技術

# Host-related IOCs（主機相關的入侵指標）

- **Host（主機）**：在本課程中主要關注：
  - Windows 為主的電腦、筆記型電腦和平板電腦
  - 部分包含 Linux 系統
  - 主要針對企業環境中的工作站和伺服器
  - 行動裝置 IOCs 將在後續章節單獨討論

- **主機相關 IOCs 可協助識別**：
  - 主機上惡意軟體的存在
  - 未授權的帳戶和權限建立
  - 檔案是否被存取或外洩

- **主機 IOCs 分析的主要範疇**：
  - 系統記憶體分析
  - 檔案系統分析
  - 作業系統日誌分析

# 惡意程序分析

- **Malicious Process**（惡意程序）：未經系統擁有者授權執行、目的在於損害或入侵系統的程序
  - 通常是惡意代碼的執行結果
  - 在 Windows 中，惡意代碼常被注入到合法程序中，形式為動態連結庫（DLL）
  - 在 Linux 中，惡意代碼則使用共享對象（Shared Objects，.so 檔案）

- **Abnormal Process Behavior**（異常程序行為）：表明合法程序被惡意代碼感染，目的在於損害或入侵系統
  - 跡象包括：未經授權更改登錄檔、存取臨時位置的資料檔案、進行惡意網路活動（如信標通訊、C2 連線）、連接未知的 DNS 解析器、使用隱蔽通道等

- **Baseline**（基準）：了解系統正常狀態的重要工具
  - 應在系統乾淨時建立，尤其在系統尚未連網時
  - 有助於快速識別可疑程序

## Windows 系統工具

- **System File Checker (SFC)**：掃描系統檔案，確保未被修改
  - 透過檢查數位簽章確認檔案完整性

- **Process Monitor & Process Explorer**：來自 Sysinternals 工具套件
  - 用於即時分析和記錄系統執行的程序

- **Tasklist**：命令列版本的工作管理員
  - 顯示記憶體使用量、執行緒狀態、程序樹和各程序的操作

- **PE Explorer**：專有軟體，可分析 Windows 可執行檔結構
  - 有助於深入檢視程序呼叫關係，特別是 DLL 呼叫

## Linux 系統工具

- **Daemon**（守護程序）：Linux 系統中的背景服務
  - 程序名稱通常以字母 d 結尾，如 httpd、sshd、ftpd

- **systemd**：Linux 系統啟動時由核心首先執行的守護程序
  - 擁有程序 ID (PID) 為 1

- **PID (Process ID)**：Linux 系統中程序的唯一識別碼
  - 用於識別和必要時終止程序

- **PPID (Parent PID)**：每個程序的父程序識別碼
  - 顯示程序的層級關係

- **pstree**：Linux 命令，顯示系統中所有程序的父子關係
  - 展示程序間的繼承關係和層級結構

- **ps**：Linux 命令，列出當前程序的屬性
  - 默認只顯示當前用戶啟動的程序
  - ps -A 或 ps -e：顯示所有用戶的所有運行程序
  - ps -C [命令]：顯示特定命令的程序
  - 可搭配排序命令使用：ps -A | sort -k3（按執行時間排序）

- **Linux Shared Objects (.so)**：Linux 系統中的共享函式庫
  - 等同於 Windows 的 DLL
  - 是惡意代碼注入的常見目標，安全人員應加強這方面的知識

# 記憶體鑑識

- **Memory forensics**（記憶體鑑識）：分析系統記憶體內容以發現惡意軟體和行為的技術
  - 現代許多惡意軟體使用無檔案（fileless）技術，將程式碼儲存於記憶體中

- **Fileless malware**（無檔案惡意體）：直接在記憶體中執行而不儲存到檔案系統的惡意軟體
  - 即使需要寫入檔案系統，也會盡快刪除痕跡
  - 使得傳統的基於檔案掃描的偵測技術難以發現威脅

- **Fileless detection techniques**（無檔案偵測技術）：需要分析系統記憶體內容和程序行為的技術
  - 不依賴於檔案系統掃描
  - 使用特殊技術來尋找惡意軟體

- **Memory analysis techniques**（記憶體分析技術）：允許分析師進行以下工作：
  - 逆向工程程序使用的程式碼
  - 發現程序如何與檔案系統互動（稱為 handles）
  - 檢視程序與登錄檔的互動
  - 檢查網路連線
  - 擷取加密金鑰
  - 從記憶體中提取字串

- **Memory dump**（記憶體轉儲）：記憶體分析的基礎資料來源
  - 可從中提取各種資訊，如通訊內容、程序活動等
  - 例如：從 Skype 通話的記憶體中提取訊息內容

- **商業鑑識工具**：
  - **FTK**（Forensic Toolkit）和 **EnCase**：商業專屬的鑑識套件
  - 包含記憶體分析模組，可收集記憶體並分析各種成品

- **開源鑑識工具**：
  - **Volatility Framework**（記憶體鑑識框架）：開源記憶體鑑識工具
    - 提供多種分析模組：網頁瀏覽器歷史、命令提示字元歷史等
    - 具有文字命令列介面
    - 主要模組包括：
      - `pslist`：列出執行中的程序
      - 檔案分析模組：檢查程序存取的檔案
      - `netscan`：檢查網路連線活動
  
  - **Memoryze**（由 FireEye 開發）：免費記憶體鑑識工具
    - 幫助事件應變人員在即時記憶體中找出惡意活動
    - 提供比 Volatility Framework 更清晰的介面

- **可疑活動識別關鍵點**：
  - 不尋常的程序名稱（與基準線比對）
  - 可疑的檔案名稱（如隨機數字命名的檔案）
  - 可疑的網路連線（特別是對外連接）

# 資源消耗分析

- **Resource Consumption**（資源消耗）：監控系統資源使用量的過程，可作為惡意活動的關鍵指標。
  - 大量資源使用並不一定代表惡意行為，合法軟體也會有高資源消耗的情況。
  - 觀察基準線（正常使用情況）對比當前使用情況，有助於判斷是否可疑。

- **Processor Usage**（處理器使用率）：每個程序層級所使用的CPU時間百分比。
  - 監控個別處理程序而非整體應用程式，以便識別單一被感染的程序。

- **Memory Consumption**（記憶體消耗）：每個處理程序層級所使用的記憶體量。
  - 記憶體使用異常可能表示惡意活動。

## Windows資源監控工具

- **Task Manager**（工作管理員）：Windows內建工具
  - 可顯示應用程式清單、CPU使用率及記憶體使用量
  - 可依不同欄位排序（CPU或記憶體使用率）以找出最大的資源消耗者

## Linux資源監控工具

- **free**：顯示可用、已用和可自由使用的記憶體摘要的命令。
  - 輸出包含實體記憶體和交換檔案（swap file）的使用情況。

- **top**：產生所有執行中處理程序的可捲動表格的命令，會持續重新整理以顯示最新統計資料。
  - 顯示PID（處理程序ID）、使用者、CPU百分比、記憶體百分比和執行時間等資訊。

- **htop**：top的改進版本
  - 提供滑鼠支援及更易讀的輸出界面
  - 具有圖形化顯示和顏色區分
  - 提供記憶體和CPU使用率的視覺化圖形
  - 易於依不同欄位（如PID、CPU或記憶體）進行排序

## 記憶體問題分析

- **Memory Overflow**（記憶體溢位）：一種利用應用程式中漏洞執行任意程式碼或使處理程序當機的方式。

- **Memory Leak**（記憶體洩漏）：程式設計上未正確釋放記憶體造成記憶體不足的問題，累積下來可能導致整個系統當機。

- **測試記憶體溢位問題的方法**：
  - 在沙盒除錯環境中執行程式碼
  - 觀察行為並識別特徵（signature）

- **NOP Sled**（空操作滑梯）：緩衝區溢位攻擊中常見的技術
  - NOP指令告訴電腦不做任何事，僅移至下一個記憶體位置
  - 攻擊者透過NOP sled引導執行流程到包含惡意shell code的記憶體位置

- **Denial of Service**（拒絕服務攻擊）：旨在關閉機器或網路，使其無法用於預期目的的攻擊。
  - 透過消耗大量系統資源阻止合法使用
  - 可透過導致應用程式溢出記憶體緩衝區來觸發執行失敗
  - 可能導致程式崩潰或系統崩潰

# 磁碟與檔案系統安全分析

- **Disk and File Systems IOC**（磁碟和檔案系統入侵指標）：即使是無檔案惡意軟體也可能在檔案系統上留下元數據。
  - 分析磁碟和檔案系統可發現惡意活動痕跡

## 暫存區域

- **Staging Area**（暫存區域）：攻擊者準備資料外洩前的資料收集位置。
  - 常見暫存位置包括：
    - 臨時檔案或資料夾
    - 使用者設定檔位置
    - 偽裝成日誌的資料
    - 替代資料流（ADS）
    - 回收筒中的檔案
  - 通常攻擊者會先壓縮或加密資料後放入暫存區，這是常見的IOC

## 替代資料流

- **Alternate Data Streams (ADS)**（替代資料流）：NTFS檔案系統內建功能，允許在一個檔案中隱藏其他資料。
  - 替代資料流內容在標準目錄列表中不可見
  - 可透過特殊命令語法存取：`文件名:數據流名稱`
  - 攻擊者常用來隱藏資料
  - 檔案大小通常顯示為0位元組，因主檔案本身不含資料
  - 可用特殊工具掃描整個硬碟或檔案共享以識別所有替代資料流

## 檔案系統分析工具

- **File System Viewer**（檔案系統檢視器）：能夠搜尋檔案系統關鍵字的工具。
  - 可檢查系統區域如回收筒、NTFS陰影複製與系統磁碟區
  - 分析檔案元數據以重建事件時間線
  - 可顯示系統隱藏檔案，如以$開頭的陰影檔案

- **DIR命令進階用法**：
  - `dir/Ax`：篩選特定檔案類型 (x為變數，如H代表隱藏檔案)
  - `dir/Q`：顯示檔案擁有者，有助識別檔案所有權變更
  - `dir/R`：顯示檔案的替代資料流

## 硬碟容量異常

- **驅動器容量消耗**：硬碟突然填滿可能是攻擊者準備資料外洩的跡象。
  - 惡意軟體可能在本地快取檔案以便後續外洩
  - 透過網路或USB設備將資料從目標系統取出

- **Disk Utilization Tools**（磁碟使用率工具）：掃描檔案系統並提供統計資料。
  - 提供儲存空間的視覺化表示
  - 顯示目錄列表
  - 實時監控磁碟寫入資料

## Linux檔案系統分析工具

- **lsof**：列出當前開啟的所有檔案。
  - 在Linux中一切皆被視為檔案（包括文件、資料夾、磁碟、印表機等）
  - 示例: `lsof -u root -a p 1645` 顯示root用戶使用進程ID 1645開啟的所有檔案

- **df**：檢索所有掛載檔案系統的磁碟空間使用情況。
  - 適合檢查整個磁碟空間使用情況

- **du**：檢索特定目錄使用的磁碟空間。
  - 示例: `du /var/log` 顯示log目錄使用的空間大小
  - 適合檢查特定目錄的空間使用情況

## 加密分析

- **Cryptographic Analysis Tools**（加密分析工具）：用於分析加密檔案。
  - 協助確定使用的加密算法
  - 評估加密金鑰的強度
  - 攻擊者使用加密來保護竊取的數據
  - 作為分析師，需要恢復或暴力破解密碼以獲取解密金鑰
  - 若無法取得金鑰，加密檔案實際上無法還原或分析

# 未授權特權與權限提升

- **Privilege Escalation**（權限提升）：利用作業系統或應用程式的漏洞，獲取比原本設計意圖更高權限的行為
  - 通常在初始入侵後進行，例如釣魚攻擊取得普通用戶帳號後，攻擊者會嘗試提升權限
  - 攻擊者目標是獲取 Linux 系統的 root 權限或 Windows 系統的 admin 權限

## 監控授權與認證系統的五個重點

- **Unauthorized Sessions**（未授權工作階段）：監控帳戶是否存取了不該有權限的裝置或服務
  - 例如：人力資源部門的用戶嘗試存取會計部門的系統
  
- **Failed Log-ons**（登入失敗）：嘗試使用錯誤的用戶名和密碼組合進行認證
  - 單次錯誤可能只是用戶打錯密碼
  - 多次重複嘗試錯誤的用戶名和密碼可能表示密碼猜測或暴力破解攻擊

- **New Accounts**（新帳戶）：監控系統中的新帳戶建立
  - 攻擊者可能創建新的管理員帳戶以獲得完整的系統存取權限
  - 分析師應定期檢查帳戶並確認其創建是否經過授權

- **Guest Account Usage**（訪客帳戶使用）：監控訪客帳戶的使用情況
  - 訪客帳戶可能被攻擊者用來登入網域並進行網路偵察
  - 攻擊者可收集網路上的裝置、軟體和用戶等資訊用於後續攻擊

- **Off-hours Usage**（非工作時間使用）：在正常工作時間以外使用帳戶的行為
  - 可能表示攻擊者在組織警覺性較低時進行攻擊
  - 例如：員工通常在早上 9 點到下午 5 點工作，但帳戶在凌晨 1-2 點活動

## 未授權特權的檢測工具

- **Microsoft Policy Analyzer**（微軟政策分析器）：識別政策是否偏離設定基準
  - 確保安全政策在所有系統中有效實施

- **AccessChk and AccessEnum**（存取檢查和存取列舉）：Sysinternals 套件的工具
  - 分析套用在資源或檔案上的權限
  - 透過審計日誌驗證正確的權限設置
  - 檢查攻擊者是否修改了檔案權限

# 未授權軟體與惡意程式指標

- **Unauthorized Software**（未授權軟體）：指不應出現在系統中的軟體，是最常見的入侵指標(IOC)之一
  - 可能是蠕蟲病毒、電腦病毒、特洛伊木馬或其他類型的惡意程式
  - 收到惡意軟體警報時，表示系統中存在不應有的東西

- **軟體型入侵指標**（Software-based IOCs）：不只包括明顯的惡意程式，還包括系統上存在的攻擊工具
  - 許多攻擊工具同時也被系統管理員使用，如 Netcat、Nmap 和 Wireshark
  - 關鍵是確定這些工具是否獲得授權使用，未授權的工具可能表示系統已被攻擊者入侵

- **未授權的合法軟體**（Unauthorized legitimate software）：使用者未經許可安裝的合法軟體
  - 例如：使用者自行購買並安裝 Adobe Acrobat 或 Microsoft Visio
  - 即使軟體本身無害，但會引入新的漏洞，因為：
    - 管理員無法跟蹤並更新這些軟體
    - 可能沒有有效的授權許可
    - 無法確保安全性更新

- **未授權服務**（Unauthorized services）：使用者在工作站上安裝的不適當服務
  - 例如：Apache 網頁伺服器可能被授權在網頁伺服器上使用，但不適合安裝在一般工作站上
  - 這類未授權服務會帶來重大安全漏洞

- **被修改的正常檔案**（Modified normal files）：攻擊者可能修改正常檔案用於惡意目的
  - 例如：修改 host 檔案（本地 DNS）以重定向網站流量
  - 系統會優先信任 host 檔案而非 DNS 伺服器，攻擊者可藉此繞過 DNS 查詢

- **應用程式查看器**（Application viewers）：用於分析各種應用程式和檔案格式的工具
  - 多數鑑識工具包（如 Encase）可讀取不同的檔案格式
  - 可分析瀏覽器歷史記錄、cookies、聯絡人資料庫、電子郵件信箱、VoIP 通話歷史等

- **Prefetch 檔案**（Prefetch files）：記錄應用程式執行資訊的檔案
  - 包含已執行應用程式的名稱、日期和時間、檔案路徑、執行次數
  - 還記錄可執行檔使用的 DLL
  - 為資安分析師提供豐富的資訊來源，有助於惡意程式分析

- **Shimcache**（相容性快取）：儲存在登錄檔中的應用程式使用快取
  - 位置：HKLM/SYSTEM/CurrentControlSet/Control/SessionManager/AppCompatCache/AppCompatCache
  - 作為建立事件時間表的重要資料來源

- **Amcache**（應用程式快取）：儲存為 hive 檔案的應用程式使用快取
  - 位置：C:/Windows/appcompat/Programs/Amcache.hve
  - 不能使用 regedit 開啟，需要使用專業鑑識工具如 Encase 和 FTK 檢視

# 未經授權的變更／硬體

- **Unauthorized change**（未經授權變更）：任何在未經適當授權或未經過變更管理流程的情況下，對配置檔案、軟體設定檔或硬體所做的修改
  - 可能發生在軟體或硬體層面
  - 典型例子：未經許可安裝軟體

- **Unauthorized hardware**（未經授權硬體）：未經許可連接到系統的硬體裝置
  - 常見例子：USB隨身碟
  - 違反組織安全政策的硬體連接會被視為安全威脅

- **USB Firmware Reprogramming**（USB韌體重編程）：攻擊者可重新編程USB裝置的韌體，使其呈現為不同類型的裝置
  - USB隨身碟可被改裝成模擬鍵盤或其他人機介面裝置(HID)
  - 能夠向操作系統發送按鍵指令，成為惡意軟體感染途徑

- **USB安全建議**：
  - 高安全性環境應禁止使用USB隨身碟
  - 若必須使用，應有專門流程進行掃描和檢查
  - 可將可疑硬體連接到沙盒(sandbox)環境中進行分析
  - 沙盒環境可隔離潛在威脅，防止惡意程式擴散到網路中

# 持續性威脅指標

- **Persistence**（持續性）：威脅行動者維持對目標主機或網路的隱蔽訪問能力
  - 攻擊者入侵網路後持續停留的方式
  - 通常透過修改登錄檔或系統排程任務來實現
  - 安全分析師應檢查這兩個區域尋找異常或持續性跡象

## 登錄檔分析

- **Registry**（登錄檔）：Windows 的階層式資料庫，儲存作業系統低階設定
  - 包含核心、裝置驅動程式、服務、安全帳戶管理器和使用者介面的設定
  - 基本上是系統及其所有活動的大型知識資料庫

- **Registry Viewer**（登錄檔檢視器）：從映像中提取 Windows 登錄檔並顯示的工具
  - 可在分析工作站上查看登錄檔內容
  - EnCase 或 FTK 等鑑識工具也可用於檢視登錄檔

- **Regedit**（登錄檔編輯器）：Windows 內建的登錄檔檢視工具
  - 缺點：預設不顯示值的最後修改時間，不利於建立事件時間軸
  - 不建議用於鑑識分析

- **Regdump**：將登錄檔內容匯出為簡單格式的文字檔
  - 可使用 find 命令搜尋特定字串
  - Linux 系統可用 grep 搜尋內容

## 自動執行機制

- **Autorun Keys**（自動執行機碼）：攻擊者用來獲取持續性的重要機制
  - **Run**：開機時異步載入值（不按特定順序執行）
  - **RunOnce**：開機時按順序載入值（總是按相同順序執行）

- **重要的自動執行機碼位置**：
  - HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
  - HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
  - HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
  - HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce

- **驅動程式和服務登錄項目**：
  - 常見的惡意軟體修改位置
  - 位於 HKLM\SYSTEM\CurrentControlSet\Services

- **檔案關聯修改**：惡意軟體可能改變常見可執行檔的關聯（EXE、BAT、COM、CMD）
  - 檔案關聯位於：
    - HKEY_CLASSES_ROOT (HKCR)
    - HKLM\SOFTWARE\Classes
    - HKCU\SOFTWARE\Classes

- **最近使用檔案記錄**：
  - 位於 HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\RunMRU
  - 有助於建立事件時間軸並識別執行順序

## 排程任務分析

- **Windows Task Scheduler**（工作排程器）：允許在預定時間執行新任務
  - 攻擊者可利用排程任務達到持續性目的
  - 安全分析師應檢查排程任務清單
  - 可檢視任務歷史記錄以確定執行時間和事件

- **Crontab**（Linux 排程工具）：Linux 系統中的排程機制
  - Cron Jobs 是 Linux 中排程任務的等效項
  - 使用 `crontab -l` 命令可列出所有當前排程任務
  - 用於檢查是否有可疑的定期執行任務

## 分析最佳實踐

- **Known Good Baseline**（已知良好基準）：登錄檔的基準設定
  - 比較已知的良好基準與目前值可識別是否被篡改
  - 可使用專用工具或進行簡單比較來發現差異

- **實際應用重點**：
  - 登錄檔分析應尋找 Run 和 RunOnce 機碼的異常
  - 排程任務檢查應找出可疑或未知的排程作業
  - 持續性攻擊主要通過登錄檔和排程任務實現