# 橫向移動和跳板攻擊偵測與分析

- **Lateral Movement（橫向移動）**：攻擊者在網路內部從一個系統移動到另一個系統的技術
  - 用於在入侵後擴大攻擊範圍
  - 通常在初始入侵點後的階段進行

- **Pivoting（跳板攻擊）**：攻擊者利用已被攻陷的系統作為跳板，攻擊其他無法直接訪問的系統
  - 使攻擊者能夠繞過防火牆等安全措施
  - 常見於分段網路環境中

- **常見的橫向移動和跳板攻擊技術**：
  - **Pass the Hash（傳遞雜湊攻擊）**：攻擊者竊取密碼雜湊值並重複使用，無需知道明文密碼
  - **Golden Ticket（黃金票證攻擊）**：攻擊者創建偽造的Kerberos票證以獲取持久性網域訪問權限

- **學習目標**：
  - 識別工作站和伺服器中的橫向移動跡象
  - 分析潛在惡意活動的指標
  - 熟悉各種橫向移動和跳板攻擊技術及其偵測方法

# 橫向移動與跳板攻擊

- **Lateral Movement（橫向移動）**：攻擊者在網路中逐步移動以搜尋關鍵數據和資產的技術。
  - 類似美式足球中的「側向傳球」，不直接向前推進，而是移至新位置尋找機會
  - 目標是尋找更多方式達成最終攻擊目標
  - 攻擊者通常會先控制一個系統（如無線用戶端），然後開始搜尋網路中的其他目標

- **橫向移動的偵測方法**：
  - 識別不規則的點對點通訊
  - 注意攻擊者獲取初始入口點後的搜索行為

- **Pivoting（跳板攻擊）**：利用一台已被感染的電腦來攻擊不同的電腦。
  - 使用已被入侵的系統攻擊同一網路上的其他系統
  - 目的是繞過防火牆等安全限制，避開從外部直接攻擊的障礙
  - 與橫向移動概念相關但不同，雖然安全專業人員常互換使用這兩個術語

- **兩者區別**：
  - 橫向移動：在網路中尋找並移動到新的系統
  - 跳板攻擊：使用一個已控制的系統作為攻擊其他系統的跳板

# Pass the Hash 攻擊

- **Pass the hash**（傳遞雜湊攻擊）：一種網路攻擊手法，攻擊者竊取雜湊過的用戶憑證，並直接使用這些雜湊值在原始網路上進行身分驗證
  - 攻擊者不需要知道或破解原始密碼，只需要取得密碼的雜湊值
  - 可用於驗證 Windows 網路上的 SMB 或 Kerberos 等協議

## 攻擊流程

- **正常登入流程**：
  - 用戶首次登入時，域控制器（DC）使用 Kerberos 驗證用戶名稱和密碼（實際是密碼雜湊）
  - 第二次登入時，系統使用工作站 SAM 中存儲的快取憑證，不需再訪問域控制器

- **攻擊流程**：
  - 攻擊者通過某種漏洞獲取對工作站的訪問權限
  - 轉儲 SAM（Security Account Manager）以獲取快取的憑證
  - 使用這些雜湊值登入同一台電腦或網域中的其他電腦

## 攻擊工具

- **Mimikatz**（密碼提取工具）：開源應用程式，允許查看和保存認證憑證以執行傳遞雜湊攻擊
  - 通過掃描系統記憶體尋找快取密碼
  - 這些密碼已被本地安全授權子系統服務（lsass.exe）處理
  - Mimikatz 已被整合到許多滲透測試工具中，例如 Metasploit Framework

## 威脅與影響

- **權限提升**：攻擊者可以獲取本地管理員權限，因為管理員曾在工作站上本地登入
  - 憑證存儲在 SAM 中，攻擊者可以轉儲並獲取

## 偵測與緩解方法

- **偵測挑戰**：
  - 極難區分攻擊者活動和合法身份驗證
  - 竊取的憑證允許攻擊者使用標準身份驗證機制，產生看似合法的審計日誌

- **緩解方法**：
  1. 使用防毒和反惡意軟體來阻止 Mimikatz 等工具
  2. 限制和保護高權限域帳戶（域管理員帳戶應只登入域控制器）
  3. 限制和保護具有管理權限的本地帳戶
  4. 使用 Windows 防火牆限制對工作站的入站流量
  5. 針對特定應用（如技術支援、安全合規掃描器等）設置例外

- **IDS 規則偵測**：
  - 可以監控 Windows 事件 ID 4624（成功登入）和 4625（登入失敗）
  - 關注網路型登入（登入類型 3）和 NTLM 認證套件
  - 實用性有限，可能產生大量誤報
  - 更適合用於事後分析和建立事件時間軸

# Golden Ticket 攻擊

- **Golden Ticket**（黃金票證）：在 Active Directory 環境中具有特權的 Kerberos 票證，能夠授予使用者對網域中資源的管理員存取權限
  - 類似於「查理與巧克力工廠」中的黃金票證，是一種通用萬能鑰匙
  - 可以授予對域內成員和域控制器的管理存取權

- **Kerberos ticket-granting ticket hash**（Kerberos 票證授予票證雜湊值）：Active Directory 域信任錨點
  - 功能類似於根憑證授權機構的私鑰
  - 用於生成使用者存取網路服務時所需的票證授予票證（TGT）

- **Kerberos 身分驗證流程**：
  - 客戶端（用戶或服務）向 KDC（金鑰分發中心）發送身份驗證請求
  - KDC 為客戶端創建票證授予票證（TGT）
  - KDC 使用客戶端密碼作為金鑰加密 TGT 並將其返回給客戶端
  - 客戶端使用自己的密碼嘗試解密 TGT
  - 若成功解密，表明客戶端提供了正確的密碼，完成身份驗證
  - 向 TGS（票證授予伺服器）請求服務票證（Service Ticket）
  - 使用服務票證向對應服務發起請求

- **Golden Ticket 攻擊流程**：
  - 在每一個 Active Directory 網域中，都有一個內建的、預設被停用的特殊帳戶，叫做 `krbtgt`。這個帳戶的密碼雜湊值 (NTLM Hash)，就是整個 Kerberos 系統的「萬能鑰匙」。KDC (特別是 TGS) 就是用這個 `krbtgt` 的密碼雜湊值作為密鑰，來加密和解密所有合法的 TGT。
  - 攻擊者必須先透過其他手段，獲得網域最高權限，即取得網域控制器 (Domain Controller) 的管理員權限。這是發動黃金票證攻擊的先決條件。
  - 一旦控制了網域控制器，攻擊者就可以使用 `Mimikatz` 之類的工具，從記憶體 (LSASS 程序) 中匯出 `krbtgt` 帳戶的密碼雜湊值。
  - 此時攻擊者等同於偷到了 TGS 用來驗證所有 TGT 的金鑰，可以用來取得網域內任何服務的票證。

- **風險性**：
  - 允許攻擊者輕鬆橫向移動到整個域
  - 即使使用者重設密碼，如果未重設 Kerberos ticket-granting ticket 雜湊值，攻擊者仍能保持存取權

- **防禦措施**：
  - 定期重設 Kerberos ticket-granting ticket 帳戶密碼
  - 若懷疑遭受攻擊，需在短時間內重設該密碼兩次以使黃金票證失效
    - 變更密碼 → 重新啟動電腦 → 再次變更密碼 → 重新啟動電腦
  - 這樣可撤銷所有現有黃金票證，確保新票證使用新密碼生成

- **偵測方法**：
  - 早期 Golden Ticket 程式會在域名欄位留空，這是一個可識別的特徵
  - 較新的 Golden Ticket 程式已修正此問題，現在會包含域名
  - 查看 Windows 事件日誌中的登入和登出事件，檢查缺少域名的帳戶活動

# 橫向移動（Lateral Movement）技術

- **Lateral Movement**（橫向移動）：攻擊者在入侵網路後，在不同主機間移動以擴大控制範圍的技術
  - 通常是利用已獲得的憑證或漏洞在網路內部進一步擴展攻擊面

## 常見橫向移動技術

- **使用弱密碼**（Weak Passwords）：最常見的橫向移動方式之一
  - 即使在大型組織中，許多員工仍使用簡單密碼如「12345」
  - 常見不安全密碼模式包括：鍵盤排列（如「QWERTYUIOP」）和鍵盤走位（如「!QAZxcde32ws」）
  - 應定期檢查員工密碼安全性，特別是管理員帳號

- **遠端存取服務**（Remote Access Services）：讓使用者能從遠端存取網路資源的工具
  - 包括 VPN、SSH、Telnet、RDP（遠端桌面協定）和 VNC 等服務
  - 隨著遠端工作增加，這些服務成為攻擊者的主要目標

- **WMIC**（Windows Management Instrumentation Command-Line）：Windows 管理工具命令列
  - 提供管理員執行腳本管理電腦的終端介面
  - 攻擊者可利用它執行高權限程序
  - 能夠進行關鍵的遠端偵察，包括查看系統進程、磁碟分區和 BIOS 資料

- **PsExec**：作為 Telnet 替代方案的工具
  - 屬於 Sysinternals 工具套件（由 Mark Russinovich 開發）
  - 利用 Windows SYSTEM 帳戶進行權限提升
  - 攻擊者可用它開啟後門、執行程序和跨網路提升權限

- **Windows PowerShell**：Microsoft 的任務自動化和設定管理框架
  - 由命令列 Shell 和相關腳本語言組成
  - 攻擊者開發了專用工具包如 PowerShell Empire
  - PowerShell Empire 包含眾多預建攻擊模組（如範例中提到的 91 個模組）
  - 具有原生 Cmdlet 和執行各種遠端存取、WMIC 和 PsExec 工具的能力

# Pivoting

- **Pivoting**（跳板攻擊）：攻擊者利用一台已被入侵的主機作為平台，從而向網路中其他點擴散攻擊
  - 與 Lateral Movement（橫向移動）不同，但在實務上常被資安專業人員互換使用
  - 關鍵差異：跳板攻擊是從已建立的攻擊點發動後續攻擊

- **Lateral Movement**（橫向移動）：攻擊者從一台主機跳到另一台主機，尋找可利用的漏洞
  - 側重於在網路中的水平探索過程
  - 與跳板攻擊概念不同，但在實務中常被混用

- **Port Forwarding**（連接埠轉發）：跳板攻擊的主要技術
  - 允許攻擊者使用主機作為跳板，通過開放的 TCP 連接埠將流量從一個主機傳送到另一個不同子網路的主機
  - 例如：設置 RDP (3389) 連接埠轉發，通過中間主機連接到無法直接訪問的目標

- **攻擊場景示例**：
  - 主機 A（已被攻擊者控制）→ 主機 B（中間樞紐點）→ 主機 C（目標伺服器）
  - 攻擊者在主機 B 設置連接埠轉發，使 A 能通過 B 連接到 C
  - 適用於當主機 C 位於無法從 A 直接訪問的子網路時

- **SSH 跳板攻擊**：
  - 使用 SSH 的 -D 參數設置本地代理和連接埠轉發
  - 在中間主機建立 SSH 通道，實現對無法直接訪問主機的連接

- **多級跳板攻擊**：
  - 攻擊者可以將多個代理伺服器串聯在一起
  - 通過多個樞紐點持續跳轉，直到到達關鍵目標主機或伺服器
  - 適用於複雜網路環境，如跨越多個子網路的攻擊