# 分析 SIEM

## 概要

- **SIEM Dashboard**（SIEM 儀表板）：用於網路監控的視覺化介面
  - 提供安全狀態的整體視圖和關鍵指標

- **Event Detection and Analysis**（事件偵測與分析）：使用 SIEM 偵測並分析各種事件
  - 包含識別異常活動和潛在安全威脅

- **Trend Analysis**（趨勢分析）：透過時間檢測網路問題
  - 辨識長期模式和潛在風險

- **Rules and Queries**（規則與查詢）：為 SIEM 編寫自定義規則和查詢
  - 包含使用正規表達式（Regular Expressions）進行字串搜尋
  - 結合命令列工具更快速找到資料

- **Scripting Basics**（腳本基礎）：使用不同腳本語言尋找特定資訊
  - 包含 **Bash**、**WMIC** 和 **PowerShell** 等工具

- **Log Analysis**（日誌分析）：分析、過濾和搜尋各種事件日誌
  - 在大量資料中識別惡意活動（尋找「大海撈針」）

# SIEM 儀表板

## 基本概念

- **SIEM**（Security Information and Event Management，安全資訊與事件管理）：
  - 整合日誌和事件資料的安全管理系統
  - 協助分析師監控、分析及應對安全威脅

- **SIEM 儀表板**（SIEM Dashboard）：
  - 以易於理解的格式呈現選定資訊的控制台
  - 主要使用視覺化方式展示資料
  - 可依照使用者角色客製化顯示所需資訊

## 資安分析師主要職責

- **事件分類處理**：
  - 對警報進行分類（Triage）
  - 將真正的威脅（True Positive）升級處理
  - 排除誤報（False Positive）

- **資料審查**：
  - 檢查日誌收集和資訊來源是否正常運作
  - 確保所有資料都能送入 SIEM 系統

- **威脅情報分析**：
  - 審查網路安全威脅情報
  - 判斷各種事件的優先順序和潛在影響

- **弱點管理**：
  - 執行弱點掃描和管理
  - 了解組織的弱點態勢和外部威脅

- **威脅狩獵**（Threat Hunting）：
  - 識別威脅狩獵的機會
  - 根據警報模式和威脅情報主動尋找潛在威脅

## 視覺化呈現方式

- **圓餅圖**（Pie Chart）：
  - 顯示不同分類的相對比例
  - 例如：不同安全等級事件的分布佔比

- **折線圖**（Line Graph）：
  - 顯示一段時間內的數值變化
  - 例如：一天內的日誌數量趨勢

- **長條圖**（Bar Graph）：
  - 比較不同分類間的數值差異
  - 例如：不同緊急程度事件的數量比較

- **儀表板**（Gauge）：
  - 顯示具有定義限制的數值
  - 常見形式包括速度計或帶箭頭的趨勢圖

- **表格**（Table）：
  - 提供更詳細的資訊
  - 常用於顯示「前 10 名事件」等排名資訊

## 關鍵績效指標（KPI）

- **KPI**（Key Performance Indicator，關鍵績效指標）：
  - 用於評估組織、員工或其他元素在達成績效目標方面的可量化指標
  - 在資安領域也有專屬的 KPI 指標

- **常見資安指標**：
  - 弱點數量
  - 登入失敗次數
  - 易受攻擊系統數量
  - 安全事件數量
  - 平均回應時間
  - 解決工單平均時間
  - 未解決問題數量
  - 受訓員工人數
  - 測試完成百分比

## 儀表板設計考量

- **根據使用者角色定制**：
  - 不同角色需要不同的資訊
  - 避免顯示無關資訊造成干擾

- **威脅層級差異化**：
  - 每個組織的整體威脅層級不同
  - 安全事件的識別和解釋應基於組織的威脅程度

- **使用 Widget 組件**：
  - 從 SIEM 提取資訊到儀表板
  - 可創建多個不同用途的儀表板

# 分析與偵測

## 分析與偵測概述

- **SIEM**（安全資訊與事件管理系統）：
  - 收集大量不同來源的資料，並應用規則產生警報
  - 分析師需要檢視這些警報，區分誤報與真實威脅
  - 真正威脅（True Positive）需要積極回應
  - 誤報（False Positive）則需要排除

## 分析方法類型

### 條件分析

- **Conditional Analysis**（條件分析）：
  - 由機器執行的簡單相關性分析，使用特徵碼偵測和規則型政策
  - 基於「如果...那麼...」的邏輯運作
  - 優點：結果明確，易於理解
  - 缺點：
    - 無法偵測零日攻擊或未知的戰術、技術和程序（TTP）
    - 產生大量誤報，因為規則過於基本，無法理解人類行為的複雜性

### 啟發式分析

- **Heuristic Analysis**（啟發式分析）：
  - 使用特徵比較和相似性而非精確特徵碼匹配來識別惡意行為
  - 結合機器學習技術，能夠偵測與已知特徵相似但非完全相同的行為
  - 優點：
    - 可以偵測經過輕微修改以規避特徵碼偵測的攻擊
    - 隨著時間推移和學習，效能會不斷提升
  - 缺點：
    - 初期可能產生大量誤報和漏報
    - 需要良好的訓練資料集

### 行為分析

- **Behavioral Analysis**（行為分析）：
  - 偵測正常操作資料序列中的變化並識別異常序列
  - 當事件偏離基準線超過容忍度時產生警報
  - 也被稱為統計分析或基於剖析的偵測
  - 優點：
    - 能夠識別偏離正常行為模式的活動
  - 缺點：
    - 在統計模型充分訓練和調整前，會產生大量誤報和漏報

### 異常分析

- **Anomaly Analysis**（異常分析）：
  - 使用可接受結果或事件模式的基準線來識別超出可接受範圍的事件
  - 針對不遵循特定模式或規則的事件產生警報
  - 優點：
    - 可以偵測不符合標準規範（如RFC）的行為
    - 能識別特殊攻擊如死亡之ping（ping of death）
  - 異常分析與行為分析的差異：
    - 異常分析使用預先定義的模式（如RFC或行業標準）
    - 行為分析則根據被監控設備的觀察模式建立自己的標準

## 機器學習在安全分析中的應用

- **Machine Learning**（機器學習）：
  - AI的一個組成部分，使機器能夠在給定標記資料集的情況下，發展解決任務的策略
  - 優點：
    - 能處理大量資料，減輕分析師工作負擔
    - 隨著時間學習改進，提高威脅識別準確度
  - 主要在啟發式分析中應用，幫助識別與已知特徵相似但非完全相同的威脅

# 趨勢分析

- **Trend Analysis**（趨勢分析）：檢測數據集中隨時間變化的模式，並利用這些模式預測未來事件或更好理解過去事件的過程。
  - 關鍵在於理解系統的基準線（baseline）：了解系統正常狀態，以識別偏離趨勢的情況。
  - 趨勢分析能從新角度審視過去事件，幫助識別異常模式。
  - 單一事件無法確定趨勢，需要多個數據點才能看出時間趨勢。

## 趨勢分析類型

- **Frequency-based Analysis**（頻率基礎分析）：建立特定指標的基準線，監控給定時間內事件發生的次數。
  - 例如：分析不同時段的訪問次數、系統事件數量，找出規律性和異常情況。
  - 可協助識別特定時段（如交接班時間）的系統使用峰值。

- **Volume-based Analysis**（容量基礎分析）：測量基於大小的指標，如磁碟空間使用量或日誌檔案大小。
  - 例如：資料庫伺服器網路使用量從平時的40MB增加到800MB（增加20倍）。
  - 可幫助識別資料外洩等異常活動。

- **Statistical Deviation Analysis**（統計偏差分析）：使用平均值和標準差來判斷數據點是否可疑。
  - 找出偏離平均值（mean）的異常數據點。
  - 例如：如果一個使用者帳號異常登入多個系統，就可能需要調查。

## 趨勢分析考量因素

- **選擇正確的測量指標**至關重要：
  - 警報和事件數量
  - 回應時間
  - 網路或主機指標（頻寬、儲存容量、登入次數、活躍埠）
  - 培訓與教育指標（員工對網路威脅的認識程度）
  - 合規性指標（系統是否符合基準要求）
  - 外部威脅等級（行業威脅情報）

- **Sparse Attack**（稀疏攻擊）：攻擊者將攻擊行為隱藏在網路雜訊中。
  - 攻擊者耐心地分散攻擊時間，例如每天只嘗試一次密碼，以規避系統的異常偵測。
  - 趨勢分析可以幫助識別這些被分散的攻擊行為模式。

- **Narrative-based Threat Awareness and Intelligence**（敘事式威脅意識和情報）：
  - 以長篇敘述形式報告隨時間觀察到的常見攻擊向量。
  - 例如：研究人員發現攻擊者使用IRC（Internet Relay Chat）進行殭屍網絡的命令和控制，通過敘事報告後，組織開始封鎖IRC，攻擊者隨後轉向HTTPS隧道。
  - 透過趨勢分析持續識別和應對攻擊者的戰術變化。

# 規則和查詢撰寫

- **Correlation（關聯分析）**：將個別資料點之間的關係進行解釋，以診斷對安全團隊有重要意義的事件
  - 關聯分析的目的是提供資料的上下文和意義
  - 例如：溫度資料從單純的"32"到"32度且持續下降"，能提供更有意義的資訊（表示即將結冰）

- **SIEM Correlation Rule（SIEM關聯規則）**：使用邏輯表達式匹配特定條件的陳述式
  - 可使用邏輯運算符如and、or，以及比較運算符如matches、less than、greater than和contains
  - 例如：可設置規則「若單一帳戶在一小時內有超過三次登入失敗則發送警報」
  - 規則範例：`Error.LogonFailure > 3 AND log-inFailure.User AND duration < 1 hour`
  - 關聯規則依賴於正規化資料才能進行比較

- **Normalized Data（正規化資料）**：
  - 關聯分析需要將不同來源的資料先進行解析和正規化
  - 正規化幫助提供資料的上下文，例如識別IP地址的來源、分配方式、時間同步等

- **Correlation Rules特性**：
  - 在資料被擷取進SIEM時即時匹配
  - 需要將資料保存在記憶體中作為持久狀態資料
  - 記憶體消耗大，可能導致系統變慢或崩潰

- **SIEM Query（SIEM查詢）**：從儲存的所有資料中擷取符合條件的記錄，用於審查或視覺化
  - 與關聯規則不同，查詢不會立即觸發警報，而是等待使用者執行查詢時才進行
  - 查詢可以檢索歷史資料，回溯的時間範圍可以是分鐘、小時、月甚至年

- **查詢語法結構**：
  - 基本格式：`SELECT [field] WHERE [conditions] SORTED BY [field]`
  - 例如：`SELECT user WHERE Error.LogonFailure > 3 AND log-inFailure.User AND duration < 1 hour SORTED BY date, time`
  - 查詢中的條件部分（WHERE子句）類似於規則，但查詢是在使用者需要時才執行的搜尋
