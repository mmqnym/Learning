# Nmap 與 NSE

- **NMAP (Network Mapper)**（網路映射器）：一種功能強大的網路安全工具，被譽為滲透測試人員的瑞士軍刀。
  - 在 CEH 考試中被明確指出，顯示其作為列舉和漏洞探索工具的重要性

- **NSE (NMAP Scripting Engine)**（Nmap 腳本引擎）：Nmap 的腳本擴展功能。
  - 如同「魔法棒」，讓使用者透過腳本執行多種任務
  - 可進行漏洞檢測到進階網路探索等多種功能
  - 允許滲透測試人員超越基本掃描，實際與網路互動並進行測試

## Nmap 核心功能

- **Nmap Discovery Scans**（Nmap 探索掃描）：用於發現網路中已連接的設備。
  - 相當於在教室中點名，檢查誰在場
  - 主要用於識別網路中的活躍主機

- **Nmap Port Scans**（Nmap 連接埠掃描）：檢查設備上的每個連接埠（端口）。
  - 確定連接埠是開放、關閉還是被嚴格鎖定
  - 每個開放的連接埠都能揭示設備的不同用途

- **Nmap Fingerprinting**（Nmap 指紋識別）：識別設備類型的技術。
  - 類似偵探使用指紋識別人物
  - 可識別設備類型，包括作業系統和運行的應用程序
  - 提供目標系統的詳細識別信息

# Nmap 深度探索

- **Nmap**（網路映射器）：世界上最流行的網路探查工具，來自開源的 Nmap 專案。
  - 是一種多功能的連接埠掃描器，用於拓撲、主機、服務和作業系統的探索與列舉。
  - 基本語法：`nmap <IP地址>` 或 `nmap <IP範圍>`（例如：`nmap 192.168.1.0/24`）

- **Default Behavior**（預設行為）：使用基本語法時，Nmap 會執行以下操作：
  - 發送 ping 和 TCP ACK 封包到連接埠 80 和 443 來判斷主機是否存在
  - 對活躍的主機執行連接埠掃描，檢測 1000 個最常用的連接埠
  - 特點：耗時較長且不太隱匿，容易被 IDS/IPS 或防火牆偵測阻擋

- **Discovery Scan**（探索掃描）：用於對網路進行足跡探測。
  - 目的：確定網路上有哪些主機存在，了解網路拓撲（IP 位址等）

- **Host Discovery Scan**（主機探索掃描）：使用 `-sn` 參數。
  - 語法：`nmap -sn <IP範圍>`
  - 功能：僅執行主機探索部分，不進行連接埠的掃描

## 主機掃描技術

- **List Scan**（清單掃描）：使用 `-sL` 參數。
  - 功能：列出指定目標範圍內的 IP 地址，並執行反向 DNS 查詢以探索與這些 IP 關聯的主機名稱
  - 特點：較為被動的方式，不直接向目標主機發送探測封包，而是通過 DNS 服務器進行查詢

- **TCP SYN Ping**（TCP SYN 偵測）：使用 `-PS` 參數。
  - 功能：使用 TCP SYN 封包探測指定的連接埠
  - 適用場景：當網路阻擋 ICMP 封包（傳統 ping）時特別有用
  - 原理：發送 SYN 封包後，若收到 SYN-ACK 回應，表示主機存活，但不完成三向交握（不發送最後的 ACK）

- **Sparse Scanning**（稀疏掃描）：使用 `--scan-delay <時間>` 參數。
  - 功能：在探測之間增加延遲時間，使掃描更隱匿
  - 目的：避免被 IDS/IPS 偵測到

- **Scan Timing**（掃描時間控制）：使用 `-Tn` 參數，n 為 0-5 的數字。
  - 功能：控制探測的時間模式
  - 參數值：0 最慢、5 最快、3 中等速度
  - 目的：調整速度以避免被安全設備偵測或適應不同網路環境

- **TCP Idle Scan**（TCP 閒置掃描）：使用 `-sI` 參數。
  - 功能：使掃描看起來像是來自另一台機器（殭屍機）
  - 目的：隱藏真實掃描者的身份，更加隱匿

- **Fragmentation**（分片）：使用 `-f` 或 `--mtu` 參數。
  - 功能：將每個探針的 TCP 標頭拆分為多個 IP 數據包
  - 目的：使 IDS/IPS 更難以偵測到掃描活動

## 輸出結果與格式

- **Interactive Output**（互動式輸出）：預設設定，結果直接顯示在螢幕上。

- **Normal Output to File**（普通輸出到檔案）：使用 `-oN <檔名>` 參數。
  - 功能：將螢幕輸出保存到文字檔案中

- **XML Output**（XML 輸出）：使用 `-oX <檔名>` 參數。
  - 功能：將結果以 XML 格式保存到檔案中

- **Grepable Output**（可 grep 的輸出）：使用 `-oG <檔名>` 參數。
  - 功能：以可 grep 的格式保存結果
  - 優點：適合處理大型資料集，方便後續使用 grep 命令搜尋特定資訊

## 實例輸出分析

- 使用 `nmap -A -T4 scanme.nmap.org` 的掃描：
  - `-T4` 表示使用較快的掃描時間模式
  - 結果顯示了掃描到的主機和開放的連接埠服務資訊

# 服務探測和埠掃描技術

- **Service Discovery**（服務探索）：用於確定目標系統正在運行的網絡服務和作業系統類型
  - 根據掃描的 IP 數量和埠數量，可能需要數分鐘到數小時不等的時間完成
  - 雖然某些掃描被稱為「隱匿」，但配置良好的 IDS/IPS 仍能檢測到大多數 Nmap 掃描

## 埠掃描技術

- **TCP SYN Scan**（TCP SYN 掃描）：使用 `-sS` 參數進行的半開放式掃描
  - 通過發送 SYN 封包識別埠狀態，但不發送 ACK 確認封包
  - 這種掃描需要管理員或 root 權限才能執行
  - 不會造成拒絕服務攻擊，因為發送量不足以產生大量連線請求
  - 相較完整的 TCP 連接掃描更加隱匿

- **TCP Connect Scan**（TCP 連接掃描）：使用 `-sT` 參數
  - 通過發送 SYN 封包並在收到 SYN-ACK 後發送 ACK 完成完整的三次握手
  - 當網卡不支援半開放掃描或沒有管理員權限時，可使用此掃描方式

- **Null Scan**（空掃描）：使用 `-sN` 參數
  - 發送所有標誌位設為零的封包
  - 對於大多數 IDS/IPS 來說，這種掃描容易被檢測為異常行為

- **FIN Scan**（FIN 掃描）：使用 `-sF` 參數
  - 通過發送意外的 FIN 封包進行掃描
  - FIN 封包通常用於結束通信會話，因此在非預期時刻發送很容易被檢測

- **Christmas Scan(Xmas Scan)**（聖誕樹掃描）：使用 `-sX` 參數
  - 通過同時設置 FIN、PSH 和 URG 標誌位為 1 來進行掃描
  - 名稱源於掃描在日誌中「亮起」的樣子像聖誕樹
  - 這是最容易被檢測到的掃描方式之一
  - 滲透測試人員可以用它來測試目標是否有在監控日誌

- **UDP Scan**（UDP 掃描）：使用 `-sU` 參數
  - 通過發送 UDP 封包並等待回應或超時來確定埠狀態
  - 由於 UDP 無連接特性，需要通過等待回應或超時來推斷埠狀態

- **Port Ranges**（埠範圍）：使用 `-p` 參數
  - 可指定要掃描的特定埠或埠範圍
  - 預設情況下 Nmap 會掃描 1000 個最常用埠
  - 針對性掃描少數幾個埠（如 80、443、22）能提高隱匿性並減少被檢測機會

## 埠狀態類型

- **Open**（開放）：主機應用程式準備接受連接的狀態
  - 表示有服務在此埠上運行，可能存在潛在的漏洞入口點

- **Closed**（關閉）：埠會以重置封包（RST）回應探測
  - 表示沒有應用程式在此埠上接受連接

- **Filtered**（過濾）：Nmap 無法探測到埠狀態
  - 通常表示有防火牆阻擋了掃描
  - 是最常見的狀態之一

- **Unfiltered**（未過濾）：Nmap 能夠探測埠，但無法確定其是開放還是關閉
  - 在 Nmap 掃描中較為少見

- **Open|filtered**（開放或過濾）：Nmap 無法確定埠是開放還是被過濾
  - 在 UDP 或 IP 協議掃描中比較常見
  - SYN 掃描通常能夠明確區分開放或過濾狀態

- **Closed|filtered**（關閉或過濾）：Nmap 無法確定埠是關閉還是被過濾
  - 在 TCP idle 掃描（使用 `-sI` 參數）中可能出現

## 綜合應用

- 可將不同掃描技術與計時參數（如 `-T0` 慢速掃描）結合使用，以提高隱匿性
- 識別開放埠有助於了解網絡的攻擊面，尤其是那些不應開放的埠
- 例如，在普通工作站上發現開放的 80 埠可能是安全隱患，因為桌面環境通常不應運行網頁伺服器

# Nmap 指紋掃描

- **Fingerprinting**（指紋掃描）：一種獲取網路、主機或系統上所有資源清單的技術，用於識別潛在的攻擊目標。
  - 攻擊者使用此技術收集目標系統資訊，以找出滲透和利用的方法
  - 防禦者同樣需要這些資訊來建立防禦機制

- **Intensive Port Scan**（深度埠掃描）：使用 Nmap 對已發現的開放埠進行深入探測的過程。
  - 兩種主要命令：
    - `nmap -sV`：提供基本版本資訊
    - `nmap -A`：更深入的掃描，能發現更多數據

- **Fingerprint Scan Information**（指紋掃描資訊）：深度指紋掃描可提供的詳細資訊。
  - 使用中的協定
  - 應用程式名稱和版本
  - 作業系統類型和版本（`nmap -O`）
  - 主機名稱
  - 裝置類型

- **Port States**（埠狀態）：Nmap 掃描結果會顯示不同的埠狀態。
  - open（開放）：表示服務正在監聽該埠
  - closed（關閉）：表示埠可達但沒有服務監聽
  - filtered（過濾）：表示防火牆或過濾器阻擋了探測

- **CPE**（Common Platform Enumeration，通用平台列舉）：Nmap 用於識別硬體裝置、作業系統和應用程式的機制。
  - 由 MITRE 公司開發
  - 本質上是不同指紋簽名的資料庫
  - Nmap 比較埠回應與資料庫中的簽名來判斷作業系統和版本
  - 透過分析 SYN 封包發送後收到的 SYN/ACK 回應，因為每種系統回應方式略有不同

- **NSE**（Nmap Scripting Engine，Nmap 腳本引擎）：Nmap 內建的腳本引擎，增強其功能。
  - 使用 Lua 腳本語言編寫
  - 置於 `/usr/share/nmap/scripts` 資料夾中
  - 功能包括：
    - 作業系統偵測和平台列舉
    - Windows 使用者帳戶探索
    - 識別已登入的 Windows 使用者
    - 基本漏洞偵測
    - 網頁伺服器探測以收集 HTTP 資料
    - 識別使用中的網頁應用程式
    - 為不同的追蹤路由探測添加地理位置資訊
  - 在 nmap.org 上有大量可直接使用的預製腳本
  - 範例：`nmap -sV --script=vuln <IP/DNS>`

## 掃描結果範例

- 埠 53/TCP（開放）：運行 domain 服務（DNS），使用 BIND
- 埠 80/TCP（開放）：運行 HTTP 服務，使用 Microsoft Internet Information Services 10.0
- 其他可識別資訊：MAC 位址、作業系統（範例中為 Windows Server 2016）