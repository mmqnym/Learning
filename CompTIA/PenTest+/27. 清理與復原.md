# 清理與復原

## 後滲透階段的清理與復原

- **Post-exploitation cleanup and restoration**（後滲透階段清理與復原）：滲透測試後將系統還原到正常運作狀態的過程
  - 目的是移除所有滲透測試痕跡，減少未來系統漏洞

## 主要清理與復原活動

- **Persistence Removal**（持久性機制移除）：識別並移除攻擊者用於維持系統存取的機制
  - 防止攻擊者在清理程序後重新進入系統
  - 常見持久性機制包括註冊表項（Registry Keys）、排程任務、WMI事件消費者等

- **Reverting Configuration Changes**（回復配置變更）：將配置和設定還原至原始或預期狀態
  - 包括撤銷測試期間所做的任何未授權變更

- **Created Credentials Removal**（移除創建的憑證）：識別並删除測試期間創建的用戶帳戶或憑證
  - 防止未來未授權訪問系統

- **Removal of Testing Tools**（移除測試工具）：謹慎移除滲透測試期間使用的軟體、腳本或工具
  - 避免這些工具被惡意利用

- **Decommissioning Test Infrastructure**（解除測試基礎設施）：拆除為測試目的設立的臨時系統或網路
  - 確保這些臨時基礎設施在測試完成後不會被利用

- **Artifact Preservation**（產出物保存）：適當收集與保存日誌、被洩露數據等資料
  - 可用於進一步分析、法律目的或整體安全改進

- **Secure Data Destruction**（安全數據銷毀）：安全刪除測試期間臨時使用或創建的數據
  - 確保數據無法被復原

# 移除存取持久性機制（Persistence Mechanisms）

- **持久性機制（Persistence Mechanisms）**：攻擊者或滲透測試人員用來在初次入侵後維持系統存取權限的技術。

## 常見持久性機制及其移除方法

- **排程任務（Scheduled Tasks）**：
  - 攻擊者可能在 Windows 工作排程器或 Linux crontab 中添加項目
  - 移除方法：
    - Windows：使用工作排程器介面或 schtasks 命令刪除可疑任務
    - Linux：使用 `crontab -e` 命令編輯並刪除惡意條目

- **登錄檔項目（Registry Keys）**：
  - 攻擊者常在 HKEY_LOCAL_MACHINE (HKLM) 和 HKEY_CURRENT_USER (HKCU) 中新增值
  - 移除方法：使用登錄編輯器（Registry Editor）導航至這些位置並刪除可疑值
  - 注意：移除前請確保該項目確實是惡意的

- **隱藏檔案或目錄（Hidden Files or Directories）**：
  - 攻擊者存儲惡意腳本或工具於混亂或不明顯的目錄中
  - 移除方法：使用檔案完整性監控工具檢測並移除不應存在的檔案

- **使用者帳戶（User Accounts）**：
  - 攻擊者創建新帳戶或修改現有帳戶以維持存取權
  - 移除方法：
    - 檢查並刪除攻擊者創建的所有帳戶
    - 對於域帳戶（Domain Accounts），需同時從本地系統和域控制器中移除

- **遠程存取工具（Remote Access Tools）**：
  - 包括 Metasploit 負載（payloads）或鍵盤記錄器等後門程式
  - 移除方法：
    - 這些工具可能隱藏在特定位置（如 Windows System32 目錄或深入登錄檔中）
    - 使用專業惡意軟體移除工具（如 Malwarebytes 或 Spybot Search & Destroy）

# 滲透測試後的組態回復（Post-Penetration Test Configuration Reversion）

## 基本概念

- 滲透測試過程中可能會變更系統組態以測試漏洞，測試後必須回復所有變更，以維護系統完整性和安全性

## 可能需要回復的配置變更

- **Firewall Rules**（防火牆規則）：測試過程中可能修改的安全機制。
  - 範例：開放特定連接埠（如 8080）以測試網頁應用程式是否有 SQL 注入或 XSS 等漏洞
  - 建議：測試前記錄原始設定，使用文件來精確還原防火牆配置

- **Database Configurations**（資料庫配置）：在測試過程中可能被更改的資料庫設定。
  - 範例：修改 Oracle DB 的訪問控制，允許更寬鬆的帳戶存取以測試 SQL 注入或其他資料庫漏洞
  - 必須回復這些變更以防止未授權訪問和潛在攻擊

- **Logging and Monitoring**（日誌和監控系統）：
  - 測試期間可能會停用某些日誌功能以避免被偵測
  - 測試後需重新啟用這些日誌並確認其正常運作
  - 須確保所有必要事件都被記錄且日誌保留政策恢復正常

- **System Settings and Application Configurations**（系統設定和應用程式配置）：
  - 可能會停用某些安全功能（如加密或身分驗證機制）以測試特定弱點
  - 測試後必須重新啟用這些安全功能來保護系統
  - 提前記錄這些變更可以幫助準確且快速地復原

- **DNS Settings**（DNS 設定）：
  - 測試期間可能變更 DNS 配置以將流量導向特定伺服器進行分析
  - 範例：將系統的 DNS 服務器設定指向一個控制的 DNS 服務器，記錄所有查詢進行分析
  - 測試後必須將 DNS 設定還原至原始狀態

## 最佳實踐

- **預先文件化**（Documentation）：進行任何變更前先記錄原始設定
  - 使用文件來確保準確恢復系統到原始狀態

- **使用虛擬環境快照**（Virtualization Snapshots）：
  - 在虛擬環境中創建系統快照，便於快速回復

- **徹底清理**（Thorough Cleanup）：
  - 完整回復所有變更以防止測試後留下的安全風險
  - 維護系統完整性，確保其始終安全

# 憑證清除

## 清除類型及重要性

- **Tester-created Credentials**（測試人員建立的憑證）：包括用戶帳戶、殼層和工具，清除這些憑證對確保系統安全至關重要。
  - 如果採用了規避技術，這些憑證可能深度嵌入系統中，難以追蹤和移除。

## 不同身份驗證系統的清除方法

- **本地系統憑證**（Local System Credentials）：可以直接登入並刪除創建的本地憑證。

- **Active Directory 域帳戶**（Active Directory Domain Accounts）：需要特殊處理。
  - 從域控制器（DC）創建的帳戶不能僅從工作站移除。
  - 必須重新訪問域控制器以刪除AD帳戶，否則真實攻擊者可能利用此帳戶進入系統。

- **API 金鑰和令牌**（API Keys and Tokens）：透過服務管理介面或API刪除。
  - 例如：AWS或Google Cloud的API金鑰需要登入管理控制台撤銷。
  - 記錄所有金鑰及其測試用途，確保全部識別並移除。

## 清除殼層和後門

- **Shell 清除**（Shell Removal）：避免攻擊者利用殼層作為後門進入系統。
  - 識別所有部署的殼層。
  - 使用與創建時相同的方法刪除或禁用它們。
  - 檢查啟動腳本、計劃任務和其他持久化機制。
  - 詳細記錄測試期間創建的所有殼層，確保清理過程中不遺漏任何一個。

## 帳戶問題排查

- **帳戶鎖定問題**（Account Lockout Issues）：帳戶鎖定可能來自外部嘗試驗證，設置自動解鎖腳本可能會引發嚴重安全問題。

- **域控制器配置**（Domain Controller Configuration）：加入域操作需搭配正確的安全設定和更新。

## 總結

- 移除測試創建的憑證是滲透測試後清理的重要環節。
- 徹底移除由測試者建立的所有本地和域帳戶、殼層和工具，確保系統安全及完整性。
- 此步驟對防止測試殘留物被攻擊者利用至關重要。

# 工具移除

- **滲透測試後工具移除**：完成滲透測試後，必須移除所有測試工具，以將系統恢復至原始運作基準，並防止測試期間創建的安全漏洞被未來攻擊者利用。

## 工具類型及移除方法

- **記憶體載入工具**（Memory-loaded tools）：
  - 通常在系統重啟後自動移除
  - 例如：僅存在於記憶體中的 Metasploit 反向殼層（reverse shell）將在機器重新啟動時被清除

- **持久性工具**（Persistent tools）：
  - 存儲在磁碟上，需要手動解除安裝
  - 簡單刪除可執行檔不足以移除所有痕跡

- **安全移除檔案**：
  - 使用檔案粉碎工具（shredding tool）覆寫數據多次
  - 推薦工具：
    - Linux 系統：shred 命令
    - Windows 系統：第三方應用程式如 CCleaner (但要注意，根據[Chris Titus Tech](https://www.youtube.com/watch?v=tSm1GcuygM0)的報告，CCleaner 曾有安全問題)

## 特定工具移除

- **鍵盤記錄器**（Keyloggers）：
  - 移除程式本身
  - 刪除相關的數據檔案（日誌和設定檔）

- **漏洞掃描代理**（Vulnerability scanner agents）：
  - 使用軟體的解除安裝程序
  - 定位並安全刪除任何留下的設定或日誌檔案
  - 一些代理程式設計為完成評估後自動解除安裝，且不留下任何檔案或痕跡

- **日誌檔案位置**：
  - Linux 系統：通常在 /var/log 目錄
  - Windows 系統：通常在安裝目錄中

## 自動化工作移除

- **排程工作**：
  - Linux 系統：
    - 編輯 crontab 檔案（crontab -e）
    - 移除相關條目
  
  - Windows 系統：
    - 使用工作排程器介面
    - 或使用 schtasks 命令刪除排程工作

## 移除工具總結

- 徹底解除安裝所有工具
- 安全刪除相關檔案
- 移除任何自動化工作
- 確保不留下任何可能被未來攻擊者利用的殘留物

# 解除基礎設施

## 解除基礎設施

- **Infrastructure Decommissioning**（基礎設施解除）：測試後關閉雲端測試系統並移除所有創建的系統或服務器
  - 目的是防止安全風險和避免產生額外費用
  - 忘記解除的資源可能導致巨額費用

- **Resource Identification**（資源識別）：識別所有創建的資源
  - 保持詳細清單，包括虛擬機、容器、資料庫和其他雲服務
  - 使用 AWS Management Console 查看帳戶下運行的實例和服務
  - 確保檢查可能使用的每個區域，因為儀表板通常按區域分隔

- **Resource Termination**（資源終止）：終止識別的資源
  - 虛擬機：停止並終止實例（在 AWS 中選擇"Terminate"選項）
  - 資料庫：刪除資料庫實例，確保數據備份被安全存儲或刪除

- **Storage Cleanup**（存儲清理）：檢查任何可能未自動刪除的存儲
  - 包括附加到虛擬機的卷（如 AWS Elastic Beanstalk 卷）和對象存儲（如 AWS S3 存儲桶）
  - 刪除這些存儲資源以防止殘留數據被訪問

- **Network Configuration Cleanup**（網路配置清理）：清理測試期間設置的網路配置
  - 包括虛擬私有雲、安全組和路由表
  - 刪除任何不再需要的安全組，以關閉開放的網路路徑

- **Logs and Monitoring Data**（日誌和監控數據）：確保測試期間收集的日誌和監控數據被安全存儲和審查
  - 如不再需要，安全刪除以維持良好的數據衛生和隱私

## AWS 資源管理

- **AWS Resource Groups**（AWS 資源組）：幫助檢查和管理 AWS 資源的工具
  - 可通過 AWS Resource Groups 控制台訪問
  - 可顯示各區域已分配的資源

- **EBS Volume Deletion**（EBS 卷刪除）：需要特別注意的 AWS 資源
  - 如果在 EC2 實例創建期間未勾選「Delete on Termination」，終止 EC2 實例時 Amazon EBS 根設備卷不會自動刪除
  - 需要手動刪除這些卷

- **Elastic Beanstalk Buckets**（Elastic Beanstalk 存儲桶）：特殊處理的 S3 存儲桶
  - Elastic Beanstalk 創建的名為「elasticbeanstalk」的存儲桶無法正常刪除
  - 因為 Elastic Beanstalk 對其創建的存儲桶應用了存儲桶策略，允許環境寫入並防止意外刪除

# 滲透測試後的保存產出物重點筆記

## 保存產出物的基本概念

- **Artifacts**（產出物）：指滲透測試過程中生成或收集的資料
  - 包括日誌、螢幕截圖、設定檔、腳本等
  - 這些項目提供測試行動和發現結果的詳細記錄
  - 對於未來參考、稽核或法律用途非常重要

## 保存產出物的主要步驟

- **Securely store logs**（安全存儲日誌）：將測試期間收集的所有日誌和數據安全保存
  - 例如：將漏洞掃描器的報告儲存在安全位置
  - 確保這些文件備份並防止未經授權的訪問
  - 建議對存儲位置進行加密以維護數據機密性

- **Document configurations**（記錄設定）：記錄測試期間的配置和設定
  - 保留所使用的任何腳本或工具的副本
  - 記錄這些工具的使用方式和產生的結果
  - 有助於在未來需要時重現測試環境

- **Screenshots**（螢幕截圖）：拍攝關鍵步驟的螢幕截圖
  - 例如：成功的漏洞利用嘗試或重要發現
  - 可納入最終報告作為明確證據
  - 確保這些截圖被標記並安全存儲

- **Notes and timelines**（筆記和時間軸）：保持良好的筆記和活動時間軸
  - 包括每個動作的日期和時間
  - 記錄目標系統和每次測試的結果
  - 提供測試期間事件順序的背景和理解

- **Handle sensitive data**（處理敏感數據）：謹慎處理測試期間暴露或使用的敏感數據
  - 如使用真實用戶數據，確保測試完成後匿名化或刪除
  - 保護隱私和符合資料保護法規

## 保存產出物的重要性

- **Future reference**（未來參考）：提供詳細記錄供將來分析和比較使用
  - 為未來的研究和分析提供支持

- **Audit trail**（稽核追蹤）：維護測試活動的清晰記錄
  - 有助於驗證測試的完整性和範圍

- **Legal purposes**（法律目的）：在必要時提供法律證據
  - 證明測試是按照商定的範圍和方法進行的

- **Transparency**（透明度）：提供測試方法和發現的透明度
  - 有助於客戶理解測試過程和結果的可靠性