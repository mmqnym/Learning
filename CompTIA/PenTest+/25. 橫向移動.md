# 橫向移動

## 基礎概念

- **Lateral Movement**（橫向移動）：攻擊者在獲得初始訪問權限後，用於在網路中導航和擴展控制範圍的技術。
  - 攻擊者通過訪問其他系統和帳戶來擴展其立足點
  - 這個階段對攻擊者定位高價值目標和深化網路滲透至關重要

## 橫向移動技術

- **Pivoting and Relaying**（轉發與中繼）：使用一台已被入侵的主機來獲取對其他主機的訪問權限的基礎技術。
  - 通常涉及端口轉發和隧道技術
  - 是橫向移動的核心技術基礎

- **ProxyChains**：創建流量代理伺服器鏈的工具。
  - 攻擊者可用於掩蓋其位置
  - 能夠通過已入侵的主機路由流量
  - 幫助攻擊者在執行橫向移動時保持隱蔽

## 信息收集技術

- **Service Discovery**（服務發現）：識別其他機器上可被利用的服務。
  - 利用 SMB 或 RPC 等協議獲取對系統的訪問權限
  - RPC 目標偵察專注於識別使用遠程過程調用協議收集網路資源和服務信息的嘗試

- **Protocol Discovery**（協議發現）：檢測環境中可能存在漏洞或便於更深入訪問的網路協議。
  - 重點關注明文協議，如 LDAP、FTP 和 Telnet
  - 攻擊者可利用 LDAP 進行目錄服務偵察，找出敏感帳戶和其他資產

- **Remote Access Discovery**（遠端存取發現）：定位網路中的遠端存取功能。
  - 包括 RDP 和 SSH 等遠程訪問協議
  - 這些協議可被攻擊者用來擴展對網路的控制

- **Printer Discovery**（影印機發現）：利用網路影印機和 LDP 等協議進行橫向移動。
  - 影印機通常安全性較弱，成為攻擊者的潛在目標

- **Discovering Internal Websites**（發現內部網站）：尋找並利用內部網路中運行的 Web 應用程式。
  - 內部 Web 應用通常不如面向外部的應用安全

## 高級技術與工具

- **Living Off the Land Tools**（系統原生內建工具）：使用系統內建工具進行操作的技術。
  - 利用如 netstat 或 MMC 等內建工具進行移動
  - 不需要額外軟體，較難被檢測到
  - 多個 APT 組織如 APT41 使用 netstat 命令作為網路偵察的一部分

- **sshuttle**：用於創建類似 VPN 環境的工具。
  - 使用 SSH 建立隱蔽的網路移動通道
  - 提供更隱秘的網路穿越方式

- **Covenant**：強大的 .NET 命令和控制框架。
  - 用於執行多階段攻擊和管理已入侵的主機
  - 提供完整的後滲透與橫向移動功能

## MITRE ATT&CK 相關技術

- **System Service Discovery**（系統服務發現）
  - 攻擊者使用如 `net start >> %temp%\\download` 等命令獲取有關服務的信息

- **System Network Connections Discovery**（系統網路連接發現）
  - APT41 等組織以列舉網路資源的 IP 地址並使用 netstat 命令進行網路偵察

- **Network Service Discovery**（網路服務發現）
  - FIN13 等組織利用 `nmap` 進行偵察

# 樞紐轉向與中繼

## 橫向移動概念

- **Pivoting**（樞紐轉向）：利用已被入侵的系統作為跳板，移動到同一網路中的其他系統的過程
  - 允許攻擊者或滲透測試人員訪問原本無法接觸到的網路區段
  - 被入侵的機器成為「樞紐點」，用於接觸內部網路中的其他資源
  - [offensive-security.com](http://www.offensive-security.com/metasploit-unleashed/Pivoting/) 將其定義為使用一個據點（foothold）來移動到網路內部的技術

## 樞紐轉向的類型

- **Network Pivoting**（網路層樞紐轉向）：
  - 利用已入侵機器的網路功能將流量路由到其他機器
  - 常見實作：SSH 通道技術
  - 例如：透過已入侵的機器設定 SSH 通道，從而訪問內部網路中的 Web 服務
  - [docs.metasploit.com](https://docs.metasploit.com/docs/using-metasploit/intermediate/pivoting-in-metasploit.html) 指出這允許攻擊者訪問原本無法接觸的網路

- **Application-level Pivoting**（應用層樞紐轉向）：
  - 利用已入侵機器與其他機器上的應用程式和服務互動
  - Metasploit 是實現此類樞紐轉向的常用工具
  - 步驟：
    1. 取得已入侵機器的 Meterpreter 控制權
    2. 建立通往其他網路區段的路由
    3. 掃描內部網路尋找其他潛在目標
  - [tutorialspoint.com](https://www.tutorialspoint.com/metasploit/metasploit_pivoting.htm) 描述這個過程為利用第一個網路作為樞紐點來訪問第二個網路

## 中繼攻擊技術

- **Relay Creation**（中繼攻擊）：
  - 捕獲並轉發身份驗證請求以利用系統間的信任關係
  - 可利用捕獲的身份驗證憑證橫向移動到其他系統
  - [medium.com](https://medium.com/@maxwellcross/credential-relaying-ntlm-abuse-with-python-turning-stolen-hashes-into-shells-7d2e3ed56399) 解釋中繼攻擊是將一台機器的憑證轉發到另一台機器，模擬受害者身分

- **SMB Relay Attack**（SMB 中繼攻擊）：
  - 捕獲並轉發 SMB 身份驗證請求以獲取未授權存取
  - 使用 Impacket 的 ntlmrelayx.py 工具設置 SMB 中繼
  - 成功後，可使用中繼憑證訪問目標系統

- **LDAP Relay Attack**（LDAP 中繼攻擊）：
  - 針對 LDAP 身份驗證的中繼攻擊
  - 使用 Impacket 轉發捕獲的 NTLM 身份驗證請求到 LDAP 伺服器
  - 驗證成功後可執行各種 LDAP 操作（查詢用戶資訊、修改目錄項目）

## 常用工具

- **SSH**：用於網路層樞紐轉向
- **Metasploit**：用於應用層樞紐轉向和路由建立
- **Impacket**：用於中繼攻擊（特別是 ntlmrelayx.py 工具）
- **Meterpreter**：Metasploit 的進階載荷，提供樞紐轉向功能

# 橫向移動枚舉

## 關鍵偵察領域

- **Service Discovery**（服務探索）：識別網路設備上運行的活動服務
  - 使用工具如 NMAP 掃描目標，發現特定連接埠上運行的服務
  - 常見服務例如：HTTP（80 埠）、SMB（445 埠）、RDP（3389 埠）
  - 有助於識別潛在入口點和可被利用的漏洞

- **Network Traffic Discovery**（網路流量探索）：分析網路內數據流
  - 使用工具如 Wireshark 和 tcpdump 捕獲和分析網路流量
  - 可識別活動主機、開放連接埠及使用中的協議類型
  - 協助繪製網路圖並識別關鍵系統

- **Credential Capturing**（憑證捕獲）：攔截網路傳輸中的認證憑證
  - 使用中間人攻擊（On-path 攻擊）和釣魚等技術
  - 工具包括 Responder 和 Ettercap
  - Responder 可投毒 LLMNR 和 NBT-NS 請求，捕獲 NTLMv2 雜湊值
  - 捕獲的憑證可用於訪問其他系統

- **Credential Dumping**（憑證傾印）：從已被入侵的系統中提取存儲的憑證
  - 使用工具如 Mimikatz 從記憶體或 SAM 資料庫中提取憑證
  - 可提取明文密碼、密碼雜湊和 Kerberos 票證 [redcanary.com](https://redcanary.com/threat-detection-report/threats/mimikatz/)
  - Mimikatz 通過利用 Windows 作業系統漏洞提取存儲在記憶體中的憑證 [wallarm.com](https://www.wallarm.com/what/what-is-mimikatz)
  - 常用模組包括 `sekurlsa::logonpasswords`（提取最近活躍用戶帳戶的用戶名和密碼）和 `lsadump::sam`（傾印 SAM 資料庫密碼雜湊）

- **String Searches**（字串搜尋，含協議 ID）：識別敏感資訊和潛在攻擊向量
  - 在檔案、日誌和記憶體中尋找特定模式（密碼、API 密鑰、設定詳情）
  - Linux 上可使用 grep 和 strings 等工具
  - 協議 ID 幫助識別和分析特定使用中的連接埠（HTTP、SMB、LDAP）

## 憑證傾印技術深入解析

- **Windows Credential Editor (WCE)**（Windows 憑證編輯器）：舊版 Windows 工具，可從 LSASS 記憶體中傾印密碼雜湊 [cymulate.com](https://cymulate.com/cybersecurity-glossary/credential-dumping/)
  - 當 Mimikatz 不可用時，攻擊者常用的替代工具

- **LSASS**（本地安全授權子系統服務）：Windows 儲存已登錄用戶憑證的服務 [picussecurity.com](https://www.picussecurity.com/resource/the-mitre-attck-t1003-os-credential-dumping-technique-and-its-adversary-use)
  - 允許用戶和服務無需重新輸入憑證即可無縫訪問網路資源

- **Mimikatz 模組**：用於憑證提取的重要工具 [medium.com](https://medium.com/@adarshpandey180/credential-attacks-with-mimikatz-a-deep-dive-into-the-world-of-password-cracking-97d8ffb56a35)
  - `sekurlsa::tickets`：列出所有最近認證用戶的可用 Kerberos 票證
  - `sekurlsa::logonpasswords`：提取用戶名和密碼
  - `lsadump::sam`：傾印 SAM 資料庫的密碼雜湊

## 偵測與防禦

- **Mimikatz 偵測指標**：
  - 尋找進程中模組名稱作為命令列參數
  - 不尋常的網路活動
  - 不尋常的登錄活動
  - 可疑檔案或進程的存在

- **憑證傾印威脅**：
  - 允許攻擊者提升權限並深入訪問內部網路
  - 提取憑證後可模擬合法用戶
  - 使攻擊者能夠在系統間橫向移動，通常不被檢測到

# 服務發現

## 服務發現概述

- **Service Discovery**（服務發現）：識別網路中的服務和資源，作為滲透測試中橫向移動的基礎
  - 本筆記主要聚焦於SMB、RPC和DCOM服務的識別與利用

## 檔案共享服務

- **SMB (Server Message Block)**（伺服器訊息區塊）：用於在網路上共享檔案、印表機和其他資源的協議
  - 識別SMB檔案共享可揭示有價值的資訊和存取點
  - 常用工具：Nmap和SMBClient

### SMB識別技術

- **Nmap SMB共享枚舉**：使用`nmap --script smb-enum-shares <target_ip>`來識別目標機器上的共享資源
- **SMBClient連接**：一旦識別了共享，可使用SMBClient連接並探索內容

### SMB漏洞利用

- **SMB漏洞利用方法**：
  - 存取不安全的共享
  - 利用弱權限設定
  - 使用已獲取的憑證進行存取
- **Metasploit模組**：
  - `smb_login`：嘗試使用各種憑證登入
  - `smb_enumusers`：列出使用者帳戶

## 遠程過程調用服務

- **RPC (Remote Procedure Call)**（遠程過程調用）：允許程式在網路中的不同電腦之間請求服務
  - 例如：一個財務應用程式可能使用RPC向另一台電腦上的資料庫伺服器請求交易處理服務
  
### RPC識別技術

- **Nmap RPC服務發現**：使用`nmap --script rpcinfo <target_ip>`探索目標機器上運行的RPC服務

### RPC漏洞利用

- **RPC漏洞利用方法**：針對已知漏洞或錯誤配置進行攻擊
  - 某些RPC服務可能存在遠程程式碼執行漏洞
  - 利用Metasploit模組自動化攻擊過程

### 真實案例分析

- **WannaCry勒索軟體攻擊(2017)**：
  - 利用CVE-2017-0143漏洞（Microsoft SMB協議）
  - 攻擊者創建了名為EternalBlue的漏洞利用工具
  - EternalBlue能發送特製封包到目標機器的SMB服務，觸發漏洞並執行任意程式碼
  - 一旦機器被感染，WannaCry會加密受害者的檔案並顯示勒索訊息
  - 使用相同SMB漏洞在同一網路中的其他機器間快速傳播

## 分散式元件物件模型

- **DCOM (Distributed Component Object Model)**（分散式元件物件模型）：Microsoft開發的技術，允許軟體元件在網路上相互通信
  - 使不同電腦上的程式能夠協同工作並共享資訊，便於構建複雜應用程式

### DCOM識別技術

- **DCOM服務枚舉**：使用Metasploit和PowerShell腳本來查找目標機器上的DCOM服務
- **PowerShell命令**：`Get-WmiObject -Class Window32_DCOMApplication`收集Windows電腦上DCOM應用程式的資訊

### DCOM漏洞利用

- **DCOM漏洞利用方法**：利用漏洞或使用DCOM遠程執行命令
- **Metasploit dcomexec模組**：通過DCOM在目標機器上執行命令
  - 允許以DCOM服務的權限執行命令，有利於網路內的橫向移動

## 工具總結

- **滲透測試工具集**：
  - [Nmap](https://www.freecodecamp.org/news/how-to-exploit-the-eternalblue-vulnerability-on-windows/)：網路掃描與服務發現
  - SMBClient：連接和探索SMB共享
  - [Metasploit](https://www.freecodecamp.org/news/how-to-exploit-the-eternalblue-vulnerability-on-windows/)：自動化漏洞利用框架
  - [Meterpreter](https://www.freecodecamp.org/news/how-to-exploit-the-eternalblue-vulnerability-on-windows/)：Metasploit的進階payload，提供對被入侵機器的遠程控制
  - PowerShell：Windows系統管理和DCOM服務的枚舉

## 漏洞利用範例

- **EternalBlue-DoublePulsar**：
  - 目標：利用SMB服務漏洞（MS17-010）
  - 驗證目標漏洞：`nmap -p 445 --script smb-vuln-ms17-010 <target_ip>` [examcollection.com](https://www.examcollection.com/blog/a-step-by-step-guide-to-windows-hacking-with-eternalblue-doublepulsar-in-metasploit/)

## DCOM橫向移動技術

- **DCOM橫向移動優勢**：
  - 在遠端主機執行的進程是託管COM伺服器的軟體 [mdsec.co.uk](https://www.mdsec.co.uk/2020/09/i-like-to-move-it-windows-lateral-movement-part-2-dcom/)
  - 可避開對遠程服務創建的監控 [cybereason.com](https://www.cybereason.com/blog/dcom-lateral-movement-techniques)

- **DCOM應用範例**：
  - Microsoft管理控制台(mmc.exe)：可通過DCOM生成任意進程 [attack.mitre.org](https://attack.mitre.org/techniques/T1021/003/)
  - 典型進程樹：svchost.exe → mmc.exe → .exe
  - Excel也可通過DCOM執行進程：svchost.exe → excel.exe → .exe [attack.mitre.org](https://attack.mitre.org/techniques/T1021/003/)

# 協定發現

## 明文通訊協定基礎概念

- **Cleartext Protocols**（明文通訊協定）：不使用任何加密方式傳輸資料的協定，使得傳輸中的資訊若被攔截可輕易被讀取。
  - 常見的明文通訊協定包括：Telnet、FTP、LDAP
  - 這些協定的資安風險在於所有資訊（包括使用者名稱和密碼）都以明文傳輸

## 常見的明文通訊協定及其風險

- **Telnet**（遠端登入協定）：用於遠端命令列介面存取其他電腦的協定。
  - 所有內容（包括使用者名稱和密碼）都以明文傳輸
  - 容易遭受中間人（on-path）攻擊
  - 可使用如 Wireshark 等工具輕易截取憑證資訊
  - 歷史案例：2000年代初期，攻擊者經常利用 Telnet 未授權存取網路設備
  - 安全替代方案：**SSH**（Secure Shell，安全殼層協定）

- **FTP**（File Transfer Protocol，檔案傳輸協定）：用於在客戶端和伺服器間傳輸檔案。
  - 傳輸資料和登入憑證皆為明文[myworkdrive.com](https://www.myworkdrive.com/blog/ssh-vs-ftp-vs-sftp/)
  - 在滲透測試中截取 FTP 流量可獲取使用者名稱、密碼及所傳輸的檔案
  - 缺乏內建安全機制，易受封包嗅探、憑證竊取和資料竄改[myworkdrive.com](https://www.myworkdrive.com/blog/ssh-vs-ftp-vs-sftp/)
  - 實際案例：2013年 Target 資料外洩事件，攻擊者利用被盜用的憑證進入 Target 網路，透過 FTP 移動敏感資料
  - 安全替代方案：
    - **FTPS**（FTP Secure，安全檔案傳輸協定）：使用 SSL/TLS 對資料進行加密[criticalpathsecurity.com](https://www.criticalpathsecurity.com/stop-sending-sensitive-data-with-cleartext-protocols/)
    - **SFTP**（SSH File Transfer Protocol，SSH 檔案傳輸協定）：使用 SSH 加密傳輸檔案[arc.cdata.com](https://arc.cdata.com/blog/20191003-secure-ftp-alternatives)

- **LDAP**（Lightweight Directory Access Protocol，輕量型目錄存取協定）：用於存取和管理目錄資訊服務的協定。
  - 未加密時，所有查詢和回應都以明文傳送
  - 透過預設埠口 389 傳輸未加密資料[upguard.com](https://www.upguard.com/blog/ldap-risks)
  - 常用於驗證和授權，若未受保護將導致資安風險
  - 實際案例：2015年美國人事管理辦公室資料外洩，攻擊者利用未加密的 LDAP 流量竊取數百萬聯邦員工的個人資料
  - 安全替代方案：
    - **LDAPS**（LDAP over SSL，SSL 上的 LDAP）：透過埠口 636 提供 SSL 加密保護[upguard.com](https://www.upguard.com/blog/ldap-risks)
    - **StartTLS**：可在同一埠口提供加密和非加密通訊，但須注意可能受降級攻擊威脅[upguard.com](https://www.upguard.com/blog/ldap-risks)

# 遠端存取發現

## 常見遠端存取軟體與協定

- **Remote Desktop Protocol (RDP)（遠端桌面協定）**：Microsoft 開發的協定，允許使用者透過網路連線到其他電腦
  - 攻擊者常通過弱密碼或未修補的漏洞利用 RDP 進行橫向移動
  - 例如 BlueKeep 漏洞 (CVE-2019-0708) 允許攻擊者在易受攻擊的系統上執行任意程式碼
  - 攻擊情境：透過網路釣魚獲得初始存取權後，使用竊取的憑證嘗試 RDP 連接到網路中的其他機器

- **Virtual Network Computing (VNC)（虛擬網路運算）**：使用遠端幀緩衝區 (RFB) 協定的圖形化桌面共享系統
  - 若使用弱密碼或 VNC 伺服器未妥善保護，可能被利用
  - 滲透測試人員可使用 Nmap 等工具掃描網路中的 VNC 伺服器
  - 有些 VNC 實作可能使用「password」作為預設密碼
  - 連接後可控制系統並可能轉向網路中的其他系統，存取文件共享、敏感文檔等

- **Secure Shell (SSH)（安全殼層協定）**：用於在不安全網路上安全連接到遠端系統的協定
  - 透過加密提供安全通道
  - 攻擊者常透過利用糟糕的金鑰管理實務或使用竊取的憑證進行橫向移動
  - SSH 通道可用於創建加密連接，繞過網路安全控制
  - 攻擊情境：使用已獲取的 SSH 金鑰設置 SSH 通道，繞過防火牆及其他安全措施

- **Windows Management Instrumentation (WMI)（Windows 管理規範）**：Microsoft 的一套規範，用於整合 Windows 系統中的裝置和應用程式管理
  - 允許遠端執行命令，可被利用來執行惡意程式
  - 攻擊者可使用 WMI 在遠端系統上執行 PowerShell 腳本以建立持久性或收集更多憑證
  - 攻擊情境：在受攻擊系統上獲得管理存取權後，使用 WMI 遠端執行 PowerShell 腳本，新增具有管理權限的使用者帳號

## WMI 作為攻擊工具的特性

- **WMI Event Subscription（WMI 事件訂閱）**：可作為持久性機制使用 [pentestlab.blog](https://pentestlab.blog/2020/01/21/persistence-wmi-event-subscription/)
  - 需要創建三個類別來儲存有效負載、指定觸發事件，並將這兩個類別關聯起來
  - 不需要特殊工具，可使用 Windows 內建的 wmic 工具或 PowerShell

- **WMI 執行方式**：通過 RPC（遠端程序呼叫）在 TCP 埠 135 和臨時埠上啟動執行 [rapid7.com](https://www.rapid7.com/db/modules/exploit/windows/local/wmi/)
  - 可用於執行 PowerShell 命令，利用當前使用者或提供的憑證

- **攻擊鏈應用範圍**：可用於 MITRE ATT&CK 框架中的多種技術 [redcanary.com](https://redcanary.com/blog/threat-detection/detecting-wmi/)
  - 包括資訊探索、橫向移動、持久性等
  - 是威脅行為者 2024-2025 年最常用的技術之一（ATT&CK 技術 T1047）[detect.fyi](https://detect.fyi/wmi-as-a-cyber-threat-9207e80ca54d?gi=840e4490dcbc)

- **WMI 事件消費者（Event Consumer）**：可作為後門機制 [youtube.com](https://www.youtube.com/watch?v=d3OCKH7dA30)
  - 攻擊者可創建並利用 WMI 事件消費者建立後門
  - Windows 10 中的事件 ID 5861（WMI 活動日誌）是監控 WMI 持久性的重要來源

## 安全建議

- 了解攻擊者如何利用這些協定進行橫向移動對網路防禦至關重要
- 有效的滲透測試不僅需識別漏洞，還需了解如何利用這些漏洞進行橫向移動和提升權限
- 監控系統、網路和身份驗證日誌以識別可能的惡意活動
- 對 WMI 活動特別是遠端執行應保持警惕，這是攻擊者常用的技術

# 印表機發現

## 印表機協議概述

- **Line Printer Daemon (LPD)**（行列式印表機常駐程式）：一種用於將列印任務提交至遠端印表機的網路協議
  - 廣泛用於Unix和類Unix系統
  - 是line printer remote協議套件的一部分
  - 預設配置和管理不當時容易被利用進行橫向移動

- **JetDirect**（噴墨直連）：由惠普（HP）開發的印表機網路連接技術
  - 通常使用SNMP協議和TCP端口9100進行直接列印任務提交
  - 使用**AppSocket**技術，可通過TCP連接傳輸頁面描述語言（如PostScript、PCL）
  - 源自Tektronix為Phaser印表機開發的技術，後被Xerox收購
  - 包含管理介面，如嵌入式Web伺服器（EWS）

## 攻擊手法

- **LPD攻擊**：  
  - 針對弱配置或預設配置進行攻擊
  - 利用無需認證的設置上傳惡意列印任務
  - 透過嵌入惡意腳本或命令在列印伺服器上執行

- **JetDirect攻擊**：
  - 利用預設SNMP社群字串（如"public"）
  - 攻擊未受保護的TCP端口（尤其是9100）
  - 上傳並執行惡意腳本到印表機
  - 利用印表機在網路中的受信任狀態繞過某些安全措施

## 攻擊案例

- **2019年LPD漏洞**：
  - 多款使用LPD的列印機型號被發現使用無需認證的預設設置
  - 攻擊者透過發送含惡意腳本的特製列印任務取得控制
  - 將受感染印表機作為跳板攻擊內網其他系統

- **JetDirect案例**：
  - 攻擊者通過開放的TCP端口9100訪問JetDirect印表機
  - 利用預設SNMP社群字串"public"獲取存取權
  - 在印表機上傳並執行網路掃描腳本
  - 攔截敏感列印資料並將印表機作為部署惡意軟體的起點
  - 由於印表機較少被監控，入侵長時間未被發現

## 防禦措施

- **更改預設SNMP社群字串**，避免使用"public"等公共字串
  - 禁用未使用的SNMP功能（注意：禁用將影響WebJetAdmin通訊）

- **實施強認證機制**保護列印服務
  - 設置印表機密碼，包含至少一個數字和一個特殊字符
  - 使用適當的安全控制和加密存儲密碼

- **定期更新韌體**確保安全漏洞得到修補
  - 設置HP Web Jetadmin等工具管理企業印表機韌體更新

- **監控與列印服務相關的可疑網路活動**
  - 可通過安全命令管理印表機，如：
    - `cold-reset-all 1`：重置印表機為出廠預設值
    - `cold-reset-network 1`：重置網路設定為出廠預設值
    - `ews-config 0`：禁用TCP端口80的嵌入式Web服務

- **限制打印服務暴露範圍**
  - 禁用未使用的網路服務，如telnet
  - 注意：使用某些漏洞利用工具可能會意外啟用未驗證的telnetd服務

## 滲透測試考量

- 企業環境中的網路連接印表機是優質滲透測試目標
- 印表機安全措施通常較弱，監控頻率較低
- 利用印表機作為內網橫向移動的跳板
- 理解LPD和JetDirect協議的工作方式和漏洞對滲透測試至關重要

# 內部網站發現

## 網路架構及目標識別

- **Web 界面管理主控台**（Web Interface Management Consoles）：
  - 指許多網路裝置和服務通過 HTTP/HTTPS 協議公開的管理介面
  - 常見裝置包括路由器、交換機、印表機、IP 攝影機、網路應用等

- **識別潛在目標**：
  - 使用 Nmap 或 Nessus 掃描開放的 80 和 443 埠
  - 識別運行 web 介面的裝置和服務，然後探測其漏洞

## 常見漏洞利用方式

- **弱密碼或預設憑證**（Weak or Default Credentials）：
  - 許多裝置出廠時配有預設的使用者名稱和密碼（如 admin/admin、root/root）
  - 廠商通常在文件中列出這些預設值，使攻擊者容易找到
  - 示例：使用預設密碼登入網路交換機後可修改配置、重新路由流量或禁用安全功能

- **過時軟體**（Outdated Software）：
  - Web 介面通常基於需要定期更新的 Web 伺服器或框架構建
  - 未更新的裝置或服務可能存在已知漏洞
  - 工具如 Nikto 或 OpenVAS 可識別過時軟體
  - 示例：過時的 CMS 可能容易受到 SQL 注入或跨站腳本攻擊

- **會話劫持**（Session Hijacking）：
  - 許多 Web 介面使用 session cookie 進行身分驗證
  - 如果這些 cookie 沒有被正確保護（特別是使用 HTTP 而非 HTTPS），可被攔截
  - 使用 Wireshark 等工具捕獲會話 cookie，冒充已驗證用戶
  - 示例：捕獲 IP 攝影機系統管理介面的 HTTP session cookie，獲取攝影機控制權

- **訪問控制不當**（Poor Access Controls）：
  - 某些頁面或功能可能不需要身份驗證就能訪問
  - 管理操作可能通過直接 URL 訪問
  - Burp Suite 可幫助識別和利用這些問題
  - 示例：未經身份驗證直接訪問印表機管理 URL，修改設置或上傳惡意固件

- **API 漏洞利用**（API Exploitation）：
  - Web 介面可能公開可被利用的 API
  - 檢查 API 端點和參數，識別注入缺陷或身份驗證不當
  - 使用 Postman 或 Burp Suite 工具構建惡意請求

## HTTP 請求走私

- **HTTP 請求走私**（HTTP Request Smuggling）：[portswigger.net](https://portswigger.net/web-security/request-smuggling)
  - 一種 Web 安全漏洞，發生在攻擊者操縱 Web 伺服器處理 HTTP 請求的方式
  - 主要通過前端和後端伺服器對請求頭的不同解釋來實現攻擊
  - 攻擊者可能使伺服器轉發不完整或額外的請求
  - 主要影響 HTTP 1.1，利用 Content-Length 和 Transfer-Encoding 頭部差異 [fastly.com](https://www.fastly.com/learning/security/what-is-http-request-smuggling)
  - 在 HTTP/2 和 HTTP/3 中較難實施
  - 可能導致安全控制繞過、未授權訪問敏感資料，以及直接危害其他應用用戶 [cobalt.io](https://www.cobalt.io/blog/a-pentesters-guide-to-http-request-smuggling)

- **HTTP 請求走私實現原理**：[extrahop.com](https://www.extrahop.com/resources/attacks/http-request-smuggling)
  - 在一個連接中連續發送多個請求，利用前端代理和後端伺服器對請求邊界的不同解釋
  - 特定 IT 優化（如後端伺服器連接重用）可能使系統更易受攻擊
  - 類似於利用重疊分片欺騙防火牆 [sans.org](https://www.sans.org/blog/http-request-smuggling-abusing-reverse-proxies/)

## 防禦與滲透測試建議

- **防禦建議**：
  - 更改預設憑證，使用強密碼
  - 定期更新軟體和固件
  - 使用 HTTPS 而非 HTTP
  - 實施適當的訪問控制
  - 對 API 端點實施嚴格的輸入驗證

- **滲透測試建議**：
  - 掌握此類攻擊技術有助於更有效地保護網路
  - 識別弱憑證、過時軟體、會話漏洞、訪問控制問題和 API 弱點
  - 練習這些技術可提升滲透測試技能和加強網路防護能力

# 原生系統二進制工具

- **LOLBins**（Living Off The Land Binaries，原生系統二進制工具）：內建於操作系統的二進制工具，攻擊者可濫用來執行惡意活動同時規避檢測
  - 這些工具通常預設在作業系統中，所以通常不會被偵測

## 常見的 LOLBins 及其用途

- **netstat**：顯示網路連線、路由表和介面統計資訊的命令列工具
  - 攻擊者用於收集關於活動網路連線和開放埠的信息
  - 幫助識別潛在的橫向移動目標

- **net 命令系列**（net use、net view、net user、net group）：
  - 用於與網路資源互動、管理使用者帳戶和映射網路裝置
  - 例如：攻擊者可使用 net use 連接到其他系統的共享資料夾以傳輸工具或資料

- **cmd.exe**（命令提示字元）：Windows 的命令列介面
  - 提供執行命令和腳本的強大界面
  - 攻擊者經常用它執行批處理腳本、操作檔案和運行其他 LOLBins

- **explorer.exe**（檔案總管）：Windows 圖形化檔案管理器
  - 攻擊者可利用它瀏覽檔案系統和執行檔案
  - 與正常使用者活動混合以避免被檢測

- **ftp.exe**：Windows 命令列 FTP 客戶端
  - 攻擊者用於在遠端伺服器間傳輸檔案
  - 可用於數據外洩或下載額外的惡意負載，同時避開網路型檢測系統

- **mmc.exe**（Microsoft Management Console，微軟管理主控台）：[attack.mitre.org](https://attack.mitre.org/techniques/T1218/014/)
  - 提供管理各種系統元件的圖形界面
  - 攻擊者可濫用它載入行政工具並利用系統管理設定錯誤配置
  - 可被用來代理執行惡意 .msc 檔案

- **rundll32.exe**（執行 DLL 檔案）：[cybereason.com](https://www.cybereason.com/blog/rundll32-the-infamous-proxy-for-executing-malicious-code), [attack.mitre.org](https://attack.mitre.org/techniques/T1218/011/)
  - 允許執行 DLL（動態連結函式庫）中導出的函式
  - 攻擊者可呼叫 DLL 內的函式執行惡意程式碼，常常能繞過應用程式白名單防禦
  - 被歸類為「System Binary Proxy Execution」技術，可繞過防毒、應用控制和數位憑證驗證

- **msbuild.exe**：Visual Studio 中用來建構應用程式的工具
  - 攻擊者可濫用它直接從 XML 專案檔案編譯並執行惡意程式碼
  - 可繞過傳統的防禦機制

- **route**：用於查看和操作 IP 路由表的命令
  - 攻擊者可用它更改網路路由，可能將流量重定向到惡意伺服器
  - 或創造有利於進一步行動的網路條件

- **strings.exe/findstr.exe**：搜尋檔案中文字的命令列工具
  - 攻擊者用來尋找配置檔、日誌和其他文件中的敏感信息
  - 有助於憑證收集和進一步偵察

- **regsvr32.exe**（註冊 COM 元件）：[attack.mitre.org](https://attack.mitre.org/techniques/T1218/010/)
  - 可被用來註冊 COM 物件，建立持續性
  - 這種技術變體通常被稱為「Squiblydoo」，已在針對政府的攻擊活動中被使用
  - 可以繞過防禦機制執行惡意程式碼

## 防禦建議

- 了解 LOLBins 的作用方式和利用方法對於保護網路和執行滲透測試至關重要
- 監控這些原生工具的異常使用模式
- 限制對這些二進制檔案的存取權限，特別是在敏感系統上

# SSHuttle

- **Sshuttle**（SSH 隧道代理）：一種傳輸代理伺服器，允許使用 SSH 創建類似 VPN 的連接，使網路流量能夠通過遠端伺服器路由
  - 俗稱「窮人的 VPN」(poorman's VPN)
  - 適用於滲透測試人員進行橫向移動
  - 僅需要遠端伺服器的普通用戶權限，不需要管理員權限
  - 僅支援 Unix-like 作業系統，原生不支援 Windows

## 基本用法

- **基本語法**：
  ```
  sshuttle -r user@remote_server 0.0.0.0/0
  ```
  - `-r` 選項：指定遠端伺服器位址和用戶名
  - `0.0.0.0/0`：路由所有流量通過遠端伺服器

- **指定子網路路由**：
  ```
  sshuttle -r user@remote_server 192.168.1.0/24
  ```
  - 此命令僅將前往 192.168.1.0/24 子網路的流量通過遠端伺服器路由

## 進階功能

- **DNS 轉發**：使用 `--dns` 選項啟用 DNS 轉發功能
  ```
  sshuttle --dns -r user@remote_server 0.0.0.0/0
  ```
  - 允許解析內部主機名稱
  - 對於訪問使用內部 DNS 名稱的資源非常有用
  - 可防止本地網路攻擊，如 Firesheep 等 [sshuttle.readthedocs.io](https://sshuttle.readthedocs.io/en/latest/usage.html)

- **用於路由器設定**：若要在路由器上執行 sshuttle 並處理來自其他設備的連接
  ```
  sshuttle --listen 0.0.0.0:0 -r user@remote_server 0.0.0.0/0
  ```
  - 需要啟用核心的 IP 轉發功能 [man.archlinux.org](https://man.archlinux.org/man/extra/sshuttle/sshuttle.1.en)

## 滲透測試應用場景

- **環境設定**：當獲取到目標網路中的某台伺服器 SSH 訪問權限後，可使用 sshuttle 路由流量
- **網路掃描**：建立 sshuttle 連接後，可使用 nmap 等工具掃描內部網路
  ```
  nmap -sT -Pn 192.168.1.0/24
  ```
- **內部資源訪問**：可直接訪問內部 Web 應用程式、服務和資源
- **使用內部 DNS 解析**：可解析並訪問如 `intranet.company.local` 等內部域名

## 其他功能

- **自動主機掃描**：使用 `-H` 或 `--auto-hosts` 選項持續掃描遠端主機名並更新 [kali.org](https://www.kali.org/tools/sshuttle/)
- **自動網路檢測**：使用 `-N` 或 `--auto-nets` 選項自動確定要路由的子網路 [kali.org](https://www.kali.org/tools/sshuttle/)
- **排除特定主機**：使用 `-x` 參數排除特定主機，以確保本地機器可以直接與 SSH 伺服器通信 [sshuttle.readthedocs.io](https://sshuttle.readthedocs.io/en/stable/usage.html)

# Covenant

## 基本概念

- **Covenant**：一個開源的命令與控制（C2）框架，使用C#編程語言開發，專為紅隊行動和滲透測試而設計。
  - 建立於.NET Core框架上，可跨平台運行（Windows、Linux、macOS）
  - 允許管理已被入侵系統、遠程執行命令
  - 支援多用戶協作

- **Grunt**：Covenant的代理程式，部署在已入侵的系統上。
  - 作為控制代理，維持對被入侵系統的持續存取權限
  - 可執行遠程命令，收集系統信息

## 主要功能與用途

- **後滲透管理**：在系統被入侵後部署Grunt以維持控制。
  - 可收集系統信息（運行進程、網路連接、用戶帳戶）
  - 執行PowerShell腳本進行安全特性關閉或敏感數據提取

- **持久性維持**：確保即使系統重啟後仍能維持存取權限。
  - 可創建計劃任務使Grunt代理在系統啟動時自動運行

- **憑證獲取**：支持上傳工具並執行，如Mimikatz。
  - 可從內存中提取密碼雜湊和明文密碼
  - 能獲取域管理員帳戶憑證，擴大對網路的存取範圍

- **隱蔽操作**：
  - 加密通信，降低被檢測風險
  - 包含反病毒和端點安全工具檢測迴避功能
  - 可使用SharpSploit庫將惡意代碼注入合法進程

## 實戰案例

- **初始訪問**：
  - 利用錯誤配置的Web應用（如未驗證的檔案上傳目錄）
  - 上傳惡意腳本（如網頁Shell）進行遠程代碼執行（RCE）

- **權限提升**：
  - 利用已知漏洞（如PrintNightmare CVE-2021-34527）提升權限到SYSTEM

- **橫向移動與數據獲取**：
  - 搜索敏感數據，如備份目錄下的SQL數據庫備份文件
  - 利用目錄遍歷漏洞讀取配置文件（如web.config）獲取連接字符串

## 關鍵特性

- **多用戶協作**：支持紅隊成員協同工作
- **跨平台兼容**：可在各主要操作系統上運行
- **加密通信**：增強操作隱蔽性
- **偵測規避**：內建多種規避技術以避開安全工具檢測
