# 雲端攻擊

## 雲端攻擊概述

- **Cloud Attacks**（雲端攻擊）：針對雲端運算環境（如AWS、Azure或GCP）特有漏洞的攻擊
  - 這類漏洞可能導致雲端資源遭受未授權訪問和資料洩露
  - 超過60%的企業使用雲服務，使這些攻擊方法的理解對於攻擊和防禦雲系統都極為重要

## 常見雲端攻擊類型

- **IAM Misconfigurations**（身分與訪問管理錯誤配置）：常見IAM缺陷包括過度授權、不當訪問控制和角色錯誤配置
  - 這些問題可能讓攻擊者提升權限或訪問敏感資訊

- **Resource Misconfigurations**（資源錯誤配置）：錯誤設定的雲端資源如儲存桶、網路存取控制清單和虛擬機器
  - 可能導致資料外洩或未授權訪問

- **Logging Information Exposures**（日誌資訊洩露）：不安全的日誌管理
  - 可能通過日誌洩露敏感的操作或客戶資料

- **Metadata Service Attacks**（元數據服務攻擊）：利用雲服務元數據服務的漏洞
  - 用於在無權限的情況下獲取資料訪問

- **Image and Artifact Tampering**（映像和產出物篡改）：操縱雲端映像和產出物
  - 插入惡意程式碼或利用軟體依賴關係漏洞

- **Supply Chain Attacks**（供應鏈攻擊）：針對雲端中的第三方服務和軟體依賴關係
  - 透過入侵這些元素來影響更廣泛的系統

- **Container Exploits and Attacks**（容器漏洞利用和攻擊）：容器化環境（如Docker、Kubernetes）特有的漏洞
  - 相關工具包括 Trivy, Kube-Hunter, Docker Bench

- **Trust Relationship Abuse**（信任關係濫用）：利用雲端服務和組件間的信任關係
  - 繞過安全措施進行攻擊
  - 例如Golden SAML技術允許偽造雲端應用程式的身分驗證

- **Third-party Integration Exploits**（第三方整合漏洞利用）：由添加第三方服務到雲平台引入的漏洞
  - 包括API和服務鉤子（service hook）漏洞利用

## 雲端安全測試工具與方法

- **Cloud Security Testing**（雲端安全測試）：評估雲基礎設施安全狀態的方法和工具
  - 跨平台工具：ScoutSuite
  - 特定平台工具：Pacu（AWS環境）
  - 雲端滲透測試的目標是確保外部攻擊者無法利用雲平台並獲取敏感數據

- **Conducting Cloud Audits**（執行雲端審計）：實際評估雲配置、識別錯誤配置
  - 協助企業採用最佳安全實踐
  - Rhino Security Labs提供詳細的漏洞報告和複雜攻擊路徑的敘述

## 注意事項

- 雲端安全遵循共同責任模型（Cloud Shared Responsibility Model）：雲服務提供商負責「雲的安全」，而用戶負責「雲中的安全」

# IAM 認證錯誤配置攻擊向量

- **Identity and Access Management (IAM)（身分與存取管理）**：確保適當的個人擁有相應技術資源存取權限的框架和技術
  - 類似數位安全系統，確保只有獲授權人員才能進入特定區域或存取特定資源
  - 控制用戶（員工、承包商等）存取應用程式、資料或系統的許可權限

## 常見的 IAM 認證錯誤配置

- **Overly Permissive Policies（過度寬鬆的權限政策）**：用戶被賦予超出其工作需求的權限
  - 例如：只需要讀取文件的員工卻被給予寫入和執行權限
  - 攻擊者若取得此類用戶認證，可以修改或刪除資料，導致資料洩漏或損失
  - 滲透測試人員會尋找權限超出工作需求的用戶，指出潛在安全漏洞

- **Default Credentials（預設憑證）**：系統預設的使用者名稱和密碼未經修改
  - 常見例子：「admin/admin」或「guest/guest」
  - 相當於將萬能鑰匙放在門墊下，任何人都能找到
  - 滲透測試人員會掃描使用預設認證的系統，並嘗試使用這些已知默認值登入

- **Over-Permissioned IAM Roles（權限過大的IAM角色）**：雲環境中（如AWS或Azure）的角色配置過於寬鬆
  - 若角色被配置為允許對資源執行所有操作，會成為攻擊目標
  - 攻擊者若獲得具完全管理權限的IAM角色，可執行刪除資源、存取敏感數據或啟動新實例等操作
  - 過度寬鬆的IAM角色會提供更大的攻擊面，增加攻擊者成功入侵時的影響範圍

- **Access Keys Mishandling（存取金鑰處理不當）**：數位安全閘門的鑰匙遭到誤用
  - 例如：員工不慎將AWS存取金鑰上傳至GitHub等公共代碼庫
  - 攻擊者可掃描公共存儲庫尋找暴露的金鑰，並用於存取組織的AWS資源
  - 具有存取金鑰的IAM用戶是帳戶安全風險

## 滲透測試方法與工具

- **AWS IAM Access Analyzer**：用於審查權限並識別過度寬鬆的角色

- **TruffleHog**：用於掃描公共存儲庫中的密鑰

- **權限提升攻擊**：
  - 具有iam:PassRole和ec2:RunInstances權限的攻擊者可創建新EC2實例並關聯現有的服務角色
  - 攻擊者可登入實例並從EC2實例元數據中請求關聯的AWS密鑰

- **靜態憑證暴露**：
  - 開發環境中常見硬編碼憑證被提交到源代碼儲存庫，容易被惡意行為者利用

## IAM 安全風險的規模

- AWS、Azure和GCP現在共有超過28,000個IAM權限
  - 大多數雲團隊缺乏適當調整這些權限的能力
  - 70%的IT領導者認為雲安全技能差距是「關鍵問題」
  - 互連身份數量過多，難以手動追蹤誰對什麼有存取權

## 最佳實踐

- 使用Amazon CloudWatch Events和AWS Lambda進行自動化監控
- 定期審查和更新事件應對計劃
- 避免使用靜態憑證，尤其是硬編碼在源代碼中的憑證
- 實施最低權限原則，確保用戶僅獲得其工作所需的必要權限

# 資源錯誤配置攻擊向量

## 主要攻擊向量

- **Resource Misconfiguration**（資源錯誤配置）：系統或資源設定不當導致的安全漏洞
  - 這是滲透測試中的重要攻擊向量
  - 主要包含四大類型：網路分段問題、網路控制問題、存儲桶曝露、服務公開存取

## 詳細分類與說明

- **Network Segmentation**（網路分段）：將網路分割成較小的區段，每個區段有自己的安全控制
  - 類似建築物內有一系列上鎖的門，確保只有授權人員可以進入特定區域
  - 若實施不當，攻擊者可從低安全性區段橫向移動到應被隔離的敏感區段
  - 滲透測試重點：尋找分段不良的網路，特別是敏感系統與低重要性系統在同一區段

- **Network Controls**（網路控制）：管理網路內流量的規則和政策
  - 包括防火牆、存取控制清單（ACLs）、入侵檢測系統（IDSs）
  - 如同交通號誌和標誌規範城市車輛移動
  - 若配置錯誤，可能創造安全漏洞供攻擊者利用
  - 典型問題：防火牆規則過於寬鬆，允許任何流量通過
  - 滲透測試案例：找出允許無限制存取敏感端口或服務的錯誤配置防火牆

- **Exposed Storage Buckets**（暴露的存儲桶）：雲環境中用於存儲資料的容器
  - 類似用於儲存文件的檔案櫃
  - 可配置為私有或公開訪問
  - 若誤配置為公開，互聯網上任何人都能訪問內容
  - 案例：AWS S3 桶中包含敏感客戶資料被暴露，攻擊者可直接通過URL下載資料
  - 滲透測試重點：搜索暴露的存儲桶並嘗試訪問，展示此類錯誤配置的潛在影響

- **Public Access to Services**（服務的公開訪問）：應受限但被配置為公開的服務
  - 可視為建築物內的限制訪問區域（如保險庫或控制室）
  - 若配置為公開訪問，任何人都能無需認證即可訪問
  - 案例：數據庫管理介面暴露於公共互聯網無適當認證
  - 滲透測試重點：識別應受限但可公開訪問的服務，示範攻擊者如何利用取得控制權

## 實際應用案例

- **Elasticsearch 數據庫錯誤配置**
  - 公司的Elasticsearch數據庫被錯誤配置為允許公開訪問
  - 可能包含高度敏感資訊：社會安全號碼（SSNs）、公司未發布財報、高管機密郵件
  - 攻擊者透過發現數據庫公共IP，可直接查詢獲取私密資訊
  - 滲透測試應強調此類錯誤配置如何輕易使敏感數據被存取

- **過於寬鬆的防火牆規則**
  - 公司防火牆規則允許所有入站流量在端口22（SSH默認端口）
  - 攻擊者可掃描開放端口22並嘗試暴力破解SSH憑證
  - 滲透測試可展示風險：成功通過開放端口訪問內部服務器
  - 可能訪問機密項目文件或員工薪資記錄

## 關鍵總結

- 資源錯誤配置是重要攻擊向量：網路分段不良、網路控制不足、存儲桶暴露、服務公開訪問
- 有效的滲透測試需識別這些錯誤配置並證明其潛在影響
- 正確實施：網路適當分段、控制正確實施、存儲桶安全配置、服務僅限授權用戶

## 相關資安框架與方法論

- **OWASP Top 10**（開放式網路應用程式安全專案前十大安全風險）：識別最常見的網路應用程式安全風險
- **OSSTMM**（開放源碼安全測試方法論手冊）：提供操作安全測試和度量的綜合框架
- **PTES**（滲透測試執行標準）：定義滲透測試過程的各個階段

## AWS特定安全配置

- **Security Groups**（安全群組）：為EC2實例分配入站和出站規則
  - 指定來源、目標、端口範圍和協議
  - 每個網路介面最多可分配五個安全群組
  - 錯誤配置可能使私有雲實例暴露於公共互聯網、暴露不必要端口、使用過於寬泛的IP範圍

- **S3 Bucket安全**：
  - 公開訪問設置或訪問控制過於寬鬆導致敏感數據曝光
  - 不安全的直接對象引用（IDOR）：若S3桶URL或對象引用可預測，攻擊者可能直接訪問或操作對象
  - 數據暴露：配置錯誤或可公開訪問的桶會導致敏感數據泄露（如PII個人身份識別信息）
  - 桶枚舉：攻擊者可通過暴力或其他方式識別有效桶名，可能導致非授權訪問

- **網路訪問控制**：
  - Security Groups和Network Access Control Lists（NACLs）的錯誤配置可能導致未過濾的入站和出站網路流量
  - 過於嚴格的配置也可能阻擋合法用戶或資源存取必要資源
  - 安全評估應確保這些網路控制實施最小權限原則

# 安全日誌記錄與監控

## 日誌記錄的基本概念

- **Logging**（日誌記錄）：系統或網路中記錄詳細活動的機制，類似於詳細的日記
  - 記錄內容包括用戶活動、系統事件、錯誤和其他重要操作
  - 適當配置的日誌對監控和事件回應至關重要

## 日誌記錄可能暴露的敏感資訊類型

- **Sensitive Information in Logs**（日誌中的敏感資訊）：不當配置的日誌可能包含機密資料
  - 常見敏感資訊包括：用戶名、密碼、API金鑰、會話令牌
  - 個人識別資訊(PII)：電子郵件地址、電話號碼等
  - 若日誌未妥善保護，任何人都可能取得並利用這些資訊

## 日誌儲存及其安全風險

- **Log Storage**（日誌儲存）：日誌資料的存放位置及其安全性
  - 儲存位置包括：本地系統、集中式日誌伺服器或雲端儲存
  - 安全風險：若儲存位置未適當保護，可能導致資訊暴露
  - 例如：若日誌檔案存放在網頁伺服器的公開目錄，攻擊者可下載並分析內容

## 日誌傳輸安全問題

- **Log Transmission**（日誌傳輸）：日誌傳送過程中的安全問題
  - 日誌通常被傳送到集中式日誌伺服器或 SIEM 系統
  - 若傳輸未加密，可能被攻擊者使用如 Wireshark 等工具攔截
  - 安全風險類似於寄送敏感文件時不使用信封，任何人都可閱讀內容

## 日誌保留政策相關風險

- **Log Retention Policies**（日誌保留政策）：規定日誌應保留多久的規則
  - 日誌需保留一定時間以符合稽核和合規要求
  - 保留過久或管理不當可能導致資訊暴露
  - 舊日誌可能仍包含不再需要但可被利用的敏感資訊
  - 例如：因法規要求（如聯邦政府處理的資料）保留用戶會話的詳細日誌數年

## 過度日誌記錄的危害

- **Excessive Logging**（過度日誌記錄）：記錄過多不必要資訊的問題
  - 雖然獲取足夠的資訊用於故障排除和監控很重要，但記錄過多可能導致敏感資料被不必要地記錄
  - 例如：記錄完整的 HTTP 請求標頭可能包含會話令牌或 API 金鑰等敏感資訊
  - 滲透測試中應分析日誌配置，識別過度日誌記錄可能暴露敏感資料的情況

## 安全日誌記錄最佳實踐

- **Security Logging Best Practices**（安全日誌記錄最佳實踐）：防止日誌資訊暴露的策略
  - 不記錄敏感資訊，如密碼、會話 ID、信用卡或社會安全號碼
  - 保護日誌完整性，防止攻擊者篡改日誌
  - 集中化日誌收集以提高跨系統可見性
  - 設置實時監控以快速檢測威脅
  - 應用訪問控制和備份以防止日誌篡改或丟失
  - 定期測試日誌記錄工作流程，確保警報和資料正常運作

## 常見日誌安全失誤

- **Common Security Logging Failures**（常見日誌安全失誤）：組織常犯的日誌安全錯誤
  - 未記錄重要安全事件（如登入失敗、未授權訪問敏感數據）
  - 未監控日誌中的可疑活動（如重複失敗的登入嘗試、異常流量模式）
  - 日誌保存時間不足，難以調查過去發生的安全事件
  - 缺乏審查和回應安全日誌的流程，導致安全事件未被檢測和處理
  - 不安全的日誌記錄和監控系統，使攻擊者能訪問或修改日誌，難以追蹤其活動

## 日誌管理的關鍵元素

- **Log Management Components**（日誌管理組件）：有效日誌管理的主要部分
  - 日誌收集：包括日誌豐富化（解析、轉換和過濾日誌）
  - 日誌管理：維護分片和索引、保持資料保留策略以提高性能、實施訪問控制（因為日誌包含敏感資訊）
  - 日誌監控/分析：視覺化、警報、報告

# EC2 IAM 角色和元數據服務的安全性

- **Instance Metadata Service（IMDS）**（執行個體元數據服務）：AWS EC2 執行個體用來獲取元數據的介面，包含執行個體識別資訊、網路設定及 IAM 憑證等。
   - 可透過 `http://169.254.169.254/latest/meta-data/` 從EC2執行個體內部存取
   - 也可以通過IPv6 `http://[fd00:ec2::254]/latest/meta-data/`（僅限於 Nitro EC2執行個體）

- **EC2 元數據**（EC2 Metadata）：提供有關雲端執行個體的資訊，例如主機名稱、事件、安全群組等。
   - 元數據是用來描述屬性相關資料

- **IAM 角色 STS 憑證**（IAM Role STS Credentials）：透過 AWS Security Token Service 生成的臨時安全憑證。
   - 當 EC2 執行個體啟動時，會「擔任」(assume)附加的 IAM 角色並獲取臨時安全憑證
   - 這些臨時憑證可從元數據服務中檢索

- **Server-Side Request Forgery（SSRF）**（伺服器端請求偽造）：攻擊者利用伺服器與其可存取資源間的信任關係進行攻擊。
   - 當網頁應用程式在未驗證使用者提供的 URL 的情況下獲取遠端資源時，就會出現此漏洞
   - 允許攻擊者誘導應用程式發送精心設計的請求到非預期目標
   - 這是攻擊元數據服務的常見入口點

- **元數據服務攻擊**（Metadata Service Attack）：透過 SSRF 漏洞取得 EC2 元數據服務中的臨時憑證。
   - 攻擊路徑: 找到有 SSRF 漏洞的應用程式 → 將請求指向 `http://169.254.169.254/latest/meta-data/iam/security-credentials/[role-name]` → 獲取臨時憑證
   - 知名案例：2019 年 Capital One 的資料外洩事件與 AWS 執行個體元數據服務的弱點有關

- **IMDSv1 與 IMDSv2**（執行個體元數據服務第一版與第二版）：AWS 提供的不同版本元數據服務。
   - IMDSv1 較易受到 SSRF 攻擊
   - IMDSv2 增加了安全性功能，需要透過 PUT 請求建立工作階段權杖，再用此權杖存取元數據

- **緩解措施**（Mitigation）：降低元數據服務相關風險的方法。
   - 使用 IMDSv2 而非 IMDSv1
   - 謹慎設計信任政策，盡可能具體明確
   - 避免在應用程式中直接使用未經驗證的 URL

# 映像與產出物竄改

## 基本概念

- **Image and Artifact Tampering**（映像與產出物竄改）：操縱虛擬機映像、容器映像和軟體產出物，以引入漏洞或惡意程式碼的攻擊方式。
  - 這是滲透測試中的重要攻擊向量

## 雲端環境中的映像與產出物

- **Images**（映像）：建立虛擬機或容器的藍圖
  - 如同建造房屋的設計圖
  - 包含操作系統、應用程式和配置

- **Artifacts**（產出物）：建構和部署應用程式的軟體元件和依賴項
  - 如同房屋的建築材料（磚塊、窗戶等）
  - 通常是 CI 過程中到部署前的所有軟體產出

## 常見攻擊目標及攻擊手法

### 1. 虛擬機映像 (VM Images)

- **攻擊方式**：
  - 插入惡意程式碼或後門
  - 安裝 rootkit 獲取持續性存取權限
  - 在傳輸或存儲過程中竄改映像

- **案例情境**：
  - 組織使用共享儲存庫存放 VM 映像
  - 攻擊者替換合法映像為竄改過的版本
  - 組織部署這些映像時，無意中引入漏洞

- **防護建議**：
  - 驗證映像的來源和完整性
  - 確保映像儲存庫得到良好保護

### 2. 容器映像 (Container Images)

- **容器特性**：輕量級、可移植、自給自足的環境
  - 儲存在如 DockerHub 等註冊表中

- **攻擊方式**：
  - 在容器映像中插入漏洞或惡意軟體
  - 加入加密貨幣挖礦程式

- **真實案例**：2019 年 DockerHub 事件
  - 攻擊者在官方 Alpine Linux 映像中注入隱藏惡意軟體
  - 許多開發人員從公共註冊表下載了受感染映像
  - 部署後，惡意軟體啟動，可能允許攻擊者執行任意程式碼或竊取敏感資料

### 3. 軟體產出物 (Software Artifacts)

- **定義**：函式庫、套件和模組等應用程式必要組件
  - 存儲在如 npm、PyPI、Maven 等儲存庫中

- **攻擊方式**：
  - 在熱門函式庫中注入惡意程式碼
  - 開發者在專案中包含這些函式庫時，惡意程式碼被執行

- **真實案例**：2018 年 event-stream 事件
  - 攻擊者說服原始維護者交出控制權
  - 新增含惡意程式碼的依賴項，目標是竊取特定應用程式的比特幣錢包
  - 開發者使用受感染版本的函式庫，導致敏感資料可能被竊取

## 防禦策略

- **映像和產出物的完整性檢查**：
  - 驗證來源和完整性
  - 確保使用可信的儲存庫

- **容器安全**：
  - 使用簽署的容器映像
  - 定期更新和掃描漏洞

- **依賴項管理**：
  - 使用工具如 npm audit、yarn audit 識別已知漏洞
  - 實施嚴格的依賴管理政策
  - 定期更新函式庫
  - 使用工具監控第三方元件的可疑變更或漏洞

- **滲透測試重點**：
  - 檢查來源和完整性
  - 展示竄改如何引入漏洞
  - 確保有穩健的安全措施

## 供應鏈攻擊案例

- **Eslint-config-prettier 套件劫持**：
  - 攻擊者假冒 npm 支援團隊進行釣魚攻擊，竊取維護者憑證
  - 發布惡意版本的套件，在 postinstall 過程中靜默安裝 Windows 木馬
  - 影響使用 eslint、Prettier 或相關 npm 工具的開發團隊

- **event-stream 事件**：
  - 攻擊者在 version 3.3.6 中添加了惡意套件 flatmap-stream (v0.1.1)
  - 惡意程式碼專門針對特定公司的開發環境
  - 目標是竊取 Copay 應用程式中的加密貨幣

## 建議的安全措施

- 停止使用受感染版本
- 更新至最新安全套件
- 為 npm 帳戶啟用雙因素驗證 (2FA)
- 審核 npm 記錄和系統日誌
- 使用 npm audit、GitHub Dependabot 等安全工具
- 審查所有開發工具，即使是信任的工具

# 供應鏈攻擊

- **Supply Chain Attack**（供應鏈攻擊）：通過入侵受信任的供應商或服務提供商，來獲取目標組織系統與資料的攻擊方式。
  - 類似製造業供應鏈中的原材料污染會影響最終產品，數位世界中受信任提供商的妥協會對依賴它們的組織造成安全風險

## 供應鏈攻擊的主要類型

- **Software Updates**（軟體更新）：針對第三方軟體更新機制的攻擊。
  - 攻擊者入侵更新機制，將惡意程式碼注入更新，再分發給所有使用者
  - 案例：SolarWinds 攻擊，攻擊者入侵其更新伺服器，向數千組織分發惡意更新
  - 滲透測試重點：檢查重要應用程式的軟體更新流程，確保使用強認證和完整性檢查

- **Third-party Libraries and Dependencies**（第三方函式庫與相依性）：
  - 現代應用程式常依賴開源函式庫和套件，攻擊者可通過入侵這些函式庫植入漏洞
  - 案例：攻擊者將惡意程式碼注入廣泛使用的 NPM 套件
  - 滲透測試重點：審核關鍵應用程式的相依性，確保來源可信且定期更新以修補已知漏洞

- **Hardware Supply Chain Attacks**（硬體供應鏈攻擊）：
  - 攻擊者可在製造或運輸過程中入侵硬體元件
  - 案例：在網路設備上安裝惡意韌體，為攻擊者提供網路後門
  - 滲透測試重點：檢查採購流程並驗證組織內使用的硬體元件完整性

- **Cloud Service and Third-party Providers**（雲端服務和第三方提供商）：
  - 若雲端服務提供商遭入侵，攻擊者可訪問所有客戶的資料和系統
  - 案例：攻擊者利用雲端儲存服務的漏洞訪問多個組織的敏感資料
  - 滲透測試重點：評估公司如何驗證第三方提供商的安全實踐，包括加密標準、訪問控制和資料保留政策

- **Malicious Insiders**（惡意內部人員）：
  - 案例：2020年，一位前思科員工惡意刪除數百個虛擬機器，影響數千個 WebEx 帳戶
  - 滲透測試重點：審查第三方提供商的訪問控制和監控實踐，確保實施嚴格的基於角色的存取控制、定期記錄活動和實時異常檢測

## 供應鏈攻擊的防護建議

- 謹慎審查第三方供應商的安全措施和慣例
- 實施強認證和完整性檢查機制
- 定期更新和修補所有第三方元件
- 監控異常活動並建立有效的事件響應計劃

企業需要演進其安全策略，以防範隱藏的後門和篡改風險，因為威脅行為者持續針對供應鏈進行攻擊。

安全性應獨立於基礎設施，因為雲端服務提供商的產品路線圖、收入模式或策略重點可能導致風險被忽略。

需要評估負責企業關鍵 IT 平台或處理敏感資料的服務提供商，確保他們適當地保護這些平台和資料。

# 容器漏洞利用與攻擊

## 容器安全基礎

- **Workload Runtime Attacks**（工作負載執行時攻擊）：針對容器內運行的應用程式進行的攻擊
  - 攻擊者利用容器化應用程式的漏洞執行惡意程式碼
  - 例如：利用 SQL 注入漏洞存取資料庫、竊取信用卡號或修改應用程式
  - 滲透測試方法：動態分析和模糊測試（fuzz testing）

- **Container Escapes**（容器逃逸）：攻擊者從容器環境中突破限制，存取主機系統或其他容器
  - 類比為囚犯逃離牢房並獲得整個監獄的存取權
  - 原因：容器軟體漏洞或錯誤配置
  - 常見情境：容器擁有過多權限，攻擊者利用 Docker 或 Kubernetes 漏洞逃逸
  - 滲透測試重點：識別可能允許逃逸的配置，如以 root 身份運行的容器或過時的容器軟體

## 安全工具

- **Trivy**：用於檢測 Docker 與 Kubernetes 安全性的工具
  - 功能：掃描 Docker 鏡像和 Kubernetes 集群的漏洞
  - 案例：可發現 Docker 鏡像中的高危漏洞
  - 目的：增強 Docker 鏡像與 Kubernetes 環境的安全性

- **Kube-Hunter**：用於檢測 Kubernetes 集群安全問題的工具
  - 功能：掃描集群尋找錯誤配置、開放端口和易受攻擊的服務
  - 案例：可發現暴露的 etcd 資料庫或配置錯誤的 Kubernetes 儀表板
  - 目的：增強 Kubernetes 環境的安全性

- **Docker Bench**：檢查 Docker 設置與安全最佳實踐的符合程度
  - 功能：像清單一樣確保 Docker 環境的安全性
  - 檢測問題：以 root 身份運行的容器、不必要的開放端口、暴露於網際網路的 Docker 守護進程
  - 風險檢測：識別例如使用 `--privileged` 標誌運行的容器，這可能導致容器逃逸和主機被接管

## 安全原則

- **最小權限原則**（Principle of Least Privilege）：容器只應擁有完成工作所需的最小權限
  - 以 root 身份或過多權限運行容器會增加攻擊者造成損害的可能性
  - 滲透測試人員應強調以最小必要權限運行容器的重要性

## 安全建議

- **安全配置**：
  - 設置 `runAsNonRoot: true` 防止容器以 root 用戶運行
  - 設置 `readOnlyRootFilesystem: true` 阻止未授權的文件修改
  - 對於 Docker 運行時，強制使用用戶命名空間並刪除不必要的權限 `drop: ["ALL"]`
  - 設置 `allowPrivilegeEscalation: false` 防止容器獲取更高權限

- **基礎設施保護**：
  - kubelet API 必須適當鎖定，它是運行在每個 Kubernetes 集群節點上的進程
  - 將節點放在內部網路上作為防禦層

- **常見風險**：
  - 弱存取控制 - Kubernetes 預設不限制使用者存取
  - 易受攻擊的容器映像 - 未經掃描和加固的映像可能包含已知漏洞

- **整體安全**：
  - Kubernetes 安全不僅關乎單一層面，而是保護整個容器生態系統
  - 從在容器中運行的工作負載到協調其操作的集群，每一層都需要保護

## 有效滲透測試的關鍵

- 檢查容器配置
- 展示不良配置如何被利用
- 提出安全建議以防止攻擊

# 信任關係濫用

- **Trust Relationships**（信任關係）：不同系統、服務或網域之間建立的協議，允許它們相互驗證並安全地通信。
  - 類似於合作夥伴關係，其中一個實體信任另一個實體代表其行事
  - 範例包括兩個 Active Directory 網域之間的信任關係、雲服務之間的聯合身份驗證、不同應用程式間的信任關係

- **Trust Relationship Abuse**（信任關係濫用）：當攻擊者利用信任關係中的錯誤配置或漏洞進行橫向移動和未授權存取。
  - 如果攻擊者侵入網域 A，可以利用信任關係存取網域 B 的資源而無需重新驗證

## 常見的信任關係濫用方式

- **Kerberos Delegation**（Kerberos 委派）：允許服務模擬使用者並代表使用者訪問資源。
  - 若配置不當，攻擊者可濫用這一特性來提升權限
  - **Unconstrained Delegation**（不受約束的委派）：允許服務可以模擬任何使用者存取網路資源
  - 建議實施 **Constrained Delegation**（約束委派）來限制模擬範圍

- **Federated Identity Abuse**（聯合身分濫用）：當組織使用聯合身份管理允許使用者用現有憑證訪問其他組織資源時。
  - 若攻擊者入侵身份驗證提供者，可偽造驗證令牌獲得未授權存取
  - 例如：攻擊者入侵 Azure AD 租戶後，可建立惡意令牌訪問通過聯合身份設置的 AWS 資源

- **Application Permissions**（應用程式權限）：應用程式使用 OAuth 等協議與其他服務整合時。
  - 若權限範圍過廣，攻擊者可濫用存取不應有權訪問的數據或服務
  - 例如：若應用程式被授予完整訪問權限而非唯讀權限，攻擊者可竊取或更改存儲的數據

- **Inter-Domain Trust Exploitation**（跨網域信任利用）：
  - 在具有多個 Active Directory 樹系的環境中，可建立信任關係允許一個樹系的使用者存取另一樹系的資源
  - 若未正確配置，攻擊者可利用這些信任關係在樹系之間橫向移動
  - **External Trust**（外部信任）：存在於不同樹系中的網域之間，允許一個網域的使用者存取另一個網域的資源

- **SPN Manipulation**（SPN 操作）：
  - **Service Principal Name (SPN)**（服務主體名稱）是 Active Directory 環境中服務的唯一標識符
  - 如果攻擊者可以註冊或操作 SPN，可以利用信任關係獲取未授權訪問
  - **Kerberoasting Attack**（Kerberos 攻擊）：攻擊者請求服務票證，然後嘗試離線破解票證以獲取帳戶密碼
  - 每個網域或樹系信任在組織中都由存儲在其網域系統容器中的 **Trusted Domain Object (TDO)**（信任網域物件）表示

## 防禦措施

- **SID Filtering**（SID 過濾）：
  - 默認情況下，對所有樹內信任關係禁用 SID 過濾
  - 可以通過將信任標記為 `QuarantinedWithinForest` 在樹內信任上配置 SID 過濾
  - 在這種配置中，定義信任的 TDO 物件的 `trustAttributes` 屬性會設置 `TRUST_ATTRIBUTE_QUARANTINED_DOMAIN` 位

- **強化密碼管理**：確保服務帳戶使用強密碼，避免 Kerberoasting 攻擊成功
- **限制應用程式權限**：實施最小權限原則，限制應用程式只能訪問所需資源
- **監控跨域訪問**：監控和警報可疑的跨域訪問行為
- **實施約束委派**：使用約束委派而非不受約束的委派，限制服務模擬範圍

# 第三方整合漏洞利用

## 基本概念

- **Third-party Integration Exploits**（第三方整合漏洞）：指透過不同系統和服務間的連接橋樑（整合）進行的攻擊行為
  - 第三方整合如同連接基礎設施不同部分的橋樑，允許資料在應用程式、服務和外部供應商之間流動
  - 若未妥善保護，攻擊者可利用這些整合路徑取得系統控制權

## 主要風險類型

- **API Vulnerabilities**（API 漏洞）：應用程式介面的安全問題
  - API 是允許不同軟體應用程式互相通訊的介面，可視為系統間傳遞請求和回應的信使
  - 若 API 未適當實施認證機制（如缺少 API 金鑰驗證），攻擊者可直接發送請求獲取資料或進行未授權操作
  - 案例：2017年 Verizon 的客戶服務應用程式中的不安全 API 端點，讓駭客無須認證即可取得數百萬客戶資料

- **Third-party Libraries and Components**（第三方函式庫和元件）：外部程式碼引入的風險
  - 許多應用程式依賴外部函式庫快速增加功能，但這些函式庫的漏洞可成為攻擊者的入口點
  - 案例：2018年 Equifax 資料外洩事件，源於未修補 Apache Struts 函式庫中的漏洞，導致 1.47億人的敏感資訊洩露

- **Webhooks Security Issues**（Webhook 安全問題）：
  - Webhooks 用於在應用程式間傳送即時資料，如 GitHub 用 webhook 通知其他服務關於推送提交、拉取請求或問題的事件
  - 若 webhook 端點未妥善保護，攻擊者可發送惡意負載操控接收應用程式
  - 可能面臨的攻擊類型：
    - **Replay Attacks**（重放攻擊）：惡意行為者攔截合法請求並重複發送，可能導致接收方重複處理同一請求
    - **Spoofing**（欺騙攻擊）：攻擊者冒充合法來源發送虛假請求

- **Data Leakage**（資料外洩）：透過第三方整合洩露敏感資訊的風險
  - 與第三方服務共享的資料必須充分保護，否則可能導致重大安全事件
  - 若整合未使用強加密和訪問控制，敏感資料可能被未授權方存取
  - 例如：醫療服務提供商與預約排程第三方服務整合時，若 API 未使用 HTTPS，資料可能被攔截

## 安全防護措施

- **API Security**（API 安全）：
  - 實施強力認證和授權控制
  - 要求附加 API 金鑰進行請求驗證
  - 限制 API 的存取權限

- **Third-party Library Security**（第三方函式庫安全）：
  - 確保第三方函式庫保持最新狀態
  - 定期檢查並修補已知漏洞
  - 實施供應鏈安全措施

- **Webhook Protection**（Webhook 保護）：
  - 實施強驗證機制，如 HMAC 簽名與預共享金鑰
  - 提供者建立負載、生成可預測的簽名（雜湊），並將兩者一起發送
  - 應用程式從接收到的負載生成自己的 HMAC，並驗證簽名是否匹配
  - 使用僅 HTTPS 傳輸，保護資料傳輸過程中的安全

- **Data Protection**（資料保護）：
  - 使用加密方法如 HTTPS 保護資料傳輸
  - 實施適當的存取控制，如基於令牌（token）的驗證
  - 限制共享的敏感資訊範圍

# 雲端安全工具

## 跨平台雲端安全工具

- **ScoutSuite**（跨平台雲端安全審計工具）：一種支援多雲端供應商的安全審計工具
  - 支援 AWS、Azure 和 Google Cloud
  - 掃描雲端基礎架構並提供綜合報告
  - 能識別安全風險和錯誤配置
  - 案例：識別 AWS 中過於寬鬆的 IAM 角色、Azure 中配置錯誤的網路安全群組、公開可存取的 Azure 儲存帳戶

- **Pacu**（AWS 漏洞利用框架）：專為測試 AWS 環境安全性而設計的開源框架
  - 提供模擬真實世界攻擊的各種行動
  - 包含權限提升、資料利用和橫向移動模組
  - 案例：測試允許權限提升的弱 IAM 政策，展示攻擊者如何獲取 AWS 環境的管理存取權

- **Prowler**（AWS 安全評估工具）：基於 CIS AWS 基礎基準進行安全檢查的工具
  - 涵蓋身份和存取管理、日誌記錄、監控和網路等領域
  - 執行一系列檢查以識別潛在安全漏洞
  - 案例：檢測 IAM 用戶是否未啟用多因素認證（MFA）、CloudTrail 日誌是否配置不當

## 雲端原生供應商工具

- **AWS 工具**：
  - **AWS Trusted Advisor**：分析 AWS 環境並提供即時建議
    - 改善安全性、降低成本、優化性能
    - 提供啟用 S3 儲存桶加密或提高 EC2 實例安全性的建議
  - **AWS Config**：追踪 AWS 資源變更並根據預定義的安全規則評估
    - 確保安全群組不允許不受限制的入站訪問
    - 幫助維護安全的 AWS 環境並確保符合安全政策

- **Azure 工具**：
  - **Azure Security Center**：統一安全管理系統
    - 持續監控 Azure 資源並提供改進安全性的建議
    - 提供潛在安全問題的警報（未修補的虛擬機器、不安全的網路配置）
  - **Azure Policy**：強制執行組織標準並大規模評估合規性
    - 確保資源正確標記或儲存帳戶啟用加密

- **Google Cloud 工具**：
  - **Google Cloud Security Command Center (SCC)**：集中式儀表板
    - 管理和監控 Google Cloud 資源的安全
    - 提供對安全威脅和錯誤配置的可見性
  - **Forseti Security**：開源工具包
    - 自動化安全和合規性檢查
    - 檢測政策違規，如過於寬鬆的 IAM 角色或暴露的雲儲存桶

## 安全群組與網路安全最佳實踐

- **Security Groups**（安全群組）：AWS 提供的保護實例的工具之一
  - 配置需符合特定安全需求
  - 針對不同用途配置不同規則，如 Web 服務器需允許 HTTP/HTTPS 入站訪問

- **不受限制的入站訪問**（Unrestricted Inbound Access）：安全群組配置中的高風險問題
  - 允許來自任何來源的流量進入特定端口
  - 應限制入站流量僅來自必要的來源 IP 或安全群組

- **VPC 內部流量安全考量**：
  - 使用安全群組引用時需注意流量路徑
  - 在 VPC 內部引用安全群組 ID 時，流量保持在 VPC 內部
  - 使用公共 IP 地址時流量會離開 VPC 並通過互聯網，失去安全群組關聯

## 滲透測試與雲端安全

- **有效的滲透測試**（Effective Pentesting）：利用多種工具評估和改善雲端環境的安全態勢
  - 識別並修復安全風險
  - 確保符合最佳實踐
  - 保護雲端基礎設施免受潛在攻擊
  - 幫助組織建立更安全和更具彈性的雲端基礎設施